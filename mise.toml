experimental_monorepo_root = true

[tools]
go = "latest"
uv = "0.9.26"
cargo-binstall = "1.16.6"
"cargo:cargo-deny" = "0.19.0"
"cargo:cargo-insta" = "1.46.0"
"cargo:cargo-nextest" = "0.9.120"
"cargo:maturin" = "1.11.5"
ruff = "0.14.13"
ty = "0.0.10"
"cargo:cargo-zigbuild" = "0.20.1"
zig = "0.15.2"

[env]
_.path = './bin'
_.file = [".env"]
_.python.venv = ".venv"

[settings]
lockfile = true
experimental = true

# Go integration tests
[tasks.test-integration]
description = "Run Go integration tests with optional filter"
dir = "integration-tests"
run = """
#!/usr/bin/env bash
if [ -n "$1" ]; then
  go test -v -run "TestIntegration/$1" -timeout 10m
else
  go test -v -timeout 10m
fi
"""

# Rust build tasks
[tasks."build:rust"]
description = "Build Rust crates (excludes coglet-python, use build:coglet for that)"
run = "cargo build --manifest-path crates/Cargo.toml"

[tasks."build:rust:release"]
description = "Build Rust crates release (excludes coglet-python)"
run = "cargo build --manifest-path crates/Cargo.toml --release"

[tasks."build:coglet"]
description = "Build coglet Python wheel (development, requires maturin)"
run = "cd crates/coglet-python && maturin develop"

[tasks."build:coglet:wheel"]
description = "Build coglet Python wheel for development (native platform only)"
run = "maturin build --release --out dist --manifest-path crates/coglet-python/Cargo.toml"

[tasks."build:coglet:wheel:linux"]
description = "Build coglet Python wheel for Linux x86_64 (uses zig for cross-compilation)"
run = "maturin build --release --out dist --manifest-path crates/coglet-python/Cargo.toml --target x86_64-unknown-linux-gnu --zig"

[tasks."build:coglet:wheel:all"]
description = "Build coglet Python wheels for all platforms (Linux x86_64 + macOS)"
run = """
maturin build --release --out dist --manifest-path crates/coglet-python/Cargo.toml --target x86_64-unknown-linux-gnu --zig
maturin build --release --out dist --manifest-path crates/coglet-python/Cargo.toml
"""

# To build aarch64-linux, first run: rustup target add aarch64-unknown-linux-gnu
[tasks."build:coglet:wheel:all-arch"]
description = "Build coglet wheels for all platforms including aarch64-linux (requires rustup target)"
run = """
maturin build --release --out dist --manifest-path crates/coglet-python/Cargo.toml --target x86_64-unknown-linux-gnu --zig
maturin build --release --out dist --manifest-path crates/coglet-python/Cargo.toml --target aarch64-unknown-linux-gnu --zig
maturin build --release --out dist --manifest-path crates/coglet-python/Cargo.toml
"""

# Rust test tasks
[tasks."test:rust"]
description = "Run Rust tests with nextest (excludes coglet-python)"
run = "cargo nextest run --manifest-path crates/Cargo.toml --workspace --exclude coglet-python --no-tests=pass"

[tasks."test:coglet-python"]
description = "Run coglet-python Python tests (builds coglet first)"
depends = ["build:coglet"]
dir = "crates/coglet-python"
run = """
#!/usr/bin/env bash
set -e
uv pip install -e . -e ../../cog-dataclass pytest requests
source ../../.venv/bin/activate
python -m pytest tests/ -v
"""

# Rust formatting and linting
[tasks."fmt:rust"]
description = "Format Rust code"
run = "cargo fmt --manifest-path crates/Cargo.toml --all"

[tasks."fmt:rust:check"]
description = "Check Rust formatting"
run = "cargo fmt --manifest-path crates/Cargo.toml --all -- --check"

[tasks.clippy]
description = "Run clippy lints on all crates"
run = "cargo clippy --manifest-path crates/Cargo.toml --workspace -- -D warnings"

[tasks.deny]
description = "Check licenses and advisories with cargo-deny"
run = "cargo deny --manifest-path crates/Cargo.toml check"

# Stub generation for coglet-python
[tasks."stubs:generate"]
description = "Generate type stubs for coglet-python (requires build:coglet first)"
depends = ["build:coglet"]
run = "python crates/coglet-python/scripts/generate_stubs.py -o crates/coglet-python/coglet.pyi"

[tasks."stubs:check"]
description = "Check that coglet-python stubs are up to date"
depends = ["build:coglet"]
run = "python crates/coglet-python/scripts/generate_stubs.py --check"

[tasks."stubs:typecheck"]
description = "Type-check coglet stubs with ty"
run = "ty check crates/coglet-python/coglet.pyi"

# CI-oriented tasks
[tasks."ci:rust"]
description = "Run all Rust CI checks (fmt, clippy, test)"
run = """
#!/usr/bin/env bash
set -e
echo "==> Checking Rust formatting..."
cargo fmt --manifest-path crates/Cargo.toml --all -- --check
echo "==> Running clippy..."
cargo clippy --manifest-path crates/Cargo.toml --workspace -- -D warnings
echo "==> Running tests (excluding coglet-python which requires Python)..."
cargo nextest run --manifest-path crates/Cargo.toml --workspace --exclude coglet-python --no-tests=pass
echo "==> All Rust CI checks passed!"
"""

[tasks."ci:coglet"]
description = "Run all coglet CI checks (build, stubs, typecheck)"
depends = ["build:coglet"]
run = """
#!/usr/bin/env bash
set -e
echo "==> Checking stubs are up to date..."
python crates/coglet-python/scripts/generate_stubs.py --check
echo "==> Type-checking stubs..."
ty check crates/coglet-python/coglet.pyi
echo "==> All coglet CI checks passed!"
"""
