{"id":"cog-0gn","title":"Remove cog-runtime directory and nested .git","description":"After all code is moved and tests pass:\n- Remove cog-runtime/ directory\n- Remove the nested .git/ that was copied from the original repo\n- Update .gitignore if needed\n\nAdd a note in commit message referencing the original repo for history: https://github.com/replicate/cog-runtime\n\nDepends on: cog-f3a, cog-kx1 (all tests passing)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:13:26.052728-07:00","updated_at":"2025-12-15T16:16:36.874953-07:00","closed_at":"2025-12-15T16:16:36.874953-07:00","dependencies":[{"issue_id":"cog-0gn","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:13:26.053259-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-0j4","title":"Phase 2: Weight Builder — WeightBuilder + WeightConfig generation","description":"## Goal\n\nImplement weight building as a proper artifact builder, producing WeightArtifact with versioned WeightConfig.\n\n## Work Items\n\n1. **pkg/model/builder.go** — Define Builder interface:\n   - `Builder` interface: `Build(ctx context.Context, spec ArtifactSpec) (Artifact, error)`\n\n2. **pkg/model/builder_image.go** — ImageBuilder:\n   - `ImageBuilder` struct wrapping existing docker build logic\n   - Implements `Builder` interface\n   - Takes `ImageSpec`, delegates to existing `Factory.Build()`, returns `ImageArtifact`\n\n3. **pkg/model/builder_weight.go** — WeightBuilder:\n   - `WeightBuilder` struct\n   - Implements `Builder` interface\n   - Takes `WeightSpec`, hashes file (SHA256), creates `WeightConfig`, returns `WeightArtifact`\n   - `WeightConfig` generation with versioned schema (v1.0):\n     - schemaVersion, cogVersion, name, target, created (RFC3339)\n\n4. **Update Resolver.Build()** to use builders:\n   - Get specs from `Source.ArtifactSpecs()`\n   - Route each spec to appropriate builder via `builderFor(spec.Type())`\n   - Collect artifacts into `Model.Artifacts`\n\n5. **Deprecate WeightsLockGenerator** — logic moves into WeightBuilder (or mark for removal in Phase 6)\n\n## Tests\n\n- Unit tests for `WeightBuilder`: correct hashing, config generation, artifact output\n- Unit tests for `WeightConfig` JSON serialization/deserialization\n- Test `ImageBuilder` wraps factory correctly\n- Test `Resolver.Build()` routing to correct builders\n- Existing tests still pass\n\n## Files to Create\n- pkg/model/builder.go + builder_test.go\n- pkg/model/builder_image.go + builder_image_test.go\n- pkg/model/builder_weight.go + builder_weight_test.go\n\n## Files to Modify\n- pkg/model/resolver.go (use builders in Build method)\n\n## Dependencies\n- Depends on Phase 1 (artifact types must exist)\n\n## Design Reference\ndocs/plans/2026-02-05-artifact-abstraction-design.md — \"Phase 2: Weight Builder\"","design":"## Implementation Plan (from design session)\n\n### Mental Model\n\n```\nSource (cog.yaml + projectDir)\n    │\n    │  ArtifactSpecs()              \"what needs to be built\" (from config)\n    ▼\n[]ArtifactSpec\n    │   ImageSpec                   name, imageName, secrets, noCache\n    │   WeightSpec[]                name, source path, target path\n    │\n    │  Resolver.Build() → builderFor(spec.Type())\n    ▼\nBuilder.Build(ctx, spec)            \"build it\"\n    │\n    │   ImageBuilder                WeightBuilder\n    │   - docker build              - check lockfile cache\n    │   - inspect                   - if stale: hash file (future: chunk)\n    │   - return ImageArtifact      - update lockfile\n    │                               - return WeightArtifact\n    ▼\n[]Artifact on Model                 \"what was built\"\n    │   ImageArtifact               WeightArtifact\n    │   (reference, digest)         (filePath, digest, size, config)\n    │\n    │  Pusher (Phase 3)\n    ▼\nRegistry\n```\n\n### Key Design Decisions\n\n1. **Build does real work for both artifact types.**\n   - ImageBuilder: invokes docker build, inspects result\n   - WeightBuilder: reads source files, computes hashes (future: chunks), manages lockfile\n   - The lockfile is a build cache owned by the WeightBuilder\n\n2. **WeightSpec stays minimal** — name, source, target. These are declarations from config.\n   Digest/size/mediaType are build OUTPUTS (on WeightArtifact), not inputs.\n\n3. **Source.ArtifactSpecs() stays as Phase 1 implemented it** — derives specs from config.\n   No signature change needed. Lockfile is internal to the builder.\n\n4. **WeightBuilder manages the lockfile** — reads as cache, writes after processing.\n   The lockfile records what was built (like image layer cache in Docker).\n\n5. **Naming convention**: weight_builder.go, image_builder.go (not builder_weight.go)\n\n6. **WeightBuilder takes Source** (not raw projectDir) — standardize on Source being\n   available to everything in the pipeline.\n\n7. **Build alongside, migrate later** — WeightsLockGenerator stays alive for existing CLI\n   callers. WeightBuilder is the new path. CLI migration in a follow-up.\n\n8. **processFile() hashing logic is reused** — adapted into WeightBuilder with one fix:\n   WeightFile.Name must come from Config.WeightSource.Name (bug fix), not filename derivation.\n\n### Operations Comparison: Image vs Weight\n\n```\n                    Image                              Weight\nDeclare:            cog.yaml (predict, build)          cog.yaml (weights[])\nResolve/Pin:        (implicit in docker build)         cog weights lock → weights.lock\nDiscover:           ArtifactSpecs() → ImageSpec        ArtifactSpecs() → WeightSpec[]\nBuild:              ImageBuilder (heavy: docker build)  WeightBuilder (hash, future chunk)\nPush:               ImagePusher (light: docker push)    WeightPusher (heavy: create layers)\n```\n\nBuild is heavy for images, light for weights. Push is light for images, heavy for weights.\nThe Builder interface abstracts over this difference.\n\n### Existing Code Disposition\n\n**Reused directly:**\n- processFile() hashing logic → method on WeightBuilder (with Name bug fix)\n- WeightsLock / LoadWeightsLock / Save → WeightBuilder calls these for cache\n- WeightFile struct → WeightBuilder produces these internally, transforms to WeightArtifact\n\n**Not touched in Phase 2:**\n- WeightsLockGenerator struct + callers (CLI still uses it)\n- weights_lock.go (lockfile format)\n- weights.go (manifest types, media constants)\n- resolveWeightFilePaths() in push.go (migrated when CLI switches to builder)\n\n**Not deleted:** WeightsLockGenerator lives alongside WeightBuilder until CLI migration.\n\n### Files to Create\n\n- pkg/model/builder.go + builder_test.go — Builder interface\n- pkg/model/weight_builder.go + weight_builder_test.go — WeightBuilder\n- pkg/model/image_builder.go + image_builder_test.go — ImageBuilder\n\n### Files to Modify\n\n- pkg/model/weights_lock_generator.go — Fix WeightFile.Name bug (use config name)\n- pkg/model/weights_lock_generator_test.go — Update for Name fix\n- pkg/model/resolver.go — Build() uses ArtifactSpecs() + builderFor() routing\n- pkg/model/resolver_test.go — Tests for builder integration\n\n### Type Designs\n\n**Builder interface (builder.go):**\n```go\ntype Builder interface {\n    Build(ctx context.Context, spec ArtifactSpec) (Artifact, error)\n}\n```\n\n**WeightBuilder (weight_builder.go):**\n```go\ntype WeightBuilder struct {\n    source     *Source    // Config + ProjectDir\n    cogVersion string     // from global.Version, injectable for testing\n}\n// Build: takes *WeightSpec, checks lockfile cache, hashes file if needed,\n// creates WeightConfig (schemaVersion \"1.0\"), returns *WeightArtifact\n// with FilePath pointing to original source file.\n```\n\n**ImageBuilder (image_builder.go):**\n```go\ntype ImageBuilder struct {\n    factory Factory\n    docker  command.Command\n    source  *Source\n    opts    BuildOptions\n}\n// Build: takes *ImageSpec, delegates to Factory.Build(),\n// inspects via docker, returns *ImageArtifact.\n```\n\n**Resolver.Build() changes:**\n- Call src.ArtifactSpecs() to get all specs\n- For each spec, call builderFor(spec, src, opts) to get appropriate builder\n- Call builder.Build(ctx, spec) to get artifact\n- Collect all artifacts into m.Artifacts\n- Existing WeightsManifest/ImageFormat logic stays for backwards compat\n\n### TDD Cycles (strict RED-GREEN-REFACTOR)\n\n1. Builder interface — compile-time check with mock\n2. WeightFile.Name bug fix — generator uses config name, update tests\n3. WeightBuilder happy path — real temp file, builds artifact with correct hash,\n   creates WeightConfig, writes/updates lockfile\n4. WeightBuilder cache hit — lockfile has current entry, skips re-hashing\n5. WeightBuilder cache miss — lockfile exists but entry stale, re-hashes\n6. WeightBuilder error cases — file not found, wrong spec type, context cancel\n7. ImageBuilder happy path — mock factory + docker, correct artifact\n8. ImageBuilder error cases — wrong type, factory error, inspect error\n9. Resolver.Build() integration — routes specs to builders, collects artifacts\n10. Full regression — go test ./pkg/model/...\n\n### Deferred\n\n- Chunking large files (future WeightBuilder enhancement)\n- Pre-pushing layers to registry cache during build\n- Push-side changes (Phase 3 uses WeightArtifact)\n- CLI caller migration (cog weights lock, cog push)\n- WeightsManifest derivation from WeightArtifact\n- Directory weight source expansion (complex, keep existing Walk logic)\n","notes":"Session notes (2026-02-05 design session):\n\nKey insight: \"Build\" for weights means real file processing (hash, future chunking),\nnot just metadata transforms. The lockfile is a build cache owned by the builder,\nanalogous to Docker layer cache for images.\n\nWeightFile.Name bug identified: currently derives name from filename (basename sans\nextension). Should come from Config.WeightSource.Name (the user declared identifier).\nFix included in this phase since the join-by-name between lockfile and config entries\ndepends on it.\n\nWeightSpec stays minimal (name, source, target) — no lockfile-derived fields.\nDigest/size are build outputs on WeightArtifact, not inputs on the spec.\n\nSource.ArtifactSpecs() stays as Phase 1 implemented it — no changes needed.\n\nImplementation approach: build WeightBuilder alongside existing WeightsLockGenerator.\nCLI callers (cog weights lock, cog push) continue using the generator. Migration in\na follow-up phase. Zero risk to existing behavior.\n\nprocessFile() hashing logic is the main piece being reused — adapted as a method on\nWeightBuilder with the Name bug fix. Everything else is additive.\n\nFuture considerations discussed:\n- Large weight chunking (16GB → N x 1GB chunks, each an OCI layer)\n- Pre-pushing dangling layers to registry during build (like buildkit cache)\n- These dont change the Builder interface, just the WeightBuilder implementation\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-05T12:36:12.58563-07:00","created_by":"Michael Dwan","updated_at":"2026-02-05T14:57:19.108742-07:00","closed_at":"2026-02-05T14:57:19.108742-07:00","close_reason":"Phase 2 complete: Builder interface, WeightBuilder, ImageBuilder, resolver integration, WeightFile.Name bug fix, media type consolidation. 135 tests pass.","dependencies":[{"issue_id":"cog-0j4","depends_on_id":"cog-26r","type":"discovered-from","created_at":"2026-02-05T12:37:06.651131-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-0j4","depends_on_id":"cog-mvv","type":"blocks","created_at":"2026-02-05T12:37:08.86956-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-0od","title":"Investigate flaky TestProcedureNonAsyncConcurrency test","description":"## Problem\nThe test `TestProcedureNonAsyncConcurrency` in `coglet/internal/tests/procedure_test.go` is flaky - it occasionally hangs and one of the concurrent runners crashes with `exit status 1`.\n\n## Observed Behavior\nWhen the test fails:\n1. Two concurrent runners are started: `7azflemd` and `re2arivp`\n2. Both use the same procedure source: `file:///Users/mdwan/src/replicate/cog/coglet/python/tests/procedures/bar`\n3. Runner `7azflemd` crashes with `exit status 1` immediately after writing the request file\n4. Runner `re2arivp` completes successfully\n5. No Python traceback is logged - the subprocess just exits\n\n## Key Log Evidence\n```\nsubprocess exited {\"runner_name\": \"7azflemd\", \"pid\": 29226, \"error\": \"exit status 1\"}\nsubprocess crashed during prediction execution, failing pending predictions\n```\n\n## Potential Root Causes to Investigate\n\n### 1. Race condition in PrepareProcedureSourceURL\nBoth runners derive their working directory from the same procedure hash:\n- `procedure-3d8236360a43e79431788f5fb401e85a8313e5e4f511147d8aead045a91882a8-7azflemd`\n- `procedure-3d8236360a43e79431788f5fb401e85a8313e5e4f511147d8aead045a91882a8-re2arivp`\n\nThe `PrepareProcedureSourceURL` function in `coglet/internal/runner/procedure.go` does:\n```go\nif err := os.RemoveAll(dstDir); err != nil { ... }\n// then copies files\n```\n\nIf two runners start simultaneously with the same procedure URL, there could be a race where one runner's directory setup interferes with another's.\n\n### 2. Missing ready file race\nIn the logs, runner `7azflemd` shows a `ready` file in its working directory listing, but `re2arivp` does not. This suggests:\n- The `ready` file might be created by the Python subprocess\n- There could be a race between checking for ready and the subprocess crashing\n\n### 3. Python subprocess silent crash\nThe subprocess exits with status 1 but no error is logged. Need to investigate:\n- Is stderr being captured correctly?\n- Is there a Python import error or early crash before logging is initialized?\n- Check `coglet/python/coglet/__main__.py` startup sequence\n\n### 4. IPC race condition\nLooking at the IPC handling:\n- Runner `7azflemd` sends READY IPC at 14:39:32.266\n- Runner crashes at 14:39:32.279 (13ms later)\n- The crash happens after writing the request file but before any prediction IPC\n\n## Files to Investigate\n- `coglet/internal/tests/procedure_test.go:428` - Test implementation\n- `coglet/internal/runner/procedure.go` - PrepareProcedureSourceURL\n- `coglet/internal/runner/manager.go` - createProcedureRunner, slot claiming\n- `coglet/python/coglet/__main__.py` - Python subprocess entry point\n- `coglet/python/coglet/file_runner.py` - File-based prediction runner\n\n## Reproduction\nRun multiple times to catch the flake:\n```bash\nfor i in {1..20}; do make test-coglet-go 2\u003e\u00261 | grep -E '(FAIL|PASS).*TestProcedureNonAsyncConcurrency'; done\n```\n\n## Expected Outcome\n- Identify the race condition causing the flaky test\n- Fix the underlying issue or improve test isolation\n- Test should pass reliably in CI","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-16T14:45:01.911703-07:00","updated_at":"2026-01-27T13:47:51.645112-07:00","closed_at":"2026-01-27T13:47:51.645112-07:00","close_reason":"No longer needed"}
{"id":"cog-17k","title":"Update docker_client_test.go to remove old client tests","description":"In pkg/docker/docker_client_test.go: Remove TestDockerClient() function (lines 22-31) that tests the old client, and remove the auth test skip condition for DockerCommand (lines 361-362).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:22.048281-07:00","updated_at":"2025-12-11T16:02:58.558096-07:00","closed_at":"2025-12-11T16:02:58.558096-07:00"}
{"id":"cog-1cy","title":"Delete docker_command.go implementation file","description":"Delete pkg/docker/docker_command.go (460 lines) which contains the entire DockerCommand implementation that shells out to the docker CLI. This is the core old client implementation.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:29.816098-07:00","updated_at":"2025-12-11T16:25:17.182636-07:00","closed_at":"2025-12-11T16:25:17.182636-07:00","dependencies":[{"issue_id":"cog-1cy","depends_on_id":"cog-5d6","type":"parent-child","created_at":"2025-12-11T16:02:29.816585-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-1dr","title":"Modernize coglet Python code to use inline type annotations instead of .pyi files","description":"Currently coglet Python code may use .pyi stub files for type annotations. Modernize to use inline type annotations directly in .py files instead.\n\nFor the specific client that needs type files (web editor using Pyodide), generate .pyi files on demand during build/release rather than committing them.\n\nScope:\n- Review coglet/python/ for any .pyi files or missing inline annotations\n- Update code to use inline type annotations\n- Set up generation of .pyi stubs for Pyodide client if needed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T10:31:50.188714-07:00","updated_at":"2026-01-27T13:47:51.649154-07:00","closed_at":"2026-01-27T13:47:51.649154-07:00","close_reason":"No longer needed"}
{"id":"cog-1i1","title":"Add hidden `cog inspect` command","description":"Hidden CLI command that resolves a model from a local or remote reference and displays full composition info.\n\n## Command\n`cog inspect \u003cref\u003e` with flags: `--local`, `--remote`, `--json`, `--raw`\n\n## Output Modes\n\n### Default (text): Human-readable tree\n```\nModel: r8.im/user/model:latest\nType:  OCI Index (bundle)\nCog:   0.15.0\n\nIndex: sha256:abc123... (application/vnd.oci.image.index.v1+json)\n  Manifests: 4\n\n  [image] linux/amd64\n    Digest: sha256:def456...\n    Size:   2.3 GB\n    Layers: 12\n      sha256:a1b2c3...  128 MB  application/vnd.oci.image.layer.v1.tar+gzip\n      sha256:d4e5f6...  256 MB  application/vnd.oci.image.layer.v1.tar+gzip\n      ...\n\n  [weights] model-v1\n    Digest: sha256:789abc...\n    Size:   4.2 GB\n    Target: /cache/model.safetensors\n    Type:   application/vnd.cog.weight.v1\n    Layers: 1\n      sha256:j0k1l2...  4.2 GB  application/vnd.cog.weight.layer.v1+gzip\n```\n\nFor non-index (plain image):\n```\nModel: r8.im/user/model:latest\nType:  Image\nCog:   0.15.0\n\nImage: linux/amd64\n  Digest: sha256:def456...\n  Size:   2.3 GB\n  Layers: 12\n    sha256:a1b2c3...  128 MB  ...\n```\n\n### --json: Structured JSON\nSingle JSON object with reference, type, cogVersion, index (with child manifests + layers), image info.\n\n### --raw: JSON fragments (one per line)\nEach line is a resolution step: resolve, index, manifest (per child), config (per child), model.\nPipe to `jq` for exploration. E.g. `cog inspect ref --raw | jq 'select(.step==\"index\")'`\n\n## Implementation\n\n### New file: pkg/cli/inspect.go\n- `newInspectCommand()` returns hidden `*cobra.Command`\n- Args: exactly one (image reference)\n- Flags: `--local`, `--remote`, `--json`, `--raw`\n- Flow:\n  1. Parse ref, create docker client + registry client + resolver\n  2. Determine inspect options from flags (LocalOnly/RemoteOnly/default)\n  3. Call `resolver.Inspect(ctx, ref, opts...)`\n  4. Route to output mode (text/json/raw)\n\n### Helper: enrichWithLayers()\n- Takes Model + registry.Client\n- For image manifest: `reg.GetImage(ctx, \"repo@sha256:digest\", nil)` -\u003e `.Manifest()` -\u003e extract layers\n- For each weight manifest: same approach\n- Returns InspectOutput struct with full layer details\n\n### Helper: streamRaw()\n- For each child manifest in index: fetch via GetImage() -\u003e .RawManifest()\n- Output one JSON line per resolution step\n\n### Output types (for JSON marshaling)\n```go\ntype InspectOutput struct {\n    Reference  string           `json:\"reference\"`\n    Type       string           `json:\"type\"`      // \"image\" or \"index\"\n    CogVersion string           `json:\"cogVersion\"`\n    Index      *InspectIndex    `json:\"index,omitempty\"`\n    Image      *InspectManifest `json:\"image,omitempty\"`\n}\n\ntype InspectIndex struct {\n    Digest    string            `json:\"digest\"`\n    MediaType string            `json:\"mediaType\"`\n    Manifests []InspectManifest `json:\"manifests\"`\n}\n\ntype InspectManifest struct {\n    Type        string            `json:\"type\"`\n    Name        string            `json:\"name,omitempty\"`\n    Digest      string            `json:\"digest\"`\n    MediaType   string            `json:\"mediaType\"`\n    Size        int64             `json:\"size\"`\n    Platform    string            `json:\"platform,omitempty\"`\n    Target      string            `json:\"target,omitempty\"`\n    Annotations map[string]string `json:\"annotations,omitempty\"`\n    Layers      []InspectLayer    `json:\"layers\"`\n}\n\ntype InspectLayer struct {\n    Digest    string `json:\"digest\"`\n    Size      int64  `json:\"size\"`\n    MediaType string `json:\"mediaType\"`\n}\n```\n\n### Registration: pkg/cli/root.go\nAdd `newInspectCommand()` to root subcommands.\n\n## Key decisions\n- Uses existing `resolver.Inspect()` — no changes to resolver\n- Uses existing `registry.GetImage()` for child manifest fetching — no changes to registry client interface\n- Always fetches child manifests eagerly (debug tool, thoroughness \u003e speed)\n- Deep manifest fetching lives in CLI layer, not resolver (clean separation)\n- Hidden command (Hidden: true)","status":"open","priority":1,"issue_type":"feature","owner":"mdwan@cloudflare.com","created_at":"2026-02-06T13:32:59.620947-07:00","created_by":"Michael Dwan","updated_at":"2026-02-06T13:32:59.620947-07:00"}
{"id":"cog-1rk","title":"Epic: Integrate coglet wheel embedding into cog","description":"Enable cog to embed and use the coglet wheel (v0.4.0+ rewrite) during builds, controlled by the COG_WHEEL environment variable. This allows testing the new coglet runtime without affecting existing behavior.\n\n## Goals\n- Build coglet wheel with linux/amd64 Go binary embedded\n- Embed coglet wheel in cog binary alongside cog wheel\n- Add COG_WHEEL env var to select runtime: cog, coglet, coglet-alpha, URL, or file path\n- Preserve backwards compatibility: cog_runtime:false -\u003e cog, cog_runtime:true -\u003e coglet-alpha\n- Add CI jobs to build, test, and release coglet wheel\n- Run existing coglet tests against both legacy cog and embedded coglet\n\n## Non-Goals\n- FastGenerator changes (out of scope)\n- coglet==X.Y.Z version syntax (defer until PyPI publication)\n- Dual runtime embedding in same image (revisit later)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-16T17:53:01.778648-07:00","updated_at":"2026-01-27T13:47:51.640196-07:00","closed_at":"2026-01-27T13:47:51.640196-07:00","close_reason":"No longer needed"}
{"id":"cog-1vi","title":"Attach coglet wheel to GitHub releases","description":"Update the release job to attach the coglet wheel to GitHub releases alongside the cog binaries.\n\n## Changes\n1. Update release job in .github/workflows/ci.yaml:\n   - Add needs: build-coglet (in addition to existing test dependencies)\n   - Download Coglet-Packages artifact\n   - After goreleaser runs, upload coglet wheel to release using gh release upload or softprops/action-gh-release\n2. Ensure wheel is named consistently (e.g., coglet-X.Y.Z-py3-none-any.whl)\n\n## Files\n- .github/workflows/ci.yaml\n\n## Acceptance Criteria\n- Tagged releases include coglet wheel as downloadable asset\n- Wheel version matches release tag","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T17:54:11.227528-07:00","updated_at":"2026-02-02T13:57:39.410146-07:00","closed_at":"2026-02-02T13:57:39.410146-07:00","close_reason":"Coglet integration complete","dependencies":[{"issue_id":"cog-1vi","depends_on_id":"cog-1rk","type":"parent-child","created_at":"2025-12-16T17:54:11.228044-07:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cog-1vi","depends_on_id":"cog-7rs","type":"blocks","created_at":"2025-12-16T17:54:11.228575-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-1xb","title":"Integrate COG_WHEEL into StandardGenerator","description":"Update StandardGenerator to use COG_WHEEL for runtime selection instead of hardcoded logic.\n\n## Changes\n1. Refactor installCog() to use GetWheelConfig():\n   - Check COG_WHEEL env var via GetWheelConfig(cogRuntimeEnabled)\n   - Dispatch to appropriate install method based on WheelSource\n2. Add installEmbeddedCoglet() method:\n   - Read coglet wheel via ReadCogletWheelFile()\n   - Write to temp dir in build context\n   - Generate pip install command\n   - Set R8_COG_VERSION and R8_PYTHON_VERSION env vars\n3. Add installWheelFromURL(url string) method:\n   - Generate pip install from URL command\n4. Add installWheelFromFile(path string) method:\n   - Copy wheel to build context\n   - Generate pip install command\n5. Update installCogRuntime() to use coglet-alpha (PinnedCogletURL) only when explicitly selected\n6. Ensure backwards compatibility:\n   - cog_runtime: false + no COG_WHEEL -\u003e embedded cog wheel (current behavior)\n   - cog_runtime: true + no COG_WHEEL -\u003e coglet-alpha/PinnedCogletURL (current behavior)\n   - COG_WHEEL=coglet -\u003e embedded coglet (new)\n\n## Files\n- pkg/dockerfile/standard_generator.go\n\n## Acceptance Criteria\n- Default behavior unchanged without COG_WHEEL set\n- COG_WHEEL=cog uses embedded cog wheel\n- COG_WHEEL=coglet uses embedded coglet wheel\n- COG_WHEEL=coglet-alpha uses PinnedCogletURL\n- COG_WHEEL=https://... uses URL directly\n- COG_WHEEL=/path/to/file.whl copies and installs local file","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T17:53:54.827397-07:00","updated_at":"2025-12-17T12:08:22.56935-07:00","closed_at":"2025-12-17T12:08:22.56935-07:00","dependencies":[{"issue_id":"cog-1xb","depends_on_id":"cog-1rk","type":"parent-child","created_at":"2025-12-16T17:53:54.827959-07:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cog-1xb","depends_on_id":"cog-a86","type":"blocks","created_at":"2025-12-16T17:53:54.828444-07:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cog-1xb","depends_on_id":"cog-mrj","type":"blocks","created_at":"2025-12-16T17:53:54.828839-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-1ys","title":"Integrate coglet build into Makefile","description":"Add Makefile targets for coglet:\n- coglet-wheel: Build coglet Python wheel from coglet/\n- coglet-server: Build coglet-server Go binary\n- test-coglet-go: Run coglet Go tests\n- test-coglet-python: Run coglet Python tests\n\nIntegrate with existing targets where appropriate.\n\nAlso adapt relevant scripts from cog-runtime/script/:\n- build.sh logic for coglet wheel (Go binaries embedded in wheel)\n- test.sh logic for coglet tests\n- Other scripts as needed (init.sh, check.sh, lint.sh)\n\nDepends on: cog-p27, cog-82x (binary and pyproject moves)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:13:01.022004-07:00","updated_at":"2025-12-15T16:05:52.123593-07:00","closed_at":"2025-12-15T16:05:52.123593-07:00","dependencies":[{"issue_id":"cog-1ys","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:13:01.022496-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-207","title":"Improve integration test output clarity and reduce noise","description":"Current integration test issues:\n\n1. **`--reruns 3`** hides flaky test failures and makes output confusing\n2. **`-n auto`** parallel execution interleaves output from multiple tests\n3. Long-running Docker builds have no progress indication\n4. No structured output for CI (junit xml, GitHub annotations)\n\nPotential improvements:\n- Remove or reduce reruns, add `-r R` flag to show rerun summary\n- Consider `--dist loadgroup` for better parallel output grouping\n- Add `--tb=short` for concise tracebacks\n- Add `--junit-xml=results.xml` and upload as CI artifact\n- Consider `pytest-github-actions-annotate-failures` for inline PR annotations\n- Evaluate if `pytest-sugar` or `pytest-pretty` would help locally\n\nFiles:\n- tox.ini (pytest commands)\n- .github/workflows/ci.yaml (CI-specific flags, artifact upload)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T13:49:49.661157-07:00","updated_at":"2026-01-27T13:47:51.65116-07:00","closed_at":"2026-01-27T13:47:51.65116-07:00","close_reason":"No longer needed","dependencies":[{"issue_id":"cog-207","depends_on_id":"cog-1rk","type":"parent-child","created_at":"2025-12-18T13:49:49.661697-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-26r","title":"Artifact Abstraction: Unified artifact model for build/push pipeline","description":"## Overview\n\nIntroduce a unified artifact abstraction over the current model/build/push pipeline, as designed in docs/plans/2026-02-05-artifact-abstraction-design.md.\n\n## Goals\n\n1. **Unified artifact model**: Any component of a model (image, weights, future types) is an \"artifact\" with consistent interfaces\n2. **Clean separation**: Declaration (spec) → Build → Result (artifact) → Push\n3. **Composable**: Build/push individual artifacts or combinations\n4. **Always index**: Eliminate branching by always producing an index, even for single-image models\n5. **OCI-compliant weights**: Design weight artifacts as proper OCI artifacts with versioned config blobs\n\n## Architecture\n\n```\nSource (cog.yaml + project dir)\n    │\n    ▼\nArtifactSpec[] ─── \"what will be built\" (declaration)\n    │\n    │  Builder\n    ▼\nArtifact[] ─────── \"what was built\" (immutable result)\n    │\n    │  Pusher\n    ▼\nRegistry ───────── \"where it lives\" (OCI index + manifests)\n```\n\n## Phases\n\n- Phase 1: Artifact Abstraction (Foundation) — core interfaces + types\n- Phase 2: Weight Builder — WeightBuilder + WeightConfig\n- Phase 3: Weight Pusher — fixes Docker Hub 400 bug with tarball.LayerFromFile\n- Phase 4: Bundle Pusher — rewritten BundlePusher orchestrating typed pushers\n- Phase 5: Always Index — eliminate FormatStandalone/FormatBundle branching\n- Phase 6: Cleanup — remove deprecated code paths\n\n## Design Reference\n\ndocs/plans/2026-02-05-artifact-abstraction-design.md","status":"open","priority":1,"issue_type":"epic","owner":"mdwan@cloudflare.com","created_at":"2026-02-05T12:35:35.100536-07:00","created_by":"Michael Dwan","updated_at":"2026-02-05T12:35:35.100536-07:00"}
{"id":"cog-2s6","title":"Port remaining integration tests to Go testscript framework","description":"Port remaining Python integration test fixtures to Go testscript framework.\n\n## Current State\n- 27 tests already ported and passing  \n- ~33 fixtures remaining in test-integration/test_integration/fixtures/\n\n## Fixtures Ported (27 total)\n### Original 14:\n- string-project → string_predictor.txtar\n- int-project → int_predictor.txtar  \n- async-string-project → async_predictor.txtar\n- file-input-project → file_input.txtar\n- env-project → env_vars.txtar\n- optional-project → optional_input.txtar\n- path-output-project → path_output.txtar\n- path-list-output-project → path_list_output.txtar\n- path-list-input-project → path_list_input.txtar\n- string-list-project → string_list_input.txtar\n- subdirectory-project → subdirectory_predictor.txtar\n- new-union-project → union_type.txtar\n- many-inputs-project → many_inputs.txtar\n- train-project → train_basic.txtar\n\n### Session 2 (13 new):\n- path-project → path_input_output.txtar (Path with setup method)\n- path-input-project → path_input.txtar (Path input only)\n- file-list-input-project → file_list_input.txtar (list[File] inputs)\n- complex_output_project → complex_output.txtar (BaseModel output)\n- procedure-project → function_predictor.txtar (function-based predictor)\n- python-313 → python313.txtar (Python 3.13 support)\n- pydantic2 → pydantic2.txtar (explicit Pydantic 2)\n- pydantic1-none → optional_path_input.txtar (None input handling)\n- future-annotations-project → future_annotations.txtar\n- int-none-output-project → int_none_output.txtar\n- string-none-output-project → string_none_output.txtar  \n- invalid-int-project → invalid_int_validation.txtar (schema validation)\n- no-predictor-project → no_predictor.txtar (error case)\n\n## Fixtures Remaining To Port\n\n### Medium Priority (Dependencies/Packages)\n- [ ] apt-packages - apt package installation\n- [ ] ffmpeg-package - ffmpeg installation  \n- [ ] zsh-package - zsh installation\n- [ ] local-whl-install - local wheel installation\n- [ ] install-requires-packaging - packaging metadata\n\n### Medium Priority (Framework/GPU)\n- [ ] torch-baseimage-project - PyTorch base image\n- [ ] torch-cuda-baseimage-project - CUDA base image\n- [ ] torch-270-cuda-126 - specific torch/cuda versions\n- [ ] torch-271-cuda-128 - specific torch/cuda versions\n- [ ] tensorflow-project - TensorFlow support\n- [ ] migration-gpu-project - GPU migration\n\n### Lower Priority (Edge Cases)\n- [ ] secrets-project - build secrets\n- [ ] overrides-project - config overrides\n- [ ] bad-dockerignore - dockerignore handling\n\n### Lower Priority (Advanced Features)\n- [ ] setup-subprocess-* projects - subprocess handling in setup (4 variants)\n- [ ] training-setup-project - training with setup\n- [ ] cog-runtime-float/int - runtime type handling\n- [ ] glb-project - GLB file handling\n- [ ] granite-project - specific model test\n\n### Skip (Complex/Special)\n- pipeline-project - requires external replicate API\n- complex-types, complex-types-list - SSL issues with anthropic package\n- fast-build - requires special --x-fast flag handling\n- migration-* projects - may need special handling\n- pydantic2-output - complex output types\n\n## Commands\n```bash\n# Run all tests\nmake test-integration-go\n\n# Run specific test  \ncd integration-tests \u0026\u0026 go test -v -run TestIntegration/path_output\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T17:16:54.207452-07:00","updated_at":"2026-02-02T13:57:38.441354-07:00","closed_at":"2026-02-02T13:57:38.441354-07:00","close_reason":"Integration test rewrite complete","dependencies":[{"issue_id":"cog-2s6","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-12T17:17:19.934324-07:00","created_by":"Matt Dwan","metadata":"{}"}]}
{"id":"cog-2y8","title":"Remove unused error helper functions","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T16:40:17.420298-07:00","updated_at":"2025-12-12T16:40:31.658421-07:00","closed_at":"2025-12-12T16:40:31.658421-07:00","dependencies":[{"issue_id":"cog-2y8","depends_on_id":"cog-5d6","type":"discovered-from","created_at":"2025-12-12T16:40:17.421126-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-3wh","title":"Fix coglet pyproject.toml readme path for CI","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-15T16:33:52.333857-07:00","updated_at":"2025-12-16T16:38:30.160268-07:00","closed_at":"2025-12-16T16:38:30.160268-07:00","dependencies":[{"issue_id":"cog-3wh","depends_on_id":"cog-4gd","type":"discovered-from","created_at":"2025-12-15T16:33:52.334644-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-48d","title":"Update AGENTS.md and CONTRIBUTING.md","description":"Update developer documentation:\n- AGENTS.md: Add coglet development commands, directory structure\n- CONTRIBUTING.md: Update with coglet contribution guidelines\n- PROJECT.md: Can be removed or updated (it was for exploration)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-15T15:15:11.450998-07:00","updated_at":"2025-12-15T15:15:11.450998-07:00","dependencies":[{"issue_id":"cog-48d","depends_on_id":"cog-vbg","type":"blocks","created_at":"2025-12-15T15:15:11.451503-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-4f5","title":"Merge Image into ImageArtifact + wire ImageBuilder into Resolver","description":"Eliminate the Image struct by merging it into ImageArtifact. ImageArtifact becomes the single type for 'an OCI container image' throughout pkg/model/. Wire ImageBuilder into Resolver.Build() to complete the build-side artifact framework. All artifact construction (image and weight) goes through the Builder interface.","design":"## Plan\n\n### Task 1: Merge Image fields/methods into ImageArtifact\n- Add Image fields (Digest, Labels, Platform, Source) to ImageArtifact struct\n- Move all Image methods (IsCogModel, CogVersion, ParsedConfig, ParsedOpenAPISchema, ToModel) to ImageArtifact\n- Move ImageSource type/constants, Platform struct, label vars to artifact_image.go\n- Delete image.go\n\n### Task 2: Update Factory interface\n- Factory.Build() returns *ImageArtifact instead of *Image\n- Factory.BuildBase() returns *ImageArtifact instead of *Image\n- Update DockerfileFactory to construct \u0026ImageArtifact{...}\n\n### Task 3: Update Model struct\n- Model.Image changes from *Image to *ImageArtifact\n\n### Task 4: Update Resolver + ImageBuilder\n- All \u0026Image{...} in resolver.go become \u0026ImageArtifact{...}\n- Resolver.Build() delegates to ImageBuilder instead of inline factory+inspect\n- ImageBuilder.Build() populates Labels, Digest, Source, descriptor on the artifact\n- modelFromImage() takes *ImageArtifact\n\n### Task 5: Update all tests\n- Mechanical find-replace: *Image -\u003e *ImageArtifact, \u0026Image{} -\u003e \u0026ImageArtifact{}\n- Across: resolver_test.go, image_builder_test.go, builder_test.go, model_test.go, pusher_test.go, ref_types_test.go, image_test.go\n\n### Key Design Decision\nImageArtifact has both Digest string (always set) and descriptor v1.Descriptor (set after build). Non-build paths (inspect, pull) set Digest but may not set descriptor -- fine since those paths don't use the Artifact interface.","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-05T15:20:36.705736-07:00","created_by":"Michael Dwan","updated_at":"2026-02-05T15:49:58.510418-07:00","closed_at":"2026-02-05T15:49:58.510418-07:00","close_reason":"Image merged into ImageArtifact. ImageBuilder wired into Resolver.Build(). Build-side artifact framework complete.","dependencies":[{"issue_id":"cog-4f5","depends_on_id":"cog-0j4","type":"discovered-from","created_at":"2026-02-05T15:21:13.559984-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-4f5","depends_on_id":"cog-26r","type":"blocks","created_at":"2026-02-05T15:21:20.649565-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-4gd","title":"Phase 1: Code Integration - Move cog-runtime code into repo","description":"Move all cog-runtime code into the main repo structure and get existing tests passing.\n\nDirectory structure:\n- cmd/coglet-server/ (from cog-runtime/cmd/cog/)\n- coglet/internal/ (from cog-runtime/internal/)\n- coglet/python/coglet/ (from cog-runtime/python/coglet/)\n- coglet/python/cog/ (from cog-runtime/python/cog/ - compatibility shim)\n- coglet/pyproject.toml (adapted from cog-runtime/pyproject.toml)\n\nThis is the parent task for Phase 1 subtasks.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:12:00.310477-07:00","updated_at":"2025-12-15T16:16:42.378732-07:00","closed_at":"2025-12-15T16:16:42.378732-07:00","dependencies":[{"issue_id":"cog-4gd","depends_on_id":"cog-l09","type":"blocks","created_at":"2025-12-15T15:12:00.310948-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-4ye","title":"Refactor coglet path operations to use os.Root for traversal safety","description":"Use Go 1.24's os.Root API to make path operations in coglet traversal-resistant.\n\n## Background\nCodeQL is flagging path injection vulnerabilities in coglet:\n- coglet/internal/runner/runner.go:866 - os.WriteFile(requestPath, ...)\n- coglet/internal/runner/runner.go:873 - os.Stat(requestPath)\n- coglet/internal/runner/procedure.go:62 - os.Stat(u.Path) for file:// URLs\n\n## Solution\nUse os.Root (Go 1.24+) to scope file operations to a safe directory:\n- Create root at working directory: root, _ := os.OpenRoot(workingDir)\n- Use root.Create(), root.Stat(), root.Open() instead of os.* functions\n- This prevents path traversal attacks even with malicious input\n\n## References\n- Go blog: https://go.dev/blog/osroot\n- Go 1.24 release notes for os.Root\n- go.mod already specifies go 1.25\n\n## Files to modify\n- coglet/internal/runner/runner.go - request file operations\n- coglet/internal/runner/procedure.go - file:// URL handling","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T14:20:38.275706-07:00","updated_at":"2025-12-16T14:38:32.15435-07:00","closed_at":"2025-12-16T14:38:32.15435-07:00"}
{"id":"cog-5d6","title":"Remove old CLI-based Docker client (DockerCommand)","description":"Remove the old CLI-based Docker client implementation (DockerCommand) that shells out to the docker CLI. The new SDK-based client (apiClient) has been the default for months and this cleanup will simplify the codebase, reduce test matrix complexity, and improve maintainability. This involves removing ~500 lines of code, simplifying CI configuration, and eliminating matrix tests that run against both clients.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-11T16:02:03.281145-07:00","updated_at":"2025-12-11T16:27:38.498559-07:00","closed_at":"2025-12-11T16:27:38.498559-07:00"}
{"id":"cog-5fn","title":"Simplify NewClient factory in docker.go","description":"Simplify pkg/docker/docker.go NewClient() function to always return NewAPIClient(). Remove COG_DOCKER_SDK_CLIENT environment variable check and conditional logic.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:19.744598-07:00","updated_at":"2025-12-11T16:02:58.558554-07:00","closed_at":"2025-12-11T16:02:58.558554-07:00"}
{"id":"cog-5id","title":"Phase 3: Weight Pusher — fix Docker Hub 400 with tarball.LayerFromFile","description":"## Goal\n\nCreate a proper WeightPusher that pushes weight artifacts correctly using tarball.LayerFromFile instead of the current fileBackedLayer. This fixes the Docker Hub 400 Bad Request error.\n\n## Problem\n\nThe current fileBackedLayer in index_factory.go creates layers that don't work with Docker Hub — it returns 400 Bad Request. The layer needs to be a proper tarball layer created by go-containerregistry's tarball package.\n\n## Work Items\n\n1. **pkg/model/pusher_weight.go** — WeightPusher:\n   - `WeightPusher` struct with `registry.Client` dependency\n   - Implements `Pusher` interface (or a typed pusher interface)\n   - For each `WeightArtifact`:\n     a. Create proper tarball layer from file using `tarball.LayerFromFile`\n     b. Push config blob (WeightConfig JSON)\n     c. Push weight layers\n     d. Build and push weight manifest (OCI 1.1 artifact pattern)\n     e. Return pushed manifest descriptor\n   - Support concurrent layer pushes (preserve current WeightsPusher behavior)\n   - Progress reporting callback\n\n2. **pkg/model/pusher_image.go** — ImagePusher (refactored):\n   - Extract `ImagePusher` from current pusher.go\n   - Clean interface: takes `ImageArtifact`, pushes via docker command\n\n3. **OCI manifest structure** for weights:\n   - artifactType: \"application/vnd.cog.weight.v1\"\n   - config: WeightConfig blob with mediaType \"application/vnd.cog.weight.config.v1+json\"\n   - layers: weight data layers with chunk annotations\n\n## Tests\n\n- Unit test: WeightPusher creates correct OCI manifest structure\n- Unit test: tarball.LayerFromFile produces valid layer\n- Integration test: push to local registry (ttl.sh or distribution)\n- Verify Docker Hub compatibility (manual or CI)\n\n## Files to Create\n- pkg/model/pusher_weight.go + pusher_weight_test.go\n- pkg/model/pusher_image.go + pusher_image_test.go\n\n## Files to Modify\n- pkg/model/pusher.go (may refactor interfaces)\n\n## Dependencies\n- Depends on Phase 2 (WeightArtifact type and WeightBuilder)\n\n## Design Reference\ndocs/plans/2026-02-05-artifact-abstraction-design.md — \"Phase 3: Weight Pusher (Fix the Bug)\"","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-05T12:36:27.242657-07:00","created_by":"Michael Dwan","updated_at":"2026-02-05T16:39:36.201692-07:00","closed_at":"2026-02-05T16:39:36.201692-07:00","close_reason":"WeightPusher implemented with tarball.LayerFromFile, 7 tests, code reviewed","dependencies":[{"issue_id":"cog-5id","depends_on_id":"cog-26r","type":"discovered-from","created_at":"2026-02-05T12:37:06.763435-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-5id","depends_on_id":"cog-0j4","type":"blocks","created_at":"2026-02-05T12:37:08.995549-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-5id","depends_on_id":"cog-4f5","type":"blocks","created_at":"2026-02-05T15:21:21.715018-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-5q4","title":"Rename TestDockerAPIClient to TestDockerClient and inline test setup","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:45:43.984639-07:00","updated_at":"2025-12-11T16:45:59.170108-07:00","closed_at":"2025-12-11T16:45:59.170108-07:00","dependencies":[{"issue_id":"cog-5q4","depends_on_id":"cog-5d6","type":"discovered-from","created_at":"2025-12-11T16:45:43.985152-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-68z","title":"Create coglet directory structure","description":"Create the new directory structure:\n- coglet/\n- coglet/internal/\n- coglet/python/\n- coglet/python/coglet/\n- coglet/python/cog/\n- cmd/coglet-server/","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:12:16.662175-07:00","updated_at":"2025-12-15T15:26:43.49214-07:00","closed_at":"2025-12-15T15:26:43.49214-07:00","dependencies":[{"issue_id":"cog-68z","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:12:16.662647-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-6cv","title":"Remove pipelines functionality from cog","status":"closed","priority":1,"issue_type":"feature","owner":"mdwan@cloudflare.com","created_at":"2026-01-30T16:34:40.297076-07:00","created_by":"Michael Dwan","updated_at":"2026-01-30T16:44:32.760605-07:00","closed_at":"2026-01-30T16:44:32.760605-07:00","close_reason":"Removed pipelines functionality from cog codebase"}
{"id":"cog-6q8","title":"Update StandardGenerator tests for COG_WHEEL","description":"Add/update tests for StandardGenerator to verify COG_WHEEL behavior.\n\n## Changes\n1. Add tests to pkg/dockerfile/standard_generator_test.go:\n   - Test default behavior (no COG_WHEEL) with cog_runtime: false -\u003e cog wheel\n   - Test default behavior (no COG_WHEEL) with cog_runtime: true -\u003e coglet-alpha\n   - Test COG_WHEEL=cog -\u003e embedded cog wheel\n   - Test COG_WHEEL=coglet -\u003e embedded coglet wheel\n   - Test COG_WHEEL=coglet-alpha -\u003e PinnedCogletURL\n   - Test COG_WHEEL=https://example.com/wheel.whl -\u003e URL install\n   - Test COG_WHEEL=/path/to/wheel.whl -\u003e local file install\n2. Use t.Setenv() to set COG_WHEEL in tests\n3. Verify generated Dockerfile contains expected pip install commands\n\n## Files\n- pkg/dockerfile/standard_generator_test.go\n\n## Acceptance Criteria\n- All COG_WHEEL scenarios have test coverage\n- Tests verify correct Dockerfile generation for each scenario","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T17:54:28.181272-07:00","updated_at":"2025-12-17T12:10:55.280469-07:00","closed_at":"2025-12-17T12:10:55.280469-07:00","dependencies":[{"issue_id":"cog-6q8","depends_on_id":"cog-1rk","type":"parent-child","created_at":"2025-12-16T17:54:28.181786-07:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cog-6q8","depends_on_id":"cog-1xb","type":"blocks","created_at":"2025-12-16T17:54:28.18229-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-77g","title":"Fix coglet tests in test-go CI job - need uv sync or exclude coglet/internal/tests","description":"The test-go CI job runs ./... which includes coglet/internal/tests, but it doesn't have uv set up. The tests hang for 20min then timeout because they're looking for .venv/bin/python3 which doesn't exist. Options: 1) Add uv sync to test-go job, 2) Exclude coglet/internal/tests from test-go since test-coglet-go covers them.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-15T17:40:48.405167-07:00","updated_at":"2025-12-15T17:46:14.194018-07:00","closed_at":"2025-12-15T17:46:14.194018-07:00"}
{"id":"cog-7rs","title":"Add CI job to build coglet wheel","description":"Add GitHub Actions job to build the coglet wheel and make it available as an artifact.\n\n## Changes\n1. Add build-coglet job to .github/workflows/ci.yaml:\n   - runs-on: ubuntu-latest\n   - Checkout with fetch-depth: 0 (for setuptools_scm)\n   - Setup Go (go-version-file: go.mod)\n   - Setup uv (hynek/setup-cached-uv)\n   - Run make coglet-wheel\n   - Upload coglet/dist/*.whl as artifact 'Coglet-Packages'\n2. Ensure job runs on push to main, tags, and PRs\n\n## Files\n- .github/workflows/ci.yaml\n\n## Acceptance Criteria\n- build-coglet job produces coglet wheel artifact\n- Artifact available for downstream jobs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T17:54:04.274053-07:00","updated_at":"2026-01-27T13:47:51.647247-07:00","closed_at":"2026-01-27T13:47:51.647247-07:00","close_reason":"No longer needed","dependencies":[{"issue_id":"cog-7rs","depends_on_id":"cog-1rk","type":"parent-child","created_at":"2025-12-16T17:54:04.274543-07:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cog-7rs","depends_on_id":"cog-i3w","type":"blocks","created_at":"2025-12-16T17:54:04.275008-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-7u2","title":"Remove coglet binary files from git history to reduce repo size (~100MB)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T17:21:29.910592-07:00","updated_at":"2025-12-16T16:38:30.256175-07:00","closed_at":"2025-12-16T16:38:30.256175-07:00"}
{"id":"cog-82x","title":"Create coglet/pyproject.toml for coglet wheel","description":"Create coglet/pyproject.toml adapted from cog-runtime/pyproject.toml\n\nKey settings:\n- name = 'coglet'\n- requires-python = '\u003e=3.8' (adding 3.8 support if feasible, else \u003e=3.9)\n- packages from coglet/python/ (both coglet/ and cog/ shim)\n- setuptools_scm for versioning\n- test dependencies for pytest, pytest-asyncio, etc.\n\nDepends on: cog-p52 (Python code move)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:12:52.866506-07:00","updated_at":"2025-12-15T16:03:50.119664-07:00","closed_at":"2025-12-15T16:03:50.119664-07:00","dependencies":[{"issue_id":"cog-82x","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:12:52.867014-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-887","title":"Debug 'go run ./cmd/cog build' failure - build command exits with error","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-18T10:21:39.107011-07:00","updated_at":"2025-12-18T13:31:46.317841-07:00","closed_at":"2025-12-18T13:31:46.317841-07:00"}
{"id":"cog-8cx","title":"E2E verification: weights build + index build","description":"End-to-end local testing sequence for verifying the weights build and index build pipeline. This is the parent task that we work through step by step.\n\n## Testing Sequence\n\n1. **Declare weights in cog.yaml** — set up a test project with weight files and cog.yaml\n2. **`cog weights build`** — verify lockfile is created/updated correctly\n3. **`cog weights push`** — push weights to registry (DockerHub for now), verify they land\n4. **`cog build`** — verify the new artifact API produces an image (with weights if applicable)\n5. **`cog push` without index gate** — push single image, verify it works\n6. **`cog push` with index gate (COG_OCI_INDEX=1)** — push index with artifacts for image + weights\n7. **Inspect pushed artifacts** — use `cog inspect` and `cog weights inspect` to verify correctness\n\n## Prerequisite\nThe `cog inspect` and `cog weights inspect` commands need to be implemented first so we have tooling to verify what we pushed.\n\n## Known gap\nThe `COG_OCI_INDEX` env var gate is defined (`pkg/model/format.go`) but NOT wired into the CLI. `buildOptionsFromFlags()` in `pkg/cli/build.go` never sets `OCIIndex: true`. This needs to be wired before step 6 can work.","status":"open","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-06T13:33:34.098262-07:00","created_by":"Michael Dwan","updated_at":"2026-02-06T13:33:34.098262-07:00"}
{"id":"cog-95y","title":"Update standard_generator.go to use local coglet wheel","description":"Update pkg/dockerfile/standard_generator.go to:\n1. Build/embed coglet wheel similar to how cog wheel is embedded\n2. Update installCogRuntime() to use local wheel instead of PinnedCogletURL\n3. Ensure coglet-server binary is available in the image\n\nKey files:\n- pkg/dockerfile/standard_generator.go (installCogRuntime function)\n- pkg/dockerfile/cog_embed.go (wheel embedding pattern)\n\nConsider: embed coglet wheel at build time, or build on demand?","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:13:47.246927-07:00","updated_at":"2026-02-02T13:57:39.406766-07:00","closed_at":"2026-02-02T13:57:39.406766-07:00","close_reason":"Coglet integration complete","dependencies":[{"issue_id":"cog-95y","depends_on_id":"cog-vli","type":"blocks","created_at":"2025-12-15T15:13:47.247397-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-97m","title":"Run full test suite to verify changes","description":"Run make test-go and make test-integration to ensure all tests pass with only the new SDK client. Verify CI passes on test branch before merging.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:47.333853-07:00","updated_at":"2025-12-11T16:27:32.878789-07:00","closed_at":"2025-12-11T16:27:32.878789-07:00","dependencies":[{"issue_id":"cog-97m","depends_on_id":"cog-5d6","type":"parent-child","created_at":"2025-12-11T16:02:47.334271-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-9e3","title":"Add CI matrix tests for coglet runtime tests","description":"## Goal\nRun integration tests against both cog and coglet runtimes to verify coglet is backwards compatible before making it the default.\n\n## Background\n- Integration tests in `test-integration/` test the full `cog build` + `cog predict` flow\n- The `COG_WHEEL` env var controls which runtime wheel is installed during build (see `pkg/wheels/wheels.go`)\n- Values: `cog` (legacy Python runtime), `coglet` (new Go/Python hybrid runtime)\n- `COG_WHEEL` overrides any `cog_runtime` setting in fixture cog.yaml files\n- Both matrix variants must pass to gate releases\n\n## Changes Required\n\n### 1. Update `tox.ini`\nAdd `COG_WHEEL` to pass_env for integration environment:\n```ini\n[testenv:integration]\npass_env =\n  COG_BINARY\n  COG_WHEEL\n```\n\n### 2. Update `.github/workflows/ci.yaml`\nAdd matrix strategy to `test-integration-matrix` job:\n```yaml\ntest-integration-matrix:\n  name: \"Test integration (${{ matrix.runtime }})\"\n  needs: build-python\n  runs-on: ubuntu-latest-16-cores\n  timeout-minutes: 25\n  strategy:\n    fail-fast: false\n    matrix:\n      runtime: [cog, coglet]\n  steps:\n    # ... existing steps unchanged ...\n    - name: Test\n      env:\n        COG_WHEEL: ${{ matrix.runtime }}\n      run: make test-integration\n```\n\n## Files to Modify\n- `tox.ini` (line ~76, add COG_WHEEL to pass_env)\n- `.github/workflows/ci.yaml` (lines 194-224, add matrix strategy and env)\n\n## Acceptance Criteria\n- CI runs integration tests twice: once with COG_WHEEL=cog, once with COG_WHEEL=coglet\n- Both jobs must pass for the `test-integration` rollup job to pass\n- Releases are gated on both runtime variants passing\n\n## Related Issues\n- cog-vl6: Remove cog_runtime from fixtures once stable (follow-up cleanup)\n- cog-207: Improve test output clarity (separate improvement)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T17:54:20.872707-07:00","updated_at":"2025-12-18T13:52:53.125921-07:00","closed_at":"2025-12-18T13:52:53.125921-07:00","dependencies":[{"issue_id":"cog-9e3","depends_on_id":"cog-1rk","type":"parent-child","created_at":"2025-12-16T17:54:20.87322-07:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cog-9e3","depends_on_id":"cog-a86","type":"blocks","created_at":"2025-12-16T17:54:20.873748-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-a19","title":"Move Go server code to coglet/internal/","description":"Move cog-runtime/internal/* to coglet/internal/\n\nPackages to move:\n- config/\n- logging/\n- loggingtest/\n- runner/\n- server/\n- service/\n- tests/\n- version/\n- webhook/\n\nUpdate Go import paths from github.com/replicate/cog-runtime/internal/* to github.com/replicate/cog/coglet/internal/*","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:12:22.235154-07:00","updated_at":"2025-12-15T15:17:05.144843-07:00","closed_at":"2025-12-15T15:17:05.144843-07:00","dependencies":[{"issue_id":"cog-a19","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:12:22.235635-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-a86","title":"Add coglet wheel embedding infrastructure","description":"Create infrastructure to embed the coglet wheel in the cog binary, similar to how the cog wheel is embedded.\n\n## Changes\n1. Create pkg/dockerfile/embed-coglet/ directory\n2. Create pkg/dockerfile/coglet_embed.go with:\n   - //go:embed embed-coglet/*.whl directive\n   - CogletEmbed embed.FS variable\n   - CogletWheelFilename() function\n   - ReadCogletWheelFile() function\n3. Add Makefile target coglet-wheel-embed:\n   - Depends on coglet-server-binaries\n   - Builds wheel to pkg/dockerfile/embed-coglet/\n   - Creates .coglet-wheel marker file\n4. Update $(COG_BINARIES) target to depend on coglet wheel\n5. Update .goreleaser.yaml before.hooks to include make coglet-wheel-embed\n\n## Files\n- pkg/dockerfile/embed-coglet/ (new directory)\n- pkg/dockerfile/coglet_embed.go (new file)\n- Makefile\n- .goreleaser.yaml\n\n## Acceptance Criteria\n- make cog builds binary with both cog and coglet wheels embedded\n- ReadCogletWheelFile() returns the coglet wheel bytes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T17:53:34.039939-07:00","updated_at":"2025-12-17T10:47:49.867123-07:00","closed_at":"2025-12-17T10:47:49.867123-07:00","dependencies":[{"issue_id":"cog-a86","depends_on_id":"cog-1rk","type":"parent-child","created_at":"2025-12-16T17:53:34.040458-07:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cog-a86","depends_on_id":"cog-i3w","type":"blocks","created_at":"2025-12-16T17:53:34.040927-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-a8o","title":"Remove source from weights.lock","status":"in_progress","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-03T12:32:27.882877-07:00","created_by":"Michael Dwan","updated_at":"2026-02-03T12:32:33.754378-07:00"}
{"id":"cog-agb","title":"Phase 4: Bundle Pusher — OCI index assembly with typed pushers","description":"## Goal\n\nRewrite BundlePusher to orchestrate typed pushers (ImagePusher, WeightPusher) and assemble the OCI index cleanly.\n\n## Work Items\n\n1. **Rewrite BundlePusher** in pkg/model/pusher.go:\n   - `BundlePusher` struct orchestrating `ImagePusher` and `WeightPusher`\n   - Flow:\n     a. Call `ImagePusher.Push()` for the image artifact\n     b. Call `WeightPusher.Push()` for each weight artifact (concurrent)\n     c. Collect all pushed manifest descriptors\n     d. Build OCI Image Index referencing all manifests\n     e. Push the index\n   - Clean error handling: if any artifact fails, report which one\n\n2. **Update push.go CLI** to use new BundlePusher:\n   - `Resolver.Push()` creates BundlePusher from Model.Artifacts\n   - Model.Artifacts provides everything needed — no re-running WeightsLockGenerator\n   - Remove `resolveWeightFilePaths()` workaround\n\n3. **Index building** — simplify index_factory.go:\n   - Index is built from pushed artifact descriptors (not by fetching image back from registry)\n   - Remove the fetch-back-from-registry pattern in current BundlePusher\n\n4. **Progress reporting**:\n   - Unified progress model across image and weight pushes\n   - Each artifact reports progress independently\n\n## Tests\n\n- Unit test: BundlePusher calls typed pushers in correct order\n- Unit test: OCI index structure is correct\n- Integration test: full bundle push to local registry\n- Verify index contains correct artifact references\n\n## Files to Modify\n- pkg/model/pusher.go (rewrite BundlePusher)\n- pkg/model/index.go or index_factory.go (simplify index building)\n- pkg/cli/push.go (use new push flow)\n- pkg/model/resolver.go (update Push method)\n\n## Dependencies\n- Depends on Phase 3 (WeightPusher and ImagePusher must exist)\n\n## Design Reference\ndocs/plans/2026-02-05-artifact-abstraction-design.md — \"Phase 4: Bundle Pusher (Index Assembly)\"","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-05T12:36:35.211747-07:00","created_by":"Michael Dwan","updated_at":"2026-02-05T19:31:58.632518-07:00","closed_at":"2026-02-05T19:31:58.632518-07:00","close_reason":"BundlePusher rewritten to orchestrate ImagePusher+WeightPusher with descriptor-based index assembly. Eliminates fetch-back-from-registry pattern.","dependencies":[{"issue_id":"cog-agb","depends_on_id":"cog-26r","type":"discovered-from","created_at":"2026-02-05T12:37:06.883242-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-agb","depends_on_id":"cog-5id","type":"blocks","created_at":"2026-02-05T12:37:09.120261-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-b0l","title":"Design E2E test fixture format and directory structure","description":"Design the fixture format for unified E2E tests:\n\nProposed structure:\ntest-e2e/\n├── fixtures/\n│   ├── simple-string/\n│   │   ├── cog.yaml\n│   │   ├── predict.py\n│   │   └── cases/\n│   │       ├── basic.json      # {input: {...}, expected: ...}\n│   │       └── edge-case.json\n│   └── streaming/\n│       └── ...\n\nQuestions to answer:\n- How to specify expected outputs (exact match? regex? schema?)\n- How to handle streaming outputs\n- How to handle file outputs\n- How to specify which runtimes a test applies to","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T15:14:27.576261-07:00","updated_at":"2026-02-02T13:57:52.679621-07:00","closed_at":"2026-02-02T13:57:52.679621-07:00","close_reason":"Closed with parent testing/coglet epics","dependencies":[{"issue_id":"cog-b0l","depends_on_id":"cog-tdd","type":"blocks","created_at":"2025-12-15T15:14:27.576714-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-b2j","title":"Remove Docker client matrix from test-integration job in CI","description":"In .github/workflows/ci.yaml: Remove new_docker_api_client matrix dimension from test-integration-matrix job (line 151) and remove COG_DOCKER_SDK_CLIENT env var (line 182). This eliminates half the integration test jobs.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:41.762026-07:00","updated_at":"2025-12-11T16:26:19.449265-07:00","closed_at":"2025-12-11T16:26:19.449265-07:00","dependencies":[{"issue_id":"cog-b2j","depends_on_id":"cog-5d6","type":"parent-child","created_at":"2025-12-11T16:02:41.762485-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-bp6","title":"Verify no remaining references to old client","description":"Search for any remaining references to COG_DOCKER_SDK_CLIENT and DockerCommand. Verify only interface type references remain (no direct instantiation). Run grep commands to confirm cleanup is complete.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:45.298908-07:00","updated_at":"2025-12-11T16:27:10.064148-07:00","closed_at":"2025-12-11T16:27:10.064148-07:00","dependencies":[{"issue_id":"cog-bp6","depends_on_id":"cog-5d6","type":"parent-child","created_at":"2025-12-11T16:02:45.299398-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-bsh","title":"Add E2E test suite to CI","description":"Add the unified E2E test suite to CI workflow:\n- Run against both runtimes\n- Run on PRs and main branch\n- Consider matrix for Python versions if relevant\n\nDepends on: cog-hlq (tests passing)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T15:14:53.548785-07:00","updated_at":"2026-02-02T13:57:52.684216-07:00","closed_at":"2026-02-02T13:57:52.684216-07:00","close_reason":"Closed with parent testing/coglet epics","dependencies":[{"issue_id":"cog-bsh","depends_on_id":"cog-tdd","type":"blocks","created_at":"2025-12-15T15:14:53.549258-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-c2d","title":"Delete docker_command_test.go test file","description":"Delete pkg/docker/docker_command_test.go which contains standalone tests for the old DockerCommand client.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:30.681396-07:00","updated_at":"2025-12-11T16:25:22.450559-07:00","closed_at":"2025-12-11T16:25:22.450559-07:00","dependencies":[{"issue_id":"cog-c2d","depends_on_id":"cog-5d6","type":"parent-child","created_at":"2025-12-11T16:02:30.681884-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-c6h","title":"Add mock registry to integration test harness for OCI index tests","description":"Add a mock OCI registry to the integration test harness using testcontainers (registry:2), then create integration tests for OCI index build and push.\n\n## Context\nThe OCI bundle implementation (md/oci-bundle branch) needs integration tests that:\n1. Build a model with --weights-lock and COG_OCI_INDEX=1\n2. Push the OCI index to a registry\n3. Verify the index structure (image manifest + weights artifact)\n4. Pull and inspect the model\n\n## Implementation\n\n### Part 1: Add Registry to Harness\n- Add `startRegistry()` method to harness that spins up registry:2 via testcontainers\n- Export $TEST_REGISTRY env var with the registry address\n- Add `registry-push` command to harness for pushing images\n- Add `crane` command wrapper for inspecting manifests\n\n### Part 2: Integration Tests\n- `tests/oci_index_build.txtar` - Build with COG_OCI_INDEX=1, verify local image works\n- `tests/oci_index_push.txtar` - Push to registry, verify index structure with crane\n\n### Part 3: Update Go Unit Tests  \n- Update `pkg/registry/push_test.go` to use testcontainers instead of TEST_REGISTRY env var\n- Update `pkg/model/index_factory_test.go` if needed\n\n## References\n- Existing testcontainers usage: `pkg/docker/docker_client_test.go`\n- Existing registry tests: `pkg/registry/registry_client_test.go` (uses testcontainers)\n- Harness: `integration-tests/harness/harness.go`","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-02T09:51:52.932576-07:00","created_by":"Michael Dwan","updated_at":"2026-02-02T15:01:39.844078-07:00","closed_at":"2026-02-02T15:01:39.844078-07:00","close_reason":"Added mock registry and OCI bundle integration tests with inline weights generator"}
{"id":"cog-cb7","title":"Simplify coglet-server binary build to linux/amd64 only","description":"Update Makefile to only build coglet-server for linux/amd64, since cog build always targets linux/amd64.\n\n## Changes\n- Modify coglet-server-binaries target to remove darwin and arm64 builds\n- Update to single command: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o coglet/python/cog/cog-linux-amd64 ./coglet/cmd/coglet-server\n- Clean up any references to multi-platform builds\n\n## Files\n- Makefile\n\n## Acceptance Criteria\n- make coglet-server-binaries only produces cog-linux-amd64\n- make coglet-wheel produces wheel with single binary (~5MB)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T17:53:19.361187-07:00","updated_at":"2025-12-17T10:36:04.786445-07:00","closed_at":"2025-12-17T10:36:04.786445-07:00"}
{"id":"cog-crx","title":"Add unit tests for CA cert functionality","description":"## Task\n\nCreate `pkg/dockerfile/cacert_test.go` with comprehensive unit tests.\n\n## Test Cases for ReadCACert()\n\n### Happy Path Tests\n\n1. **TestReadCACert_NotSet** - Returns nil, nil when env var not set\n2. **TestReadCACert_FilePath** - Reads cert from file path\n3. **TestReadCACert_Directory** - Reads and concatenates all .crt/.pem files from directory\n4. **TestReadCACert_InlinePEM** - Uses raw PEM string directly\n5. **TestReadCACert_InlinePEMWithWhitespace** - Handles leading/trailing whitespace\n6. **TestReadCACert_Base64Encoded** - Decodes base64 and uses PEM\n\n### Error Cases\n\n7. **TestReadCACert_DirectoryEmpty** - Error when dir has no .crt/.pem files\n8. **TestReadCACert_FileNotFound** - Error when file path doesn't exist\n9. **TestReadCACert_InvalidValue** - Error when value is not path/PEM/base64\n\n## Test Helpers\n\nUse a constant for test PEM:\n```go\nconst testPEM = `-----BEGIN CERTIFICATE-----\nMIIDxTCCAq2gAwIBAgIQAqxcJmoLQJuPC3nyrkYldzANBgkqhkiG9w0BAQsFADBs\n-----END CERTIFICATE-----`\n```\n\n## Test Patterns\n\n- Use `t.TempDir()` for temp files/directories\n- Use `t.Setenv()` to set COG_CA_CERT (auto-cleanup)\n- Use `require.NoError`, `require.Error`, `require.Equal`, `require.Contains` from testify\n\n## Example Test Structure\n\n```go\nfunc TestReadCACert_FilePath(t *testing.T) {\n    tmpFile := filepath.Join(t.TempDir(), \"test.crt\")\n    require.NoError(t, os.WriteFile(tmpFile, []byte(testPEM), 0644))\n    \n    t.Setenv(CACertEnvVar, tmpFile)\n    \n    data, err := ReadCACert()\n    require.NoError(t, err)\n    require.Equal(t, testPEM, string(data))\n}\n```\n\n## File to Create\n\n`pkg/dockerfile/cacert_test.go`\n\n## Running Tests\n\n```bash\ngo test ./pkg/dockerfile/... -run CACert -v\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T11:15:01.619056-07:00","updated_at":"2026-01-14T13:20:27.65381-07:00","closed_at":"2026-01-14T13:20:27.65381-07:00","close_reason":"Implemented CA cert injection via COG_CA_CERT","dependencies":[{"issue_id":"cog-crx","depends_on_id":"cog-yuu","type":"discovered-from","created_at":"2026-01-14T11:15:38.189757-07:00","created_by":"Matt Dwan","metadata":"{}"},{"issue_id":"cog-crx","depends_on_id":"cog-gmf","type":"blocks","created_at":"2026-01-14T11:15:43.517543-07:00","created_by":"Matt Dwan","metadata":"{}"}]}
{"id":"cog-ctq","title":"Update standard_push_test.go to use new client","description":"In pkg/docker/standard_push_test.go: Change NewDockerCommand() call to NewClient(t.Context()) to use the factory method instead of directly instantiating old client.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:33.790872-07:00","updated_at":"2025-12-11T16:25:11.804485-07:00","closed_at":"2025-12-11T16:25:11.804485-07:00","dependencies":[{"issue_id":"cog-ctq","depends_on_id":"cog-5d6","type":"parent-child","created_at":"2025-12-11T16:02:33.791365-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-cz1","title":"Refactor OCI index push into Resolver.Push() method","description":"## Problem\n\nThe OCI index push logic (~60 lines) is wedged directly into `pkg/cli/push.go` (lines 125-182). This mixes non-interactive business logic with CLI concerns, making the code harder to test and reuse.\n\n## Proposed Solution\n\nExtend `model.Resolver` with a `Push()` method that encapsulates all push variants:\n- Standard Docker push (current behavior)\n- OCI Index push with weights artifact (new COG_OCI_INDEX=1 path)\n\nThe CLI becomes a thin wrapper: `resolver.Build()` then `resolver.Push()`.\n\n## Why Resolver?\n\nThe Resolver already orchestrates build+inspect operations on models. Adding push completes the model lifecycle in one place. This follows the existing pattern where:\n- `Resolver.Build()` delegates to `Factory` implementations\n- `Resolver.Inspect()` handles local vs remote lookup\n- `Resolver.Push()` would handle standard vs OCI index push\n\n## Implementation Plan\n\n### 1. Define PushOptions struct\n```go\ntype PushOptions struct {\n    // OCIIndex enables OCI Image Index format with weights artifact\n    OCIIndex bool\n    // WeightsLockPath is the path to weights.lock (default: weights.lock in project dir)\n    WeightsLockPath string\n    // Fast enables fast push mode\n    Fast bool\n    // BuildInfo contains build metadata for logging\n    BuildInfo docker.BuildInfo\n}\n```\n\n### 2. Add Resolver.Push() method\n```go\nfunc (r *Resolver) Push(ctx context.Context, m *Model, src *Source, opts PushOptions) error\n```\n\nResponsibilities:\n- If `opts.OCIIndex` is true:\n  1. Build weights artifact from lock file\n  2. Push model image to registry\n  3. Fetch pushed image to get v1.Image\n  4. Build OCI index combining image + weights\n  5. Push OCI index\n- Otherwise: delegate to existing `docker.Push()`\n\n### 3. Move IndexFactory integration into Resolver\n- Resolver already holds `registry registry.Client`\n- Add `indexFactory *IndexFactory` field (or create on demand)\n- Use IndexFactory.BuildWeightsArtifact() and BuildIndex()\n\n### 4. Simplify pkg/cli/push.go\nReplace lines 125-182 with:\n```go\nerr = resolver.Push(ctx, m, src, model.PushOptions{\n    OCIIndex:  os.Getenv(\"COG_OCI_INDEX\") == \"1\",\n    Fast:      buildFast,\n    BuildInfo: docker.BuildInfo{...},\n})\n```\n\n### 5. Update existing callers\n- `pkg/cli/push.go` - use new Resolver.Push()\n- Any other push call sites\n\n### 6. Tests\n- Add `resolver_push_test.go` with unit tests for Push()\n- Test both standard and OCI index paths\n- Mock registry client for isolation\n\n## Files to Modify\n\n- `pkg/model/resolver.go` - Add Push() method\n- `pkg/model/options.go` - Add PushOptions struct\n- `pkg/cli/push.go` - Simplify to use Resolver.Push()\n- `pkg/model/resolver_test.go` - Add push tests\n\n## Dependencies\n\n- Depends on: cog-c6h (mock registry for integration tests) - nice to have for e2e testing\n- Blocked by: nothing\n\n## Success Criteria\n\n- [ ] All push logic moved out of CLI into Resolver\n- [ ] pkg/cli/push.go is \u003c30 lines of push-specific code\n- [ ] Both standard and OCI index push work via Resolver.Push()\n- [ ] Unit tests cover both paths\n- [ ] Existing integration tests still pass","design":"# Design: Refactor Push into Resolver.Push()\n\n**Issue:** cog-cz1  \n**Date:** 2026-02-02  \n**Status:** Draft\n\n## Problem\n\nThe OCI index push logic (~60 lines) is embedded directly in `pkg/cli/push.go` (lines 125-182). This:\n- Mixes non-interactive business logic with CLI concerns\n- Makes the code harder to test\n- Doesn't follow the pattern established by `Resolver.Build()`, `Resolver.Inspect()`, etc.\n\n## Goals\n\n1. Move push logic out of CLI into the model package\n2. Support both standalone images and bundles (OCI Index with weights)\n3. Make the format explicit via `ModelImageFormat` rather than runtime flags\n4. Keep the CLI as a thin wrapper\n\n## Non-Goals\n\n- Supporting deprecated fast push or pipeline push (being removed upstream)\n- Building indexes locally (indexes reference registry digests)\n\n## Terminology\n\n| Term | Meaning |\n|------|---------|\n| **Standalone** | Traditional single OCI image with everything baked in |\n| **Bundle** | OCI Image Index containing a runnable image + weights artifact |\n| **ModelImageFormat** | Enum: `FormatStandalone` or `FormatBundle` |\n| **Pusher** | Interface for push implementations |\n\n## Design\n\n### 1. ModelImageFormat Enum\n\nReplace `ModelFormat` (Image/Index) with clearer terminology:\n\n```go\n// pkg/model/format.go\n\n// ModelImageFormat describes the OCI structure of a model.\ntype ModelImageFormat string\n\nconst (\n    // FormatStandalone is a traditional single OCI image.\n    // All code, dependencies, and weights are baked into one image.\n    FormatStandalone ModelImageFormat = \"standalone\"\n    \n    // FormatBundle is an OCI Image Index containing multiple manifests:\n    // - A runnable image (code, dependencies)\n    // - A weights artifact (model weights, fetched separately)\n    FormatBundle ModelImageFormat = \"bundle\"\n)\n```\n\n### 2. Updated Model Struct\n\n```go\n// pkg/model/model.go\n\ntype Model struct {\n    Image      *Image\n    Config     *config.Config\n    Schema     *openapi3.T\n    CogVersion string\n    \n    // ImageFormat describes the OCI structure.\n    // Set at build time, checked at push time.\n    ImageFormat ModelImageFormat\n    \n    // Bundle-specific fields (nil for standalone)\n    Index           *Index           // OCI Index details (populated when inspecting)\n    WeightsManifest *WeightsManifest // Weight file metadata\n}\n```\n\n### 3. Updated BuildOptions\n\n```go\n// pkg/model/options.go\n\ntype BuildOptions struct {\n    // ... existing fields ...\n    \n    // ImageFormat specifies the desired OCI format for the built image.\n    // FormatStandalone (default): Traditional single OCI image\n    // FormatBundle: OCI Image Index with weights artifact (requires weights.lock)\n    ImageFormat ModelImageFormat\n    \n    // WeightsLockPath is the path to weights.lock file.\n    // Only used when ImageFormat == FormatBundle.\n    // Default: weights.lock in project directory.\n    WeightsLockPath string\n    \n    // REMOVE: OCIIndex bool (replaced by ImageFormat)\n}\n```\n\n### 4. Build Flow Changes\n\nIn `Resolver.Build()`, after building the image:\n\n```go\n// Set image format\nmodel.ImageFormat = opts.ImageFormat\nif model.ImageFormat == \"\" {\n    model.ImageFormat = FormatStandalone\n}\n\n// For bundles, load weights manifest\nif model.ImageFormat == FormatBundle {\n    lockPath := opts.WeightsLockPath\n    if lockPath == \"\" {\n        lockPath = filepath.Join(src.ProjectDir, WeightsLockFilename)\n    }\n    \n    lock, err := LoadWeightsLock(lockPath)\n    if err != nil {\n        return nil, fmt.Errorf(\"bundle format requires weights.lock: %w\", err)\n    }\n    \n    model.WeightsManifest = lock.ToWeightsManifest()\n}\n```\n\n### 5. Pusher Interface\n\nInternal interface for push implementations:\n\n```go\n// pkg/model/pusher.go\n\n// Pusher handles pushing a model to a registry.\ntype Pusher interface {\n    Push(ctx context.Context, m *Model, opts PushOptions) error\n}\n\n// PushOptions configures push behavior.\ntype PushOptions struct {\n    // ProjectDir is the base directory for resolving weight file paths.\n    // Required when Model.ImageFormat == FormatBundle.\n    ProjectDir string\n    \n    // Platform specifies the target platform for bundle indexes.\n    // Default: linux/amd64\n    Platform *Platform\n}\n```\n\n### 6. ImagePusher (Standalone)\n\n```go\n// pkg/model/image_pusher.go\n\n// ImagePusher pushes standalone images using docker push.\ntype ImagePusher struct {\n    docker command.Command\n}\n\nfunc NewImagePusher(docker command.Command) *ImagePusher {\n    return \u0026ImagePusher{docker: docker}\n}\n\nfunc (p *ImagePusher) Push(ctx context.Context, m *Model, opts PushOptions) error {\n    if m.Image == nil || m.Image.Reference == \"\" {\n        return fmt.Errorf(\"model has no image reference\")\n    }\n    return p.docker.Push(ctx, m.Image.Reference)\n}\n```\n\n### 7. BundlePusher (OCI Index)\n\n```go\n// pkg/model/bundle_pusher.go\n\n// BundlePusher pushes bundles (OCI Index with image + weights).\ntype BundlePusher struct {\n    docker   command.Command\n    registry registry.Client\n}\n\nfunc NewBundlePusher(docker command.Command, reg registry.Client) *BundlePusher {\n    return \u0026BundlePusher{docker: docker, registry: reg}\n}\n\nfunc (p *BundlePusher) Push(ctx context.Context, m *Model, opts PushOptions) error {\n    if m.Image == nil || m.Image.Reference == \"\" {\n        return fmt.Errorf(\"model has no image reference\")\n    }\n    if m.WeightsManifest == nil {\n        return fmt.Errorf(\"bundle format requires WeightsManifest\")\n    }\n    if opts.ProjectDir == \"\" {\n        return fmt.Errorf(\"bundle push requires ProjectDir for weight files\")\n    }\n    \n    // 1. Build weights artifact from manifest\n    factory := NewIndexFactory()\n    weightsArtifact, err := factory.BuildWeightsArtifactFromManifest(\n        ctx, m.WeightsManifest, opts.ProjectDir)\n    if err != nil {\n        return fmt.Errorf(\"build weights artifact: %w\", err)\n    }\n    \n    // 2. Push model image to registry\n    if err := p.docker.Push(ctx, m.Image.Reference); err != nil {\n        return fmt.Errorf(\"push model image: %w\", err)\n    }\n    \n    // 3. Fetch pushed image to get v1.Image for index building\n    modelImg, err := p.registry.GetImage(ctx, m.Image.Reference, nil)\n    if err != nil {\n        return fmt.Errorf(\"fetch pushed image: %w\", err)\n    }\n    \n    // 4. Build OCI index\n    platform := opts.Platform\n    if platform == nil {\n        platform = \u0026Platform{OS: \"linux\", Architecture: \"amd64\"}\n    }\n    idx, err := factory.BuildIndex(ctx, modelImg, weightsArtifact, platform)\n    if err != nil {\n        return fmt.Errorf(\"build OCI index: %w\", err)\n    }\n    \n    // 5. Push index (overwrites the tag with the index)\n    if err := p.registry.PushIndex(ctx, m.Image.Reference, idx); err != nil {\n        return fmt.Errorf(\"push OCI index: %w\", err)\n    }\n    \n    return nil\n}\n```\n\n### 8. Resolver.Push()\n\n```go\n// pkg/model/resolver.go\n\n// Push pushes a Model to a container registry.\n// The push strategy is determined by Model.ImageFormat:\n// - FormatStandalone: Standard docker push\n// - FormatBundle: Push image, build index with weights, push index\nfunc (r *Resolver) Push(ctx context.Context, m *Model, opts PushOptions) error {\n    pusher := r.pusherFor(m.ImageFormat)\n    return pusher.Push(ctx, m, opts)\n}\n\nfunc (r *Resolver) pusherFor(format ModelImageFormat) Pusher {\n    switch format {\n    case FormatBundle:\n        return NewBundlePusher(r.docker, r.registry)\n    default:\n        return NewImagePusher(r.docker)\n    }\n}\n```\n\n### 9. Simplified CLI\n\n```go\n// pkg/cli/push.go\n\nfunc push(cmd *cobra.Command, args []string) error {\n    // ... setup code ...\n    \n    // Determine image format\n    imageFormat := model.FormatStandalone\n    if os.Getenv(\"COG_OCI_INDEX\") == \"1\" {\n        imageFormat = model.FormatBundle\n    }\n    \n    // Build\n    buildOpts := buildOptionsFromFlags(cmd, imageName, buildFast, annotations)\n    buildOpts.ImageFormat = imageFormat\n    \n    m, err := resolver.Build(ctx, src, buildOpts)\n    if err != nil {\n        return err\n    }\n    \n    // Push\n    pushOpts := model.PushOptions{\n        ProjectDir: src.ProjectDir,\n    }\n    \n    if err := resolver.Push(ctx, m, pushOpts); err != nil {\n        return err\n    }\n    \n    console.Infof(\"Image '%s' pushed\", m.ImageRef())\n    return nil\n}\n```\n\n## File Changes Summary\n\n| File | Change |\n|------|--------|\n| `pkg/model/format.go` | NEW: ModelImageFormat enum |\n| `pkg/model/model.go` | Update: ImageFormat field replaces Format |\n| `pkg/model/options.go` | Update: ImageFormat replaces OCIIndex |\n| `pkg/model/pusher.go` | NEW: Pusher interface, PushOptions |\n| `pkg/model/image_pusher.go` | NEW: ImagePusher implementation |\n| `pkg/model/bundle_pusher.go` | NEW: BundlePusher implementation |\n| `pkg/model/resolver.go` | Add: Push(), pusherFor() |\n| `pkg/model/index.go` | Update: Remove ModelFormat (replaced) |\n| `pkg/model/index_factory.go` | Add: BuildWeightsArtifactFromManifest() |\n| `pkg/cli/push.go` | Simplify: Use resolver.Push() |\n\n## Migration Notes\n\n1. `ModelFormat` (Image/Index) becomes `ModelImageFormat` (Standalone/Bundle)\n2. `BuildOptions.OCIIndex bool` becomes `BuildOptions.ImageFormat ModelImageFormat`\n3. Internal `model.Format` field becomes `model.ImageFormat`\n4. CLI logic (~60 lines) moves to `BundlePusher`\n\n## Testing Strategy\n\n1. Unit tests for `ImagePusher` with mock docker client\n2. Unit tests for `BundlePusher` with mock docker + registry clients\n3. Unit tests for `Resolver.Push()` verifying pusher selection\n4. Integration tests using existing test infrastructure\n\n## Open Questions\n\n1. Should we support a `--format` flag in CLI, or keep using `COG_OCI_INDEX` env var?\n2. Should `BundlePusher` emit progress messages, or should that be CLI's job?\n\n## Future Work\n\n- Extract `Registry` type to own push/pull/inspect operations\n- Remove deprecated fast push and pipeline push code\n- Add `--format` flag to CLI when feature is stable","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-02T10:14:51.373346-07:00","created_by":"Michael Dwan","updated_at":"2026-02-02T14:07:23.967558-07:00","closed_at":"2026-02-02T14:07:23.967558-07:00","close_reason":"Implemented Resolver.Push() with Pusher interface"}
{"id":"cog-d8l","title":"Remove --x-pipeline feature (unshipped)","description":"## Objective\nRemove the `--x-pipeline` feature flag and all associated code. This was an experimental feature that did not ship.\n\n## Background\nThe \"pipelines\" feature (also `--x-pipeline`) was an experimental feature for ephemeral CPU-only models on Replicate that:\n- Run once and are discarded\n- Can call other Replicate models via `replicate.use()`\n- Required Python 3.13, no GPU/CUDA, limited system packages\n\n## User Clarifications\n- Q: Is `cog pull` used for anything other than pipelines? A: **No**\n- Q: Is `PullSource()` in `pkg/api/client.go` used by anything else? A: **No**\n\n## Files to DELETE Entirely\n\n### Go Packages\n- `pkg/procedure/` - Pipeline validation (validate.go, validate_test.go)\n- `pkg/api/` - API client for pipeline push/pull (client.go, client_test.go)\n- `pkg/docker/pipeline_push.go` and `pkg/docker/pipeline_push_test.go`\n- `pkg/cli/pull.go` - Pull command (pipeline-only)\n- `pkg/image/model_dependencies.go` - Model dependencies generation\n\n### Templates\n- `pkg/cli/init-templates/pipeline/` - Entire directory (AGENTS.md, main.py, cog.yaml, requirements.txt, .dockerignore, README.md)\n\n### Python SDK\n- `python/cog/command/call_graph.py` - Call graph analyzer\n- `python/tests/command/call_graph_test.py` - Tests\n- `cog-dataclass/python/cog/command/call_graph.py` - Same in cog-dataclass\n\n### Integration Tests\n- `integration-tests/tests/predict_pipeline.txtar`\n- `integration-tests/tests/build_model_dependencies.txtar`\n\n## Files to MODIFY\n\n### CLI Commands - Remove `--x-pipeline` flag and `pipelinesImage` variable:\n- `pkg/cli/push.go` - Remove `pipelinesImage` var, `addPipelineImage()`, usage in Build/Push calls\n- `pkg/cli/build.go` - Remove `addPipelineImage(cmd)` and `pipelinesImage` param to Build()\n- `pkg/cli/predict.go` - Remove flag, conditional `pipelinesImage` check in build path\n- `pkg/cli/run.go` - Remove flag, conditional `pipelinesImage` check in build path\n- `pkg/cli/init.go` - Remove `pipelineTemplate` var, pipeline template selection, `downloadPipelineRequirementsFile()`, `pipelinesRuntimeRequirementsURL()`, `addPipelineInit()`\n- `pkg/cli/init_test.go` - Remove `TestInitPipeline`\n- `pkg/cli/root.go` - Remove `newPullCommand()` from command list\n\n### Docker/Push:\n- `pkg/docker/push.go` - Remove `Pipeline` field from `BuildInfo`, remove conditional `PipelinePush()` call\n\n### Image Building:\n- `pkg/image/build.go` - Remove `pipelinesImage` parameter, remove `procedure.Validate()` call, remove `GenerateModelDependencies()` call and label\n\n### Environment:\n- `pkg/env/env.go` - Remove `PipelinesRuntimeHostEnvVarName` and `PipelinesRuntimeHostFromEnvironment()`\n\n### Labels:\n- `pkg/docker/command/manifest.go` - Remove `CogModelDependenciesLabelKey`\n\n### Tests:\n- `pkg/docker/push_test.go` - Update Push() calls to match new signature (remove cfg param)","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-30T16:12:44.18365-07:00","created_by":"Michael Dwan","updated_at":"2026-02-02T13:57:37.204394-07:00","closed_at":"2026-02-02T13:57:37.204394-07:00","close_reason":"Completed - pipeline feature removed"}
{"id":"cog-dg5","title":"Integrate coglet tests into CI workflow","description":"Update .github/workflows/ci.yaml to include coglet tests:\n- test-coglet-go job (coglet Go server tests)\n- test-coglet-python job (coglet Python tests across Python versions)\n- check-coglet-stubs job (type stub generation check)\n- lint-coglet jobs (Go and Python linting)\n\nReference cog-runtime/.github/workflows/ci.yml for job structure.\n\nKeep coglet tests as separate jobs initially for clarity.\n\nDepends on: cog-1ys (Makefile integration)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:13:06.792611-07:00","updated_at":"2025-12-15T16:06:31.942694-07:00","closed_at":"2025-12-15T16:06:31.942694-07:00","dependencies":[{"issue_id":"cog-dg5","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:13:06.793056-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-dmt","title":"Rename api_client.go to docker.go","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:51:44.219621-07:00","updated_at":"2025-12-11T16:51:50.918012-07:00","closed_at":"2025-12-11T16:51:50.918012-07:00","dependencies":[{"issue_id":"cog-dmt","depends_on_id":"cog-5d6","type":"discovered-from","created_at":"2025-12-11T16:51:44.22031-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-dqh","title":"Delete docker_command.go implementation file","description":"Delete pkg/docker/docker_command.go (460 lines) which contains the entire DockerCommand implementation that shells out to the docker CLI. This is the core old client implementation.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:16.708779-07:00","updated_at":"2025-12-11T16:02:58.559264-07:00","closed_at":"2025-12-11T16:02:58.559264-07:00"}
{"id":"cog-dzm","title":"Phase 5: Always Index — eliminate FormatStandalone/FormatBundle branching","description":"## Goal\n\nEliminate the FormatStandalone vs FormatBundle branching. Every model push produces an OCI Image Index, even for single-image models.\n\n## Work Items\n\n1. **Update BundlePusher** to always produce an index:\n   - Single-image models get an index with one manifest entry\n   - Bundle models get an index with image + weight manifest entries\n   - No conditional logic based on ImageFormat\n\n2. **Remove ModelImageFormat**:\n   - Remove `FormatStandalone` and `FormatBundle` constants from format.go\n   - Remove `Model.ImageFormat` field\n   - Remove `ImageFormatFromEnv()` and `COG_OCI_INDEX` env var handling\n   - Remove `BuildOptions.ImageFormat` field\n\n3. **Simplify Resolver.Push()**:\n   - Remove branching between ImagePusher and BundlePusher\n   - Always use BundlePusher (which handles single-image case)\n\n4. **Update CLI**:\n   - Remove `--format` flag if it exists\n   - Remove any `COG_OCI_INDEX` documentation/references\n   - Update help text\n\n5. **Update Resolver.Build()**:\n   - Remove ImageFormat from build flow\n   - Build always produces artifacts that can be pushed as index\n\n## Tests\n\n- Verify single-image model push produces valid OCI index\n- Verify bundle model push produces valid OCI index\n- Verify existing `cog push` workflows still work\n- Test that removing COG_OCI_INDEX doesn't break anything\n- Integration test: push single-image model, verify it's pullable\n\n## Risks\n\n- Registries that don't support OCI Image Index (unlikely but possible)\n- Existing tooling that expects a single manifest at a tag\n- Docker pull behavior with indexes (should resolve via platform matching)\n\n## Files to Modify\n- pkg/model/format.go (remove or gut)\n- pkg/model/model.go (remove ImageFormat field)\n- pkg/model/options.go (remove ImageFormat from BuildOptions)\n- pkg/model/pusher.go (simplify branching)\n- pkg/model/resolver.go (simplify push flow)\n- pkg/cli/push.go (remove format handling)\n\n## Dependencies\n- Depends on Phase 4 (BundlePusher must handle both cases)\n\n## Design Reference\ndocs/plans/2026-02-05-artifact-abstraction-design.md — \"Phase 5: Always Index\"","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-05T12:36:46.77021-07:00","created_by":"Michael Dwan","updated_at":"2026-02-06T10:22:44.425218-07:00","closed_at":"2026-02-06T10:22:44.425218-07:00","close_reason":"Always-index: deleted ModelImageFormat/COG_OCI_INDEX, BundlePusher handles 0 weights, Resolver.Push always produces OCI index.","dependencies":[{"issue_id":"cog-dzm","depends_on_id":"cog-26r","type":"discovered-from","created_at":"2026-02-05T12:37:06.981921-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-dzm","depends_on_id":"cog-agb","type":"blocks","created_at":"2026-02-05T12:37:09.225369-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-e36","title":"Remove obsolete TestStandardPushWithFullDockerCommand test","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T11:12:39.274386-07:00","updated_at":"2025-12-12T11:12:46.531449-07:00","closed_at":"2025-12-12T11:12:46.531449-07:00","dependencies":[{"issue_id":"cog-e36","depends_on_id":"cog-5d6","type":"discovered-from","created_at":"2025-12-12T11:12:39.275102-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-e9t","title":"Phase 6: Cleanup — remove deprecated code paths","description":"## Goal\n\nRemove deprecated code paths that have been superseded by the artifact abstraction.\n\n## Work Items\n\n1. **Remove WeightsManifest** from Model:\n   - Remove `Model.WeightsManifest` field\n   - Remove `WeightsManifest` and `WeightFile` types from weights.go (if fully superseded)\n   - Update any code that reads WeightsManifest to use Model.WeightArtifacts()\n\n2. **Remove old push logic**:\n   - Remove old BundlePusher implementation (replaced in Phase 4)\n   - Remove `fileBackedLayer` from index_factory.go\n   - Remove `WeightsArtifactBuilder` from index_factory.go (replaced by WeightBuilder)\n   - Remove or simplify `IndexFactory` (index building moved to BundlePusher)\n\n3. **Remove WeightsLockGenerator** (if not done in Phase 2):\n   - Logic has moved to WeightBuilder\n   - Remove weights_lock_generator.go\n   - May keep WeightsLock for backwards-compatible file parsing\n\n4. **Remove old WeightsPusher**:\n   - Replaced by WeightPusher in Phase 3\n   - Remove weights_pusher.go\n\n5. **Update CLI docs/help**:\n   - Remove references to standalone vs bundle format\n   - Update any help text about COG_OCI_INDEX\n   - Update docs/environment.md if needed\n\n6. **Clean up tests**:\n   - Remove tests for deprecated types\n   - Ensure test coverage for new types is complete\n\n## Tests\n\n- All existing integration tests still pass\n- No references to removed types in non-test code\n- Go vet / lint clean\n\n## Files to Remove or Gut\n- pkg/model/weights.go (remove WeightsManifest if superseded)\n- pkg/model/weights_lock_generator.go (remove)\n- pkg/model/weights_pusher.go (remove)\n- pkg/model/index_factory.go (remove fileBackedLayer, WeightsArtifactBuilder)\n- pkg/model/format.go (remove if not done in Phase 5)\n\n## Dependencies\n- Depends on Phase 5 (all new code paths must be working)\n\n## Design Reference\ndocs/plans/2026-02-05-artifact-abstraction-design.md — \"Phase 6: Cleanup\"","status":"closed","priority":3,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-05T12:36:57.374479-07:00","created_by":"Michael Dwan","updated_at":"2026-02-06T12:30:34.82616-07:00","closed_at":"2026-02-06T12:30:34.82616-07:00","close_reason":"Phase 6 complete: removed WeightsManifest, IndexFactory dead code, WeightsLockGenerator, WeightsPusher. Migrated CLI to WeightBuilder+WeightPusher. Net -407 lines in final commit.","dependencies":[{"issue_id":"cog-e9t","depends_on_id":"cog-26r","type":"discovered-from","created_at":"2026-02-05T12:37:07.086707-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-e9t","depends_on_id":"cog-dzm","type":"blocks","created_at":"2026-02-05T12:37:09.328997-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-egj","title":"Fix race condition in pending cleanup vs webhook send order","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-15T18:15:04.382357-07:00","updated_at":"2025-12-15T18:15:12.638048-07:00","closed_at":"2025-12-15T18:15:12.638048-07:00","dependencies":[{"issue_id":"cog-egj","depends_on_id":"cog-77g","type":"discovered-from","created_at":"2025-12-15T18:15:04.383214-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-f0d","title":"Add SSRF protection for HTTP requests in coglet","description":"Add defense-in-depth for HTTP requests in coglet to prevent SSRF attacks.\n\n## Background\nCodeQL flagged SSRF vulnerabilities in coglet:\n- coglet/internal/runner/procedure.go:79 - http.Get(srcURL) for procedure source downloads\n- coglet/internal/webhook/webhook.go:57 - s.client.Do(req) for webhook delivery\n\nThese URLs come from Replicate's control plane (trusted), but defense-in-depth is good practice.\n\n## Options to consider\n1. Block internal/private IPs (RFC1918, localhost, link-local)\n2. Scheme validation (already have http/https for procedures)\n3. Custom http.Transport with DialContext validation\n4. Host allowlist (configurable)\n\n## References\n- OWASP SSRF Prevention: https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html\n\n## Files\n- coglet/internal/runner/procedure.go\n- coglet/internal/webhook/webhook.go","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T14:25:10.441231-07:00","updated_at":"2025-12-16T16:38:31.341479-07:00","closed_at":"2025-12-16T16:38:31.341479-07:00"}
{"id":"cog-f3a","title":"Verify existing cog tests still pass","description":"After all code moves, verify existing cog tests still pass:\n- make test-go\n- make test-python\n- make test-integration\n\nThe coglet integration should not break any existing functionality.\n\nDepends on: cog-1ys (Makefile integration)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:13:11.56625-07:00","updated_at":"2025-12-15T16:15:49.77907-07:00","closed_at":"2025-12-15T16:15:49.77907-07:00","dependencies":[{"issue_id":"cog-f3a","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:13:11.566751-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-fuo","title":"Build API Encapsulation: Model, Resolver, Factory Architecture","description":"## Overview\n\nRefactor Cog's build and image access code to create clean abstractions that:\n1. Encapsulate all build complexity behind a `Factory` interface\n2. Provide uniform access to models via `Resolver`\n3. Enable pluggable build backends (Dockerfile, BuildKit frontend, cogpacks)\n4. Validate and parse image refs early using go-containerregistry/pkg/name\n\n## Architecture\n\n```\n                         CLI / Commands\n                              │\n                              ▼\n                    ┌───────────────────┐\n                    │     Resolver      │  ← Orchestration layer\n                    │                   │\n                    │ .Resolve(ref)     │  ← Load or Build based on Ref type\n                    │ .Build(src, opts) │  ← Calls Factory\n                    │ .LoadLocal()      │  ← Direct docker daemon access\n                    │ .LoadRemote()     │  ← Direct registry access\n                    └───────────────────┘\n                              │\n                              │ Build()\n                              ▼\n                    ┌───────────────────┐\n                    │     Factory       │  ← Build backend interface\n                    └───────────────────┘\n                              │\n            ┌─────────────────┼─────────────────┐\n            ▼                 ▼                 ▼\n    DockerfileFactory   FrontendFactory   CogpacksFactory\n       (current)          (future)          (future)\n```\n\n## Key Types\n\n- **ParsedRef**: Validated image reference with structured fields (using go-containerregistry/pkg/name)\n- **Ref**: Interface for things that can be resolved to a Model (FromTag, FromLocal, FromBuild)\n- **Image**: OCI image metadata (reference, digest, labels, source)\n- **Model**: Cog model extracted from Image (config, schema, runtime info)\n- **Source**: Project directory + cog.yaml\n- **BuildOptions**: All build flags consolidated (replaces 19-param image.Build)\n- **Factory**: Interface for build backends\n- **Resolver**: Orchestrates loading and building\n\n## Design Decisions\n\n1. **Resolver vs Factory separation**: Resolver orchestrates and extracts metadata; Factory only handles the build mechanics\n2. **Early ref validation**: ParseRef() validates image references immediately using go-containerregistry/pkg/name\n3. **Ref pattern**: Declarative - caller says \"what they have\" (FromTag, FromBuild), resolver figures out how to get Model\n4. **Factory interface**: Enables swapping build backends (Dockerfile→LLB) invisibly to callers\n5. **Model vs Image**: Image is OCI artifact; Model is Cog-specific metadata extracted from Image\n\n## Success Criteria\n\n- CLI commands use Resolver instead of calling image.Build() directly\n- Build backend can be swapped via env var (COG_BUILDER, COGPACK)\n- Image refs validated early with clear error messages\n- All existing tests pass\n- Zero changes to pkg/dockerfile/, pkg/docker/ internals (initially)\n\n## References\n\n- Previous planning: cog-u5c (BuildKit Frontend Architecture)\n- Cogpacks design: origin/md/cogpack branch\n- Related: pkg/web/client.go Version struct\n","status":"open","priority":1,"issue_type":"epic","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:04:48.695549-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T13:04:48.695549-07:00"}
{"id":"cog-fuo.1","title":"Phase 1.1: Create pkg/model/ref.go with ParsedRef and ref parsing","description":"## Summary\n\nCreate the ref parsing foundation using go-containerregistry/pkg/name for early validation and structured access to image reference components.\n\n## File to Create\n\n`pkg/model/ref.go`\n\n## Implementation\n\n```go\npackage model\n\nimport (\n    \"fmt\"\n    \n    \"github.com/google/go-containerregistry/pkg/name\"\n    \"github.com/replicate/cog/pkg/global\"\n)\n\n// ParsedRef wraps a validated and parsed image reference\ntype ParsedRef struct {\n    Original    string         // Original input string\n    Ref         name.Reference // Parsed reference\n    Registry    string         // e.g., \"r8.im\", \"index.docker.io\"\n    Repository  string         // e.g., \"user/model\"\n    Tag         string         // e.g., \"v1\" (empty if digest)\n    Digest      string         // e.g., \"sha256:...\" (empty if tag)\n    IsReplicate bool           // Is this r8.im?\n}\n\n// ParseRef validates and parses an image reference\nfunc ParseRef(ref string) (*ParsedRef, error) {\n    parsed, err := name.ParseReference(ref)\n    if err != nil {\n        return nil, fmt.Errorf(\"invalid image reference %q: %w\", ref, err)\n    }\n    \n    registry := parsed.Context().RegistryStr()\n    \n    return \u0026ParsedRef{\n        Original:    ref,\n        Ref:         parsed,\n        Registry:    registry,\n        Repository:  parsed.Context().RepositoryStr(),\n        Tag:         tagOrEmpty(parsed),\n        Digest:      digestOrEmpty(parsed),\n        IsReplicate: registry == global.ReplicateRegistryHost,\n    }, nil\n}\n\nfunc (p *ParsedRef) String() string { return p.Ref.String() }\nfunc (p *ParsedRef) IsTag() bool    { return p.Tag != \"\" }\nfunc (p *ParsedRef) IsDigest() bool { return p.Digest != \"\" }\n\nfunc tagOrEmpty(ref name.Reference) string {\n    if t, ok := ref.(name.Tag); ok {\n        return t.TagStr()\n    }\n    return \"\"\n}\n\nfunc digestOrEmpty(ref name.Reference) string {\n    if d, ok := ref.(name.Digest); ok {\n        return d.DigestStr()\n    }\n    return \"\"\n}\n```\n\n## Acceptance Criteria\n\n- [ ] ParseRef validates refs using go-containerregistry/pkg/name\n- [ ] ParsedRef exposes Registry, Repository, Tag, Digest fields\n- [ ] Invalid refs return clear error messages\n- [ ] Unit tests for common ref formats (tag, digest, with/without registry)\n- [ ] Unit tests for Replicate registry detection\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:05:03.741663-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T13:24:03.367761-07:00","closed_at":"2026-01-23T13:24:03.367761-07:00","close_reason":"Implemented pkg/model/ref.go with ParsedRef, ParseRef, and options (Insecure, WithDefaultRegistry, WithDefaultTag). All 16 tests passing.","dependencies":[{"issue_id":"cog-fuo.1","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:05:03.743975-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.10","title":"Phase 2.3: Migrate pkg/cli/predict.go to use Resolver","description":"## Summary\n\nRefactor predict.go to use Resolver for both build and load paths.\n\n## Changes\n\npredict.go has two code paths:\n1. Build from local project (no args)\n2. Load existing image (arg provided)\n\nBoth should use Resolver:\n\n```go\nvar m *model.Model\nvar err error\n\nif len(args) == 0 {\n    src, err := model.NewSource(configFilename)\n    if err != nil {\n        return err\n    }\n    m, err = resolver.Build(ctx, src, buildOptsFromFlags())\n} else {\n    ref, err := model.FromTag(args[0])\n    if err != nil {\n        return err  // Early validation!\n    }\n    m, err = resolver.Resolve(ctx, ref)\n}\nif err != nil {\n    return err\n}\n\n// Now use m uniformly for both paths\nif m.HasGPU() {\n    gpus = \"all\"\n}\nif m.IsFast() {\n    buildFast = true\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Both build and load paths use Resolver\n- [ ] FromTag validates ref format early\n- [ ] Model.HasGPU(), Model.IsFast() used instead of config access\n- [ ] All tests pass\n","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:06:36.260431-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:53:03.256272-07:00","closed_at":"2026-01-28T14:53:03.256272-07:00","close_reason":"Implemented in md/model-resolver branch","dependencies":[{"issue_id":"cog-fuo.10","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:06:36.260965-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.10","depends_on_id":"cog-fuo.8","type":"blocks","created_at":"2026-01-23T13:07:03.587201-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.11","title":"Phase 2.4: Migrate pkg/cli/run.go, serve.go, train.go to use Resolver","description":"## Summary\n\nRefactor remaining CLI commands to use Resolver.\n\n## Files\n\n- **run.go** - uses image.Build() and image.BuildBase()\n- **serve.go** - uses image.BuildBase()  \n- **train.go** - similar pattern to predict.go\n\n## Notes\n\nMay need to add Resolver.BuildBase() for dev mode builds that don't copy /src.\n\n## Acceptance Criteria\n\n- [ ] All commands use Resolver\n- [ ] BuildBase use cases handled\n- [ ] All tests pass\n","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:06:36.399489-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:53:03.258066-07:00","closed_at":"2026-01-28T14:53:03.258066-07:00","close_reason":"Implemented in md/model-resolver branch","dependencies":[{"issue_id":"cog-fuo.11","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:06:36.400047-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.11","depends_on_id":"cog-fuo.8","type":"blocks","created_at":"2026-01-23T13:07:03.700183-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.12","title":"Phase 3.1: Add comprehensive unit tests for pkg/model/","description":"## Summary\n\nAdd unit tests for all pkg/model/ types and functions.\n\n## Test Files\n\n- `pkg/model/ref_test.go` - ParseRef tests\n- `pkg/model/model_test.go` - Model methods\n- `pkg/model/resolver_test.go` - Resolver with mocks\n- `pkg/model/factory_test.go` - Factory interface\n\n## Acceptance Criteria\n\n- [ ] \u003e80% test coverage for pkg/model/\n- [ ] Tests use mocked docker/registry clients\n- [ ] Edge cases covered (invalid refs, missing labels, etc.)\n","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:06:54.838132-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:53:03.259955-07:00","closed_at":"2026-01-28T14:53:03.259955-07:00","close_reason":"Implemented in md/model-resolver branch","dependencies":[{"issue_id":"cog-fuo.12","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:06:54.840352-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.12","depends_on_id":"cog-fuo.6","type":"blocks","created_at":"2026-01-23T13:07:05.017228-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.13","title":"Phase 3.2: Deprecate direct image.Build() calls","description":"## Summary\n\nAfter all CLI commands use Resolver, mark image.Build() as deprecated or make it internal.\n\n## Options\n\n1. Add deprecation comment and point to model.Resolver\n2. Move to internal package  \n3. Keep as-is but document that Resolver is preferred\n\n## Acceptance Criteria\n\n- [ ] Decision made on deprecation approach\n- [ ] Documentation updated\n- [ ] No direct image.Build() calls from CLI packages\n","status":"open","priority":3,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:06:54.989955-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T13:06:54.989955-07:00","dependencies":[{"issue_id":"cog-fuo.13","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:06:54.990579-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.13","depends_on_id":"cog-fuo.9","type":"blocks","created_at":"2026-01-23T13:07:05.1439-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.13","depends_on_id":"cog-fuo.10","type":"blocks","created_at":"2026-01-23T13:07:05.260936-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.13","depends_on_id":"cog-fuo.11","type":"blocks","created_at":"2026-01-23T13:07:05.368253-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.14","title":"Future: Implement FrontendFactory for BuildKit frontend","description":"## Summary\n\nImplement FrontendFactory that uses BuildKit frontend instead of generating Dockerfiles in-process.\n\n## Implementation\n\n```go\ntype FrontendFactory struct {\n    docker        command.Command\n    frontendImage string\n}\n\nfunc NewFrontendFactory(docker command.Command, frontendImage string) Factory {\n    return \u0026FrontendFactory{docker: docker, frontendImage: frontendImage}\n}\n\nfunc (f *FrontendFactory) Build(ctx context.Context, src *Source, opts BuildOptions) (*Image, error) {\n    // Use docker.BuildWithFrontend()\n}\n```\n\n## Depends On\n\n- cog-u5c (BuildKit Frontend Architecture) work  \n- pkg/model/ foundation complete\n\n## Acceptance Criteria\n\n- [ ] FrontendFactory implements Factory interface\n- [ ] Enabled via COG_BUILDER env var\n- [ ] Produces identical images to DockerfileFactory\n","status":"open","priority":4,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:06:55.132287-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T13:06:55.132287-07:00","dependencies":[{"issue_id":"cog-fuo.14","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:06:55.132804-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.14","depends_on_id":"cog-fuo.13","type":"blocks","created_at":"2026-01-23T13:07:05.482843-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.15","title":"Future: Implement CogpacksFactory for LLB-based builds","description":"## Summary\n\nImplement CogpacksFactory that uses the cogpacks Stack/Block/Plan architecture.\n\n## Implementation\n\n```go\ntype CogpacksFactory struct {\n    docker   command.Command\n    registry registry.Client\n}\n\nfunc (f *CogpacksFactory) Build(ctx context.Context, src *Source, opts BuildOptions) (*Image, error) {\n    // Use cogpack.GeneratePlan() + cogpack.RunBuildPlan()\n}\n```\n\n## Depends On\n\n- origin/md/cogpack branch work\n- pkg/model/ foundation complete\n\n## Acceptance Criteria\n\n- [ ] CogpacksFactory implements Factory interface\n- [ ] Enabled via COGPACK=1 env var\n- [ ] Uses LLB instead of Dockerfile generation\n","status":"open","priority":4,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:06:55.27598-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T13:06:55.27598-07:00","dependencies":[{"issue_id":"cog-fuo.15","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:06:55.276541-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.15","depends_on_id":"cog-fuo.13","type":"blocks","created_at":"2026-01-23T13:07:05.582805-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.16","title":"Add parsed accessors for Image labels (OpenAPISchema, Config)","description":"## Summary\n\nAdd methods to Image that return parsed/structured data instead of raw strings:\n\n- `ParsedOpenAPISchema() (*openapi.Spec, error)` - parse the OpenAPI JSON into a structured type\n- `ParsedConfig() (*config.Config, error)` - parse the cog.yaml JSON into the existing config type\n\nKeep the current raw string accessors (`OpenAPISchema()`, `Config()`) for cases where parsing isn't needed.\n\n## Why\n\nRaw strings require callers to handle parsing themselves. Providing parsed accessors:\n- Reduces boilerplate in callers\n- Centralizes parsing logic and error handling\n- Enables richer type-safe access to model metadata\n\n## Blocked By\n\nThis can be done after the core Resolver/Factory architecture is in place.","status":"closed","priority":3,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T15:17:04.340323-07:00","created_by":"Michael Dwan","updated_at":"2026-01-29T13:44:46.868525-07:00","closed_at":"2026-01-29T13:44:46.868525-07:00","close_reason":"Implemented ParsedConfig(), ParsedOpenAPISchema(), and ToModel() on Image","dependencies":[{"issue_id":"cog-fuo.16","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T15:17:04.344005-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.2","title":"Phase 1.2: Create pkg/model/image.go with Image struct","description":"## Summary\n\nCreate the Image struct representing an OCI image with Cog-specific helpers.\n\n## File to Create\n\n`pkg/model/image.go`\n\n## Implementation\n\n```go\npackage model\n\nimport \"github.com/replicate/cog/pkg/global\"\n\n// ImageSource indicates where an image was loaded from\ntype ImageSource string\n\nconst (\n    ImageSourceLocal  ImageSource = \"local\"  // Docker daemon\n    ImageSourceRemote ImageSource = \"remote\" // Registry\n    ImageSourceBuild  ImageSource = \"build\"  // Just built\n)\n\n// Image represents an OCI image that may contain a Cog model\ntype Image struct {\n    Reference string            // Full image reference\n    Digest    string            // Content-addressable digest\n    Labels    map[string]string // Image labels\n    Platform  *Platform         // os/arch\n    Source    ImageSource       // Where loaded from\n}\n\ntype Platform struct {\n    OS           string\n    Architecture string\n}\n\n// Label keys\nconst (\n    CogConfigLabelKey        = global.LabelNamespace + \"config\"\n    CogVersionLabelKey       = global.LabelNamespace + \"version\"\n    CogOpenAPISchemaLabelKey = global.LabelNamespace + \"openapi_schema\"\n)\n\n// IsCogModel returns true if this image has Cog labels\nfunc (i *Image) IsCogModel() bool {\n    if i.Labels == nil {\n        return false\n    }\n    _, ok := i.Labels[CogConfigLabelKey]\n    return ok\n}\n\n// CogVersion returns the cog version that built this image\nfunc (i *Image) CogVersion() string {\n    if i.Labels == nil {\n        return \"\"\n    }\n    return i.Labels[CogVersionLabelKey]\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Image struct captures reference, digest, labels, platform, source\n- [ ] IsCogModel() checks for cog labels\n- [ ] Label constants defined (using global.LabelNamespace)\n- [ ] Unit tests for IsCogModel() and helper methods\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:05:10.7454-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T16:00:09.254847-07:00","closed_at":"2026-01-23T16:00:09.254847-07:00","close_reason":"Implemented Image struct with IsCogModel(), CogVersion(), Config(), OpenAPISchema() helpers and full test coverage","dependencies":[{"issue_id":"cog-fuo.2","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:05:10.747842-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.3","title":"Phase 1.3: Create pkg/model/model.go with Model struct","description":"## Summary\n\nCreate the Model struct representing a Cog model with all its metadata.\n\n## File to Create\n\n`pkg/model/model.go`\n\n## Implementation\n\n```go\npackage model\n\nimport (\n    \"encoding/json\"\n    \n    \"github.com/getkin/kin-openapi/openapi3\"\n    \"github.com/replicate/cog/pkg/config\"\n)\n\n// Model represents a Cog model extracted from an Image\ntype Model struct {\n    Image      *Image           // Underlying OCI image\n    Config     *config.Config   // Parsed cog.yaml\n    Schema     *openapi3.T      // OpenAPI schema\n    CogVersion string           // Version of cog used to build\n    Weights    *WeightsManifest // Weight file info (optional)\n    Runtime    *RuntimeConfig   // Runtime env config\n    GitCommit  string           // Git commit (if available)\n    GitTag     string           // Git tag (if available)\n}\n\n// RuntimeConfig holds runtime environment info\ntype RuntimeConfig struct {\n    GPU           bool\n    CudaVersion   string\n    CudnnVersion  string\n    PythonVersion string\n    TorchVersion  string\n    Env           map[string]string\n}\n\n// WeightsManifest describes model weights\ntype WeightsManifest struct {\n    Files []WeightFile\n}\n\ntype WeightFile struct {\n    Path   string\n    Digest string\n    Size   int64\n    URL    string // For external weights\n}\n\n// Convenience methods\nfunc (m *Model) HasGPU() bool {\n    return m.Config != nil \u0026\u0026 m.Config.Build.GPU\n}\n\nfunc (m *Model) IsFast() bool {\n    return m.Config != nil \u0026\u0026 m.Config.Build.Fast\n}\n\nfunc (m *Model) SchemaJSON() ([]byte, error) {\n    if m.Schema == nil {\n        return nil, nil\n    }\n    return json.Marshal(m.Schema)\n}\n\n// ImageRef returns the image reference string\nfunc (m *Model) ImageRef() string {\n    if m.Image == nil {\n        return \"\"\n    }\n    return m.Image.Reference\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Model struct holds Image, Config, Schema, CogVersion, etc.\n- [ ] RuntimeConfig and WeightsManifest defined\n- [ ] Convenience methods: HasGPU(), IsFast(), SchemaJSON(), ImageRef()\n- [ ] Unit tests for Model methods\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:05:18.945687-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T16:05:43.223847-07:00","closed_at":"2026-01-23T16:05:43.223847-07:00","close_reason":"Created Model struct with RuntimeConfig, WeightsManifest types and convenience methods (HasGPU, IsFast, SchemaJSON, ImageRef) with full test coverage","dependencies":[{"issue_id":"cog-fuo.3","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:05:18.9481-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.4","title":"Phase 1.4: Create pkg/model/source.go and options.go","description":"## Summary\n\nCreate Source (project to be built) and BuildOptions (consolidated flags).\n\n## Files to Create\n\n`pkg/model/source.go` and `pkg/model/options.go`\n\n## Implementation\n\n### source.go\n```go\npackage model\n\nimport \"github.com/replicate/cog/pkg/config\"\n\n// Source represents a cog project ready to build\ntype Source struct {\n    Config     *config.Config\n    ProjectDir string\n}\n\n// NewSource loads config from path and returns Source\nfunc NewSource(configPath string) (*Source, error) {\n    cfg, dir, err := config.GetConfig(configPath)\n    if err != nil {\n        return nil, err\n    }\n    return \u0026Source{Config: cfg, ProjectDir: dir}, nil\n}\n\n// NewSourceFromConfig creates Source from existing config\nfunc NewSourceFromConfig(cfg *config.Config, projectDir string) *Source {\n    return \u0026Source{Config: cfg, ProjectDir: projectDir}\n}\n```\n\n### options.go\n```go\npackage model\n\nimport \"github.com/replicate/cog/pkg/config\"\n\n// BuildOptions contains all settings for building an image\ntype BuildOptions struct {\n    ImageName        string            // Required: output image name\n    NoCache          bool              // Disable build cache\n    SeparateWeights  bool              // Build weights as separate layer\n    Fast             bool              // Use fast/monobase build\n    Strip            bool              // Strip debug symbols\n    Precompile       bool              // Precompile Python\n    LocalImage       bool              // Local-only image\n    PipelinesImage   bool              // Pipeline/Workflow image\n    UseCudaBaseImage string            // \"auto\", \"true\", \"false\"\n    UseCogBaseImage  *bool             // nil = auto\n    Secrets          []string          // Build secrets\n    ProgressOutput   string            // \"auto\", \"plain\", \"tty\"\n    Annotations      map[string]string // Extra labels\n    SchemaFile       string            // Custom schema file\n    DockerfileFile   string            // Custom Dockerfile\n}\n\n// WithDefaults fills in defaults from Source\nfunc (o BuildOptions) WithDefaults(src *Source) BuildOptions {\n    if o.ImageName == \"\" {\n        o.ImageName = config.DockerImageName(src.ProjectDir)\n    }\n    if o.ProgressOutput == \"\" {\n        o.ProgressOutput = \"auto\"\n    }\n    // Apply fast from config if not set via flag\n    if src.Config.Build.Fast \u0026\u0026 !o.Fast {\n        o.Fast = true\n    }\n    return o\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Source wraps config + projectDir\n- [ ] NewSource loads from config path\n- [ ] BuildOptions consolidates all 19 build flags\n- [ ] WithDefaults applies sensible defaults\n- [ ] Unit tests\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:05:29.580542-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T16:27:37.031321-07:00","closed_at":"2026-01-23T16:27:37.031321-07:00","close_reason":"Implemented Source and BuildOptions types with unit tests","dependencies":[{"issue_id":"cog-fuo.4","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:05:29.58276-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.5","title":"Phase 1.5: Create pkg/model/factory.go with Factory interface and DockerfileFactory","description":"## Summary\n\nCreate the Factory interface and initial DockerfileFactory implementation that wraps existing image.Build() code.\n\n## File to Create\n\n`pkg/model/factory.go`\n\n## Implementation\n\n```go\npackage model\n\nimport (\n    \"context\"\n    \"os\"\n    \n    \"github.com/replicate/cog/pkg/docker/command\"\n    \"github.com/replicate/cog/pkg/image\"\n    \"github.com/replicate/cog/pkg/registry\"\n)\n\n// Factory is the build backend interface.\n// Different implementations handle different build strategies.\ntype Factory interface {\n    // Build creates a Docker image from source and returns Image metadata.\n    Build(ctx context.Context, src *Source, opts BuildOptions) (*Image, error)\n    \n    // Name returns the factory name for logging/debugging\n    Name() string\n}\n\n// DockerfileFactory wraps existing Dockerfile-based build\ntype DockerfileFactory struct {\n    docker   command.Command\n    registry registry.Client\n}\n\nfunc NewDockerfileFactory(docker command.Command, registry registry.Client) Factory {\n    return \u0026DockerfileFactory{docker: docker, registry: registry}\n}\n\nfunc (f *DockerfileFactory) Name() string { return \"dockerfile\" }\n\nfunc (f *DockerfileFactory) Build(ctx context.Context, src *Source, opts BuildOptions) (*Image, error) {\n    // Delegate to existing image.Build()\n    err := image.Build(\n        ctx,\n        src.Config,\n        src.ProjectDir,\n        opts.ImageName,\n        opts.Secrets,\n        opts.NoCache,\n        opts.SeparateWeights,\n        opts.UseCudaBaseImage,\n        opts.ProgressOutput,\n        opts.SchemaFile,\n        opts.DockerfileFile,\n        opts.UseCogBaseImage,\n        opts.Strip,\n        opts.Precompile,\n        opts.Fast,\n        opts.Annotations,\n        opts.LocalImage,\n        f.docker,\n        f.registry,\n        opts.PipelinesImage,\n    )\n    if err != nil {\n        return nil, err\n    }\n    \n    return \u0026Image{\n        Reference: opts.ImageName,\n        Source:    ImageSourceBuild,\n    }, nil\n}\n\n// DefaultFactory returns factory based on env vars\nfunc DefaultFactory(docker command.Command, registry registry.Client) Factory {\n    if frontendImage := os.Getenv(\"COG_BUILDER\"); frontendImage != \"\" {\n        // TODO: return FrontendFactory when implemented\n        // For now, fall through to dockerfile\n    }\n    if os.Getenv(\"COGPACK\") == \"1\" {\n        // TODO: return CogpacksFactory when implemented\n    }\n    return NewDockerfileFactory(docker, registry)\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Factory interface defined with Build() and Name()\n- [ ] DockerfileFactory wraps existing image.Build()\n- [ ] DefaultFactory checks COG_BUILDER and COGPACK env vars\n- [ ] Unit tests with mock docker/registry\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:05:45.872152-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T17:13:53.309898-07:00","closed_at":"2026-01-23T17:13:53.309898-07:00","close_reason":"Implemented Factory interface and DockerfileFactory with unit tests","dependencies":[{"issue_id":"cog-fuo.5","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:05:45.874549-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.5","depends_on_id":"cog-fuo.2","type":"blocks","created_at":"2026-01-23T13:07:02.146206-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.5","depends_on_id":"cog-fuo.3","type":"blocks","created_at":"2026-01-23T13:07:02.265635-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.5","depends_on_id":"cog-fuo.4","type":"blocks","created_at":"2026-01-23T13:07:02.376265-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.6","title":"Phase 1.6: Create pkg/model/resolver.go with Resolver struct","description":"## Summary\n\nCreate the Resolver that orchestrates building and loading Models, with a unified `Load()` API using functional options.\n\n## Files to Create\n\n### `pkg/model/resolver.go`\n\n```go\npackage model\n\nimport (\n\t\"context\"\n\t\"encoding/json\"\n\t\"errors\"\n\t\"fmt\"\n\n\t\"github.com/docker/docker/api/types/image\"\n\t\"github.com/getkin/kin-openapi/openapi3\"\n\n\t\"github.com/replicate/cog/pkg/config\"\n\t\"github.com/replicate/cog/pkg/docker/command\"\n\t\"github.com/replicate/cog/pkg/registry\"\n)\n\n// LoadOption configures how Load resolves a model.\ntype LoadOption func(*loadOptions)\n\ntype loadOptions struct {\n\tlocalOnly   bool\n\tremoteOnly  bool\n\tpreferLocal bool // default: true\n\tplatform    *registry.Platform\n}\n\nfunc defaultLoadOptions() *loadOptions {\n\treturn \u0026loadOptions{preferLocal: true}\n}\n\n// LocalOnly loads only from the local docker daemon.\n// Returns an error if the image is not found locally.\nfunc LocalOnly() LoadOption {\n\treturn func(o *loadOptions) {\n\t\to.localOnly = true\n\t\to.remoteOnly = false\n\t\to.preferLocal = false\n\t}\n}\n\n// RemoteOnly loads only from the remote registry.\n// Does not check the local docker daemon.\nfunc RemoteOnly() LoadOption {\n\treturn func(o *loadOptions) {\n\t\to.remoteOnly = true\n\t\to.localOnly = false\n\t\to.preferLocal = false\n\t}\n}\n\n// PreferRemote tries remote registry first, falls back to local on not-found.\nfunc PreferRemote() LoadOption {\n\treturn func(o *loadOptions) {\n\t\to.preferLocal = false\n\t\to.localOnly = false\n\t\to.remoteOnly = false\n\t}\n}\n\n// WithPlatform sets the platform for remote registry queries.\nfunc WithPlatform(p *registry.Platform) LoadOption {\n\treturn func(o *loadOptions) {\n\t\to.platform = p\n\t}\n}\n\n// Resolver orchestrates building and loading Models.\ntype Resolver struct {\n\tdocker   command.Command\n\tregistry registry.Client\n\tfactory  Factory\n}\n\n// NewResolver creates a Resolver with the default factory.\nfunc NewResolver(docker command.Command, reg registry.Client) *Resolver {\n\treturn \u0026Resolver{\n\t\tdocker:   docker,\n\t\tregistry: reg,\n\t\tfactory:  DefaultFactory(docker, reg),\n\t}\n}\n\n// WithFactory sets a custom factory and returns the Resolver for chaining.\nfunc (r *Resolver) WithFactory(f Factory) *Resolver {\n\tr.factory = f\n\treturn r\n}\n\n// Load resolves a parsed ref to a Model.\n// By default (PreferLocal), tries local docker daemon first, then remote registry.\n// Only falls back on \"not found\" errors; real errors (docker down, auth) are surfaced.\nfunc (r *Resolver) Load(ctx context.Context, ref *ParsedRef, opts ...LoadOption) (*Model, error) {\n\to := defaultLoadOptions()\n\tfor _, opt := range opts {\n\t\topt(o)\n\t}\n\n\tswitch {\n\tcase o.localOnly:\n\t\treturn r.loadLocal(ctx, ref)\n\tcase o.remoteOnly:\n\t\treturn r.loadRemote(ctx, ref, o.platform)\n\tcase o.preferLocal:\n\t\tmodel, err := r.loadLocal(ctx, ref)\n\t\tif err == nil {\n\t\t\treturn model, nil\n\t\t}\n\t\tif !isNotFoundError(err) {\n\t\t\treturn nil, err // Real error, don't mask it\n\t\t}\n\t\treturn r.loadRemote(ctx, ref, o.platform)\n\tdefault:\n\t\t// PreferRemote\n\t\tmodel, err := r.loadRemote(ctx, ref, o.platform)\n\t\tif err == nil {\n\t\t\treturn model, nil\n\t\t}\n\t\tif !isNotFoundError(err) {\n\t\t\treturn nil, err\n\t\t}\n\t\treturn r.loadLocal(ctx, ref)\n\t}\n}\n\n// Build creates a Model by building from source.\nfunc (r *Resolver) Build(ctx context.Context, src *Source, opts BuildOptions) (*Model, error) {\n\topts = opts.WithDefaults(src)\n\n\timg, err := r.factory.Build(ctx, src, opts)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\t// Inspect the built image to get labels\n\tresp, err := r.docker.Inspect(ctx, img.Reference)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"failed to inspect built image: %w\", err)\n\t}\n\n\timg.Labels = resp.Config.Labels\n\timg.Digest = resp.ID\n\n\treturn r.modelFromImage(img, src.Config), nil\n}\n\n// loadLocal loads a Model from the local docker daemon.\nfunc (r *Resolver) loadLocal(ctx context.Context, ref *ParsedRef) (*Model, error) {\n\tresp, err := r.docker.Inspect(ctx, ref.String())\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"image %s not found locally: %w\", ref.Original, err)\n\t}\n\treturn r.modelFromInspect(ref, resp, ImageSourceLocal)\n}\n\n// loadRemote loads a Model from the remote registry.\nfunc (r *Resolver) loadRemote(ctx context.Context, ref *ParsedRef, platform *registry.Platform) (*Model, error) {\n\tmanifest, err := r.registry.Inspect(ctx, ref.String(), platform)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"image %s not found in registry: %w\", ref.Original, err)\n\t}\n\treturn r.modelFromManifest(ref, manifest, ImageSourceRemote)\n}\n\n// modelFromImage creates a Model from Image with a known config (post-build).\nfunc (r *Resolver) modelFromImage(img *Image, cfg *config.Config) *Model {\n\tvar schema *openapi3.T\n\tif schemaJSON := img.OpenAPISchema(); schemaJSON != \"\" {\n\t\tloader := openapi3.NewLoader()\n\t\tschema, _ = loader.LoadFromData([]byte(schemaJSON))\n\t}\n\n\treturn \u0026Model{\n\t\tImage:      img,\n\t\tConfig:     cfg,\n\t\tSchema:     schema,\n\t\tCogVersion: img.CogVersion(),\n\t}\n}\n\n// modelFromInspect creates a Model from docker inspect response.\nfunc (r *Resolver) modelFromInspect(ref *ParsedRef, resp *image.InspectResponse, source ImageSource) (*Model, error) {\n\timg := \u0026Image{\n\t\tReference: ref.String(),\n\t\tDigest:    resp.ID,\n\t\tLabels:    resp.Config.Labels,\n\t\tSource:    source,\n\t}\n\n\t// Parse config from labels\n\tvar cfg *config.Config\n\tif configJSON := img.Config(); configJSON != \"\" {\n\t\tcfg = new(config.Config)\n\t\tif err := json.Unmarshal([]byte(configJSON), cfg); err != nil {\n\t\t\treturn nil, fmt.Errorf(\"failed to parse cog config from labels: %w\", err)\n\t\t}\n\t}\n\n\t// Parse schema from labels\n\tvar schema *openapi3.T\n\tif schemaJSON := img.OpenAPISchema(); schemaJSON != \"\" {\n\t\tloader := openapi3.NewLoader()\n\t\tschema, _ = loader.LoadFromData([]byte(schemaJSON))\n\t}\n\n\treturn \u0026Model{\n\t\tImage:      img,\n\t\tConfig:     cfg,\n\t\tSchema:     schema,\n\t\tCogVersion: img.CogVersion(),\n\t}, nil\n}\n\n// modelFromManifest creates a Model from registry manifest.\nfunc (r *Resolver) modelFromManifest(ref *ParsedRef, manifest *registry.ManifestResult, source ImageSource) (*Model, error) {\n\t// Registry manifest has limited label info - primarily for existence checks\n\t// Full model metadata requires pulling the image\n\t// TODO: Extract labels from manifest if available in ManifestResult\n\treturn \u0026Model{\n\t\tImage: \u0026Image{\n\t\t\tReference: ref.String(),\n\t\t\tDigest:    manifest.Digest,\n\t\t\tSource:    source,\n\t\t},\n\t}, nil\n}\n\n// isNotFoundError checks if an error indicates \"not found\" vs a real error.\n// Only \"not found\" errors should trigger fallback to alternative source.\nfunc isNotFoundError(err error) bool {\n\tif err == nil {\n\t\treturn false\n\t}\n\t// Check for common not-found patterns\n\t// Docker daemon returns specific error types; adjust as needed\n\terrStr := err.Error()\n\treturn errors.Is(err, context.Canceled) == false \u0026\u0026\n\t\terrors.Is(err, context.DeadlineExceeded) == false \u0026\u0026\n\t\t(contains(errStr, \"not found\") ||\n\t\t\tcontains(errStr, \"No such image\") ||\n\t\t\tcontains(errStr, \"manifest unknown\") ||\n\t\t\tcontains(errStr, \"NAME_UNKNOWN\"))\n}\n\nfunc contains(s, substr string) bool {\n\treturn len(s) \u003e= len(substr) \u0026\u0026 (s == substr || len(s) \u003e 0 \u0026\u0026 containsImpl(s, substr))\n}\n\nfunc containsImpl(s, substr string) bool {\n\tfor i := 0; i \u003c= len(s)-len(substr); i++ {\n\t\tif s[i:i+len(substr)] == substr {\n\t\t\treturn true\n\t\t}\n\t}\n\treturn false\n}\n// NOTE: Use strings.Contains instead of the above - just use:\n// import \"strings\"\n// strings.Contains(errStr, \"not found\")\n```\n\n### `pkg/model/resolver_test.go`\n\n```go\npackage model\n\nimport (\n\t\"context\"\n\t\"errors\"\n\t\"testing\"\n\n\t\"github.com/docker/docker/api/types/container\"\n\t\"github.com/docker/docker/api/types/image\"\n\t\"github.com/stretchr/testify/require\"\n\n\t\"github.com/replicate/cog/pkg/docker/command\"\n\t\"github.com/replicate/cog/pkg/registry\"\n)\n\n// mockDocker implements command.Command for testing\ntype mockDocker struct {\n\tinspectFunc func(ctx context.Context, ref string) (*image.InspectResponse, error)\n}\n\nfunc (m *mockDocker) Inspect(ctx context.Context, ref string) (*image.InspectResponse, error) {\n\tif m.inspectFunc != nil {\n\t\treturn m.inspectFunc(ctx, ref)\n\t}\n\treturn nil, errors.New(\"not implemented\")\n}\n\n// Implement other command.Command methods as panics or no-ops\nfunc (m *mockDocker) Pull(ctx context.Context, ref string, force bool) (*image.InspectResponse, error) {\n\tpanic(\"not implemented\")\n}\nfunc (m *mockDocker) Push(ctx context.Context, ref string) error { panic(\"not implemented\") }\nfunc (m *mockDocker) LoadUserInformation(ctx context.Context, registryHost string) (*command.UserInfo, error) {\n\tpanic(\"not implemented\")\n}\nfunc (m *mockDocker) ImageExists(ctx context.Context, ref string) (bool, error) {\n\tpanic(\"not implemented\")\n}\nfunc (m *mockDocker) ContainerLogs(ctx context.Context, containerID string, w io.Writer) error {\n\tpanic(\"not implemented\")\n}\nfunc (m *mockDocker) ContainerInspect(ctx context.Context, id string) (*container.InspectResponse, error) {\n\tpanic(\"not implemented\")\n}\nfunc (m *mockDocker) ContainerStop(ctx context.Context, containerID string) error {\n\tpanic(\"not implemented\")\n}\nfunc (m *mockDocker) ImageBuild(ctx context.Context, options command.ImageBuildOptions) error {\n\tpanic(\"not implemented\")\n}\nfunc (m *mockDocker) Run(ctx context.Context, options command.RunOptions) error {\n\tpanic(\"not implemented\")\n}\nfunc (m *mockDocker) ContainerStart(ctx context.Context, options command.RunOptions) (string, error) {\n\tpanic(\"not implemented\")\n}\n\n// mockRegistry implements registry.Client for testing\ntype mockRegistry struct {\n\tinspectFunc func(ctx context.Context, ref string, platform *registry.Platform) (*registry.ManifestResult, error)\n}\n\nfunc (m *mockRegistry) Inspect(ctx context.Context, ref string, platform *registry.Platform) (*registry.ManifestResult, error) {\n\tif m.inspectFunc != nil {\n\t\treturn m.inspectFunc(ctx, ref, platform)\n\t}\n\treturn nil, errors.New(\"not implemented\")\n}\n\nfunc (m *mockRegistry) GetImage(ctx context.Context, ref string, platform *registry.Platform) (v1.Image, error) {\n\tpanic(\"not implemented\")\n}\n\nfunc (m *mockRegistry) Exists(ctx context.Context, ref string) (bool, error) {\n\tpanic(\"not implemented\")\n}\n\nfunc TestResolver_Load_LocalOnly_Found(t *testing.T) {\n\tdocker := \u0026mockDocker{\n\t\tinspectFunc: func(ctx context.Context, ref string) (*image.InspectResponse, error) {\n\t\t\treturn \u0026image.InspectResponse{\n\t\t\t\tID: \"sha256:abc123\",\n\t\t\t\tConfig: \u0026container.Config{\n\t\t\t\t\tLabels: map[string]string{\n\t\t\t\t\t\tLabelConfig:  `{\"build\":{\"python_version\":\"3.11\"}}`,\n\t\t\t\t\t\tLabelVersion: \"0.10.0\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t}, nil\n\t\t},\n\t}\n\treg := \u0026mockRegistry{}\n\n\tresolver := NewResolver(docker, reg)\n\tref, _ := ParseRef(\"my-image:latest\")\n\n\tmodel, err := resolver.Load(context.Background(), ref, LocalOnly())\n\n\trequire.NoError(t, err)\n\trequire.NotNil(t, model)\n\trequire.Equal(t, ImageSourceLocal, model.Image.Source)\n\trequire.Equal(t, \"0.10.0\", model.CogVersion)\n}\n\nfunc TestResolver_Load_LocalOnly_NotFound(t *testing.T) {\n\tdocker := \u0026mockDocker{\n\t\tinspectFunc: func(ctx context.Context, ref string) (*image.InspectResponse, error) {\n\t\t\treturn nil, errors.New(\"No such image: my-image:latest\")\n\t\t},\n\t}\n\treg := \u0026mockRegistry{\n\t\tinspectFunc: func(ctx context.Context, ref string, platform *registry.Platform) (*registry.ManifestResult, error) {\n\t\t\treturn \u0026registry.ManifestResult{Digest: \"sha256:remote\"}, nil\n\t\t},\n\t}\n\n\tresolver := NewResolver(docker, reg)\n\tref, _ := ParseRef(\"my-image:latest\")\n\n\t_, err := resolver.Load(context.Background(), ref, LocalOnly())\n\n\trequire.Error(t, err)\n\trequire.Contains(t, err.Error(), \"not found locally\")\n}\n\nfunc TestResolver_Load_RemoteOnly(t *testing.T) {\n\tdocker := \u0026mockDocker{\n\t\tinspectFunc: func(ctx context.Context, ref string) (*image.InspectResponse, error) {\n\t\t\tt.Fatal(\"should not call docker.Inspect when RemoteOnly\")\n\t\t\treturn nil, nil\n\t\t},\n\t}\n\treg := \u0026mockRegistry{\n\t\tinspectFunc: func(ctx context.Context, ref string, platform *registry.Platform) (*registry.ManifestResult, error) {\n\t\t\treturn \u0026registry.ManifestResult{Digest: \"sha256:remote123\"}, nil\n\t\t},\n\t}\n\n\tresolver := NewResolver(docker, reg)\n\tref, _ := ParseRef(\"r8.im/user/model\")\n\n\tmodel, err := resolver.Load(context.Background(), ref, RemoteOnly())\n\n\trequire.NoError(t, err)\n\trequire.NotNil(t, model)\n\trequire.Equal(t, ImageSourceRemote, model.Image.Source)\n}\n\nfunc TestResolver_Load_PreferLocal_Fallback(t *testing.T) {\n\tlocalCalled := false\n\tremoteCalled := false\n\n\tdocker := \u0026mockDocker{\n\t\tinspectFunc: func(ctx context.Context, ref string) (*image.InspectResponse, error) {\n\t\t\tlocalCalled = true\n\t\t\treturn nil, errors.New(\"No such image\")\n\t\t},\n\t}\n\treg := \u0026mockRegistry{\n\t\tinspectFunc: func(ctx context.Context, ref string, platform *registry.Platform) (*registry.ManifestResult, error) {\n\t\t\tremoteCalled = true\n\t\t\treturn \u0026registry.ManifestResult{Digest: \"sha256:remote\"}, nil\n\t\t},\n\t}\n\n\tresolver := NewResolver(docker, reg)\n\tref, _ := ParseRef(\"my-image:latest\")\n\n\tmodel, err := resolver.Load(context.Background(), ref) // default is PreferLocal\n\n\trequire.NoError(t, err)\n\trequire.True(t, localCalled, \"should try local first\")\n\trequire.True(t, remoteCalled, \"should fall back to remote\")\n\trequire.Equal(t, ImageSourceRemote, model.Image.Source)\n}\n\nfunc TestResolver_Load_PreferLocal_NoFallbackOnRealError(t *testing.T) {\n\tdocker := \u0026mockDocker{\n\t\tinspectFunc: func(ctx context.Context, ref string) (*image.InspectResponse, error) {\n\t\t\treturn nil, errors.New(\"connection refused\") // Real error, not \"not found\"\n\t\t},\n\t}\n\treg := \u0026mockRegistry{\n\t\tinspectFunc: func(ctx context.Context, ref string, platform *registry.Platform) (*registry.ManifestResult, error) {\n\t\t\tt.Fatal(\"should not fall back to remote on real error\")\n\t\t\treturn nil, nil\n\t\t},\n\t}\n\n\tresolver := NewResolver(docker, reg)\n\tref, _ := ParseRef(\"my-image:latest\")\n\n\t_, err := resolver.Load(context.Background(), ref)\n\n\trequire.Error(t, err)\n\trequire.Contains(t, err.Error(), \"connection refused\")\n}\n\nfunc TestResolver_Load_WithPlatform(t *testing.T) {\n\tvar capturedPlatform *registry.Platform\n\n\treg := \u0026mockRegistry{\n\t\tinspectFunc: func(ctx context.Context, ref string, platform *registry.Platform) (*registry.ManifestResult, error) {\n\t\t\tcapturedPlatform = platform\n\t\t\treturn \u0026registry.ManifestResult{Digest: \"sha256:abc\"}, nil\n\t\t},\n\t}\n\n\tresolver := NewResolver(\u0026mockDocker{}, reg)\n\tref, _ := ParseRef(\"my-image\")\n\n\tplatform := \u0026registry.Platform{OS: \"linux\", Architecture: \"amd64\"}\n\t_, _ = resolver.Load(context.Background(), ref, RemoteOnly(), WithPlatform(platform))\n\n\trequire.NotNil(t, capturedPlatform)\n\trequire.Equal(t, \"linux\", capturedPlatform.OS)\n\trequire.Equal(t, \"amd64\", capturedPlatform.Architecture)\n}\n\nfunc TestResolver_WithFactory(t *testing.T) {\n\tdocker := \u0026mockDocker{}\n\treg := \u0026mockRegistry{}\n\n\tresolver := NewResolver(docker, reg)\n\trequire.Equal(t, \"dockerfile\", resolver.factory.Name())\n\n\tmockFactory := \u0026mockFactory{name: \"custom\"}\n\tresolver.WithFactory(mockFactory)\n\trequire.Equal(t, \"custom\", resolver.factory.Name())\n}\n\ntype mockFactory struct {\n\tname string\n}\n\nfunc (f *mockFactory) Build(ctx context.Context, src *Source, opts BuildOptions) (*Image, error) {\n\treturn \u0026Image{Reference: opts.ImageName, Source: ImageSourceBuild}, nil\n}\n\nfunc (f *mockFactory) Name() string {\n\treturn f.name\n}\n```\n\n## Acceptance Criteria\n\n- [x] Resolver struct with docker, registry, factory fields\n- [x] NewResolver(docker, registry) uses DefaultFactory\n- [x] WithFactory(f) allows custom factory injection\n- [x] Load(ctx, ref, ...opts) with LoadOption pattern\n- [x] LocalOnly(), RemoteOnly(), PreferRemote(), WithPlatform() options\n- [x] Default behavior: PreferLocal (try local, fall back to remote on not-found only)\n- [x] Real errors (connection refused, auth) are NOT masked by fallback\n- [x] Build(ctx, src, opts) calls factory, inspects result, returns Model\n- [x] Config and Schema parsed from image labels\n- [x] Unit tests with mocked docker/registry\n\n## Dependencies\n\n- Uses existing `LabelConfig`, `LabelVersion`, `LabelOpenAPISchema` from image.go\n- Uses existing `command.Command` and `registry.Client` interfaces\n- Uses Factory interface from factory.go\n- Uses ParsedRef from ref.go\n- Uses Source, BuildOptions from source.go, options.go\n- Uses Model, Image from model.go, image.go\n\n## Notes\n\n- `isNotFoundError()` is a heuristic - may need adjustment based on actual error patterns from docker/registry\n- `modelFromManifest()` is minimal - registry manifest inspection may not have full label data\n- Use `strings.Contains` instead of custom contains implementation (the description shows both for clarity)\n- Run `make wheel \u0026\u0026 go generate ./pkg/wheels/...` before running tests if needed","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:06:02.695818-07:00","created_by":"Michael Dwan","updated_at":"2026-01-26T11:30:03.944902-07:00","closed_at":"2026-01-26T11:30:03.944902-07:00","close_reason":"Implemented pkg/model/resolver.go with Resolver struct, Load() API with functional options (LocalOnly, RemoteOnly, PreferRemote, WithPlatform), and Build() method. Added comprehensive tests in resolver_test.go.","dependencies":[{"issue_id":"cog-fuo.6","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:06:02.698504-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.6","depends_on_id":"cog-fuo.1","type":"blocks","created_at":"2026-01-23T13:07:02.495891-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.6","depends_on_id":"cog-fuo.5","type":"blocks","created_at":"2026-01-23T13:07:02.608055-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.7","title":"Phase 1.7: Create pkg/model/ref_types.go with Ref interface and FromTag, FromLocal, FromBuild","description":"## Summary\n\nCreate the Ref interface and concrete types for declarative model resolution.\n\n## File to Create\n\n`pkg/model/ref_types.go`\n\n## Implementation\n\n```go\npackage model\n\nimport \"context\"\n\n// Ref represents something that can be resolved to a Model\ntype Ref interface {\n    resolve(ctx context.Context, r *Resolver) (*Model, error)\n}\n\n// Resolve resolves any Ref to a Model\nfunc (r *Resolver) Resolve(ctx context.Context, ref Ref) (*Model, error) {\n    return ref.resolve(ctx, r)\n}\n\n// TagRef resolves an image by tag/digest, trying local then remote\ntype TagRef struct {\n    Parsed *ParsedRef\n}\n\n// FromTag parses a tag reference (validates early)\nfunc FromTag(ref string) (*TagRef, error) {\n    parsed, err := ParseRef(ref)\n    if err != nil {\n        return nil, err\n    }\n    return \u0026TagRef{Parsed: parsed}, nil\n}\n\nfunc (t *TagRef) resolve(ctx context.Context, r *Resolver) (*Model, error) {\n    return r.Load(ctx, t.Parsed)\n}\n\n// LocalRef explicitly loads from docker daemon only\ntype LocalRef struct {\n    Parsed *ParsedRef\n}\n\nfunc FromLocal(ref string) (*LocalRef, error) {\n    parsed, err := ParseRef(ref)\n    if err != nil {\n        return nil, err\n    }\n    return \u0026LocalRef{Parsed: parsed}, nil\n}\n\nfunc (l *LocalRef) resolve(ctx context.Context, r *Resolver) (*Model, error) {\n    return r.LoadLocal(ctx, l.Parsed)\n}\n\n// RemoteRef explicitly loads from registry only\ntype RemoteRef struct {\n    Parsed *ParsedRef\n}\n\nfunc FromRemote(ref string) (*RemoteRef, error) {\n    parsed, err := ParseRef(ref)\n    if err != nil {\n        return nil, err\n    }\n    return \u0026RemoteRef{Parsed: parsed}, nil\n}\n\nfunc (rr *RemoteRef) resolve(ctx context.Context, r *Resolver) (*Model, error) {\n    return r.LoadRemote(ctx, rr.Parsed)\n}\n\n// BuildRef creates a Model by building from source\ntype BuildRef struct {\n    Source  *Source\n    Options BuildOptions\n}\n\nfunc FromBuild(src *Source, opts BuildOptions) *BuildRef {\n    return \u0026BuildRef{Source: src, Options: opts}\n}\n\nfunc (b *BuildRef) resolve(ctx context.Context, r *Resolver) (*Model, error) {\n    return r.Build(ctx, b.Source, b.Options)\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Ref interface defined (lowercase resolve method - internal)\n- [ ] FromTag, FromLocal, FromRemote parse and validate refs\n- [ ] FromBuild wraps Source + Options\n- [ ] Resolver.Resolve() handles any Ref type\n- [ ] Unit tests for each ref type\n","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:06:11.59587-07:00","created_by":"Michael Dwan","updated_at":"2026-01-27T09:51:23.127181-07:00","closed_at":"2026-01-27T09:51:23.127181-07:00","close_reason":"Implemented ref_types.go with Ref interface, TagRef, LocalRef, RemoteRef, BuildRef types, and Resolver.Resolve() method. All 19 new tests pass.","dependencies":[{"issue_id":"cog-fuo.7","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:06:11.598328-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.7","depends_on_id":"cog-fuo.6","type":"blocks","created_at":"2026-01-23T13:07:02.724968-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.8","title":"Phase 2.1: Migrate pkg/cli/build.go to use Resolver","description":"## Summary\n\nRefactor build.go to use the new Resolver.Build() API.\n\n## Changes\n\n```go\n// Before (19 params)\nregistryClient := registry.NewRegistryClient()\nif err := image.Build(ctx, cfg, projectDir, imageName, buildSecrets, ...); err != nil {\n    return err\n}\n\n// After\nsrc, err := model.NewSource(configFilename)\nif err != nil {\n    logClient.EndBuild(ctx, err, logCtx)\n    return err\n}\n\nresolver := model.NewResolver(dockerClient, registry.NewRegistryClient())\n\nm, err := resolver.Build(ctx, src, model.BuildOptions{\n    ImageName:        imageName,\n    Secrets:          buildSecrets,\n    NoCache:          buildNoCache,\n    SeparateWeights:  buildSeparateWeights,\n    UseCudaBaseImage: buildUseCudaBaseImage,\n    ProgressOutput:   buildProgressOutput,\n    SchemaFile:       buildSchemaFile,\n    DockerfileFile:   buildDockerfileFile,\n    UseCogBaseImage:  DetermineUseCogBaseImage(cmd),\n    Strip:            buildStrip,\n    Precompile:       buildPrecompile,\n    Fast:             buildFast,\n    LocalImage:       buildLocalImage,\n    PipelinesImage:   pipelinesImage,\n})\nif err != nil {\n    logClient.EndBuild(ctx, err, logCtx)\n    return err\n}\n\nconsole.Infof(\"Built: %s\", m.ImageRef())\n```\n\n## Acceptance Criteria\n\n- [ ] build.go uses model.NewResolver() and resolver.Build()\n- [ ] BuildOptions used instead of 19 parameters\n- [ ] Model returned provides access to built image info\n- [ ] All existing unit tests pass\n- [ ] Integration tests pass\n","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:06:35.948036-07:00","created_by":"Michael Dwan","updated_at":"2026-01-27T17:49:48.780689-07:00","closed_at":"2026-01-27T17:49:48.780689-07:00","close_reason":"Migrated build.go to use model.Resolver.Build() API","dependencies":[{"issue_id":"cog-fuo.8","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:06:35.95048-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.8","depends_on_id":"cog-fuo.6","type":"blocks","created_at":"2026-01-23T13:07:03.384815-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-fuo.9","title":"Phase 2.2: Migrate pkg/cli/push.go to use Resolver","description":"## Summary\n\nRefactor push.go to use Resolver.Build() and Model.\n\n## Changes\n\n- Replace image.Build() call with resolver.Build()\n- Use Model for accessing image reference after build\n- Keep push logic separate (docker.Push)\n\n## Acceptance Criteria\n\n- [ ] push.go uses resolver.Build()\n- [ ] Model.ImageRef() used for push destination\n- [ ] All tests pass\n","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T13:06:36.101788-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:53:03.254207-07:00","closed_at":"2026-01-28T14:53:03.254207-07:00","close_reason":"Implemented in md/model-resolver branch","dependencies":[{"issue_id":"cog-fuo.9","depends_on_id":"cog-fuo","type":"parent-child","created_at":"2026-01-23T13:06:36.102332-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-fuo.9","depends_on_id":"cog-fuo.8","type":"blocks","created_at":"2026-01-23T13:07:03.479197-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-gmf","title":"Implement CA cert reading and Dockerfile generation","description":"## Task\n\nCreate `pkg/dockerfile/cacert.go` with functions to:\n1. Read CA cert from COG_CA_CERT env var\n2. Generate Dockerfile steps to install the cert\n\n## Input Detection Logic\n\nCheck in order:\n1. Is path that exists as file? → Read file contents\n2. Is path that exists as directory? → Read all *.crt and *.pem files, concatenate\n3. Starts with '-----BEGIN' (after trim)? → Use as raw PEM\n4. Valid base64 that decodes to PEM? → Decode and use\n5. Otherwise → Error\n\n## ReadCACert() Function\n\n```go\nfunc ReadCACert() ([]byte, error)\n```\n\nReturns:\n- nil, nil if COG_CA_CERT not set (no-op case)\n- cert bytes if found\n- error if invalid\n\n## installCACert() Method on StandardGenerator\n\n```go\nfunc (g *StandardGenerator) installCACert() (string, error)\n```\n\nWhen cert found:\n1. Print: `console.Info(\"Injecting CA certificate from COG_CA_CERT\")`\n2. Write cert to temp build context via `g.writeTemp()`\n3. Return Dockerfile lines:\n   - COPY cert to /usr/local/share/ca-certificates/cog-ca-cert.crt\n   - RUN update-ca-certificates\n   - ENV SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt\n   - ENV REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt\n   - ENV CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt\n   - ENV NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt\n\nWhen no cert: return empty string, nil\n\n## File to Create\n\n`pkg/dockerfile/cacert.go`\n\n## Code Style\n\nFollow existing patterns in the codebase:\n- Import groups: stdlib, third-party, internal\n- Use `github.com/replicate/cog/pkg/util/console` for logging\n- Error messages should be descriptive","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T11:14:36.34587-07:00","updated_at":"2026-01-14T13:20:27.646188-07:00","closed_at":"2026-01-14T13:20:27.646188-07:00","close_reason":"Implemented CA cert injection via COG_CA_CERT","dependencies":[{"issue_id":"cog-gmf","depends_on_id":"cog-yuu","type":"discovered-from","created_at":"2026-01-14T11:15:37.914879-07:00","created_by":"Matt Dwan","metadata":"{}"}]}
{"id":"cog-gss","title":"Document environment variables in config","description":"Document all environment variables that affect cog's behavior in the config/docs. There are ~40+ env vars across CLI (COG_*, R8_*), Python SDK (COG_LOG_LEVEL, PORT, etc.), Docker/CI (DOCKER_HOST, GITHUB_SHA), and the cog.yaml environment field. Currently undocumented in a single place - users have to read source code to discover them.","status":"open","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-05T18:02:58.69186-07:00","created_by":"Michael Dwan","updated_at":"2026-02-05T18:04:46.709694-07:00"}
{"id":"cog-hlq","title":"Run E2E tests against both runtimes and fix discrepancies","description":"Run the unified E2E test suite against:\n1. cog runtime (cog_runtime: false / default)\n2. coglet runtime (cog_runtime: true)\n\nIdentify and fix any behavioral differences.\n\nThis is the key validation that both runtimes behave identically.\n\nDepends on: cog-siv (fixtures migrated)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:14:47.63167-07:00","updated_at":"2026-02-02T13:57:52.677899-07:00","closed_at":"2026-02-02T13:57:52.677899-07:00","close_reason":"Closed with parent testing/coglet epics","dependencies":[{"issue_id":"cog-hlq","depends_on_id":"cog-tdd","type":"blocks","created_at":"2025-12-15T15:14:47.632112-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-hr1","title":"Fix coglet test failures - tests fail even with high resources","description":"## Problem\nCoglet Go tests are failing both in CI and locally, even on machines with plenty of resources. This is NOT a resource exhaustion issue - something is fundamentally broken in the tests or the code.\n\n## Background\nWe are on branch `md/backport-cog-runtime` which integrates cog-runtime (coglet) into the main cog repo.\n\n### Previous fixes attempted (all committed and pushed):\n1. **7f20838f** - Excluded coglet/ from test-go target to avoid CI hangs\n2. **46c7103e** - Fixed race condition: clean up pending map BEFORE sending webhook in `coglet/internal/runner/manager.go` lines 401-422\n3. **45be1418** - Added `-parallel 4` to limit test parallelism (but this didn't help)\n\n### What we thought was the problem:\n- Originally thought tests were being killed due to resource exhaustion from too many parallel Python subprocesses\n- Tried limiting parallelism with `-parallel 4` and `-p 1`\n- User confirms: **failing locally on high-resource machine** - so it's NOT a resource issue\n\n### Current CI status (run 20256805218):\n- **Test Coglet Go**: FAILED\n- **Lint**: FAILED  \n- Test Go (all variants): PASSED\n- Test Python (all variants): PASSED\n- Test Coglet Python: PASSED\n\n## Key Files\n- `coglet/internal/runner/manager.go` - Contains the prediction allocation logic where we fixed a race condition\n- `coglet/internal/tests/` - Contains 373 coglet Go tests that spawn Python subprocesses\n- `Makefile` line 152 - `test-coglet-go` target\n\n## Race condition fix details (commit 46c7103e)\nIn `allocatePrediction()` around lines 401-422, the defer block was:\n1. Sending webhook (terminal state)\n2. THEN deleting from pending map\n\nThis caused a race where a new prediction could arrive, see the runner had no capacity (pending entry still exists), and fail.\n\nFixed to:\n1. Delete from pending map FIRST\n2. THEN send webhook\n\n## What needs investigation\n1. **Why are tests still failing?** - Need to capture actual test output/errors\n2. **Is the race condition fix correct?** - May have introduced a different bug\n3. **Lint failure** - Separate issue, need to run `script/lint` to see what's wrong\n\n## Local state\n- Uncommitted change in Makefile: `-parallel 4` -\u003e `-p 1` (not relevant if resource exhaustion isn't the issue)\n- Deleted files: coglet/python/cog/cog-{darwin,linux}-{amd64,arm64} binaries\n- Untracked: PROJECT.md, coglet-server\n\n## Commands to reproduce\n\\`\\`\\`bash\n# Run the failing tests\nmake test-coglet-go\n\n# Or run specific test that was failing\ngo test -v -timeout 60s -run TestProcedureSchemaLoadingSequential ./coglet/internal/tests/\n\n# Check lint\nscript/lint\n\\`\\`\\`\n\n## Next steps\n1. Run `make test-coglet-go` and capture the ACTUAL error output\n2. Identify which specific tests are failing and why\n3. Check if it's a test setup issue, Python environment issue, or actual code bug\n4. Fix lint issues separately","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-15T21:52:41.68586-07:00","updated_at":"2025-12-16T09:45:27.964204-07:00","closed_at":"2025-12-16T09:45:27.964204-07:00"}
{"id":"cog-hzp","title":"Build API Encapsulation: Model, Resolver, Factory Architecture","description":"## Overview\n\nRefactor Cog's build and image access code to create clean abstractions that:\n1. Encapsulate all build complexity behind a `Factory` interface\n2. Provide uniform access to models via `Resolver`\n3. Enable pluggable build backends (Dockerfile, BuildKit frontend, cogpacks)\n4. Validate and parse image refs early using go-containerregistry/pkg/name\n\n## Architecture\n\n```\n                         CLI / Commands\n                              │\n                              ▼\n                    ┌───────────────────┐\n                    │     Resolver      │  ← Orchestration layer\n                    │                   │\n                    │ .Resolve(ref)     │  ← Load or Build based on Ref type\n                    │ .Build(src, opts) │  ← Calls Factory\n                    │ .LoadLocal()      │  ← Direct docker daemon access\n                    │ .LoadRemote()     │  ← Direct registry access\n                    └───────────────────┘\n                              │\n                              │ Build()\n                              ▼\n                    ┌───────────────────┐\n                    │     Factory       │  ← Build backend interface\n                    └───────────────────┘\n                              │\n            ┌─────────────────┼─────────────────┐\n            ▼                 ▼                 ▼\n    DockerfileFactory   FrontendFactory   CogpacksFactory\n       (current)          (future)          (future)\n```\n\n## Key Types\n\n- **ParsedRef**: Validated image reference with structured fields\n- **Ref**: Interface for things that can be resolved to a Model (FromTag, FromLocal, FromBuild)\n- **Image**: OCI image metadata (reference, digest, labels, source)\n- **Model**: Cog model extracted from Image (config, schema, runtime info)\n- **Source**: Project directory + cog.yaml\n- **BuildOptions**: All build flags consolidated\n- **Factory**: Interface for build backends\n- **Resolver**: Orchestrates loading and building\n\n## Success Criteria\n\n- CLI commands use Resolver instead of calling image.Build() directly\n- Build backend can be swapped via env var (COG_BUILDER, COGPACK)\n- Image refs validated early with clear error messages\n- All existing tests pass\n- Zero changes to pkg/dockerfile/, pkg/docker/ internals (initially)\n\n## References\n\n- Previous planning: cog-u5c (BuildKit Frontend Architecture)\n- Cogpacks design: origin/md/cogpack branch\n- Related: pkg/web/client.go Version struct\n","status":"closed","priority":1,"issue_type":"epic","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:56:42.219186-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T16:24:14.070487-07:00","closed_at":"2026-01-23T16:24:14.070487-07:00","close_reason":"Duplicate of cog-fuo epic and subtasks"}
{"id":"cog-hzp.1","title":"Phase 1.1: Create pkg/model/ref.go with ParsedRef and ref parsing","description":"## Summary\n\nCreate the ref parsing foundation using go-containerregistry/pkg/name for early validation and structured access to image reference components.\n\n## File to Create\n\n`pkg/model/ref.go`\n\n## Implementation\n\n```go\npackage model\n\nimport (\n    \"github.com/google/go-containerregistry/pkg/name\"\n    \"github.com/replicate/cog/pkg/global\"\n)\n\n// ParsedRef wraps a validated and parsed image reference\ntype ParsedRef struct {\n    Original    string         // Original input string\n    Ref         name.Reference // Parsed reference\n    Registry    string         // e.g., \"r8.im\", \"index.docker.io\"\n    Repository  string         // e.g., \"user/model\"\n    Tag         string         // e.g., \"v1\" (empty if digest)\n    Digest      string         // e.g., \"sha256:...\" (empty if tag)\n    IsReplicate bool           // Is this r8.im?\n}\n\n// ParseRef validates and parses an image reference\nfunc ParseRef(ref string) (*ParsedRef, error) {\n    parsed, err := name.ParseReference(ref)\n    if err != nil {\n        return nil, fmt.Errorf(\"invalid image reference %q: %w\", ref, err)\n    }\n    \n    registry := parsed.Context().RegistryStr()\n    \n    return \u0026ParsedRef{\n        Original:    ref,\n        Ref:         parsed,\n        Registry:    registry,\n        Repository:  parsed.Context().RepositoryStr(),\n        Tag:         tagOrEmpty(parsed),\n        Digest:      digestOrEmpty(parsed),\n        IsReplicate: registry == global.ReplicateRegistryHost,\n    }, nil\n}\n\nfunc (p *ParsedRef) String() string { return p.Ref.String() }\nfunc (p *ParsedRef) IsTag() bool    { return p.Tag != \"\" }\nfunc (p *ParsedRef) IsDigest() bool { return p.Digest != \"\" }\n\n// Helper functions for extracting tag/digest\nfunc tagOrEmpty(ref name.Reference) string { ... }\nfunc digestOrEmpty(ref name.Reference) string { ... }\n```\n\n## Acceptance Criteria\n\n- [ ] ParseRef validates refs using go-containerregistry/pkg/name\n- [ ] ParsedRef exposes Registry, Repository, Tag, Digest fields\n- [ ] Invalid refs return clear error messages\n- [ ] Unit tests for common ref formats (tag, digest, with/without registry)\n- [ ] Unit tests for Replicate registry detection\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:56:56.778081-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T16:24:14.073469-07:00","closed_at":"2026-01-23T16:24:14.073469-07:00","close_reason":"Duplicate of cog-fuo epic and subtasks","dependencies":[{"issue_id":"cog-hzp.1","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:56:56.781217-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.10","title":"Phase 2.3: Migrate pkg/cli/predict.go to use Resolver","description":"## Summary\n\nRefactor predict.go to use Resolver for both build and load paths.\n\n## Changes\n\npredict.go has two code paths:\n1. Build from local project (no args)\n2. Load existing image (arg provided)\n\nBoth should use Resolver:\n\n```go\nvar m *model.Model\nif len(args) == 0 {\n    src, _ := model.NewSource(configFilename)\n    m, err = resolver.Build(ctx, src, buildOptsFromFlags())\n} else {\n    ref, err := model.FromTag(args[0])\n    if err != nil {\n        return err  // Early validation!\n    }\n    m, err = resolver.Resolve(ctx, ref)\n}\n\n// Now use m uniformly\nif m.HasGPU() {\n    gpus = \"all\"\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Both build and load paths use Resolver\n- [ ] FromTag validates ref format early\n- [ ] Model.HasGPU(), Model.IsFast() used\n- [ ] All tests pass\n","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:58:18.663185-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:52:59.627263-07:00","closed_at":"2026-01-28T14:52:59.627263-07:00","close_reason":"Implemented in md/model-resolver branch","dependencies":[{"issue_id":"cog-hzp.10","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:58:18.66497-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.10","depends_on_id":"cog-hzp.8","type":"blocks","created_at":"2026-01-23T11:58:49.630619-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.11","title":"Phase 2.4: Migrate pkg/cli/run.go, serve.go, train.go to use Resolver","description":"## Summary\n\nRefactor remaining CLI commands to use Resolver.\n\n## Files\n\n- run.go - uses image.Build() and image.BuildBase()\n- serve.go - uses image.BuildBase()\n- train.go - similar to predict.go\n\n## Acceptance Criteria\n\n- [ ] All commands use Resolver\n- [ ] BuildBase use cases covered (maybe resolver.BuildBase()?)\n- [ ] All tests pass\n","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:58:21.032002-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:52:59.629307-07:00","closed_at":"2026-01-28T14:52:59.629307-07:00","close_reason":"Implemented in md/model-resolver branch","dependencies":[{"issue_id":"cog-hzp.11","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:58:21.033861-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.11","depends_on_id":"cog-hzp.8","type":"blocks","created_at":"2026-01-23T11:58:49.753351-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.13","title":"Phase 3.2: Deprecate direct image.Build() calls","description":"## Summary\n\nAfter all CLI commands use Resolver, mark image.Build() as deprecated or make it internal.\n\n## Options\n\n1. Add deprecation comment and point to model.Resolver\n2. Move to internal package\n3. Keep as-is but document that Resolver is preferred\n\n## Acceptance Criteria\n\n- [ ] Decision made on deprecation approach\n- [ ] Documentation updated\n- [ ] No direct image.Build() calls from CLI\n","status":"closed","priority":3,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:58:32.019689-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:53:15.162799-07:00","closed_at":"2026-01-28T14:53:15.162799-07:00","close_reason":"Duplicate of cog-fuo.* issues","dependencies":[{"issue_id":"cog-hzp.13","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:58:32.021615-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.13","depends_on_id":"cog-hzp.11","type":"blocks","created_at":"2026-01-23T11:58:51.023121-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.13","depends_on_id":"cog-hzp.10","type":"blocks","created_at":"2026-01-23T11:58:51.13329-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.14","title":"Future: Implement FrontendFactory for BuildKit frontend","description":"## Summary\n\nImplement FrontendFactory that uses BuildKit frontend instead of generating Dockerfiles in-process.\n\n## Implementation\n\n```go\ntype FrontendFactory struct {\n    docker        command.Command\n    frontendImage string\n}\n\nfunc NewFrontendFactory(docker command.Command, frontendImage string) Factory {\n    return \u0026FrontendFactory{docker: docker, frontendImage: frontendImage}\n}\n\nfunc (f *FrontendFactory) Build(ctx context.Context, src *Source, opts BuildOptions) (*Image, error) {\n    // Use docker.BuildWithFrontend()\n}\n```\n\n## Depends On\n\n- cog-u5c (BuildKit Frontend Architecture) work\n- pkg/model/ foundation complete\n\n## Acceptance Criteria\n\n- [ ] FrontendFactory implements Factory interface\n- [ ] Enabled via COG_BUILDER env var\n- [ ] Produces identical images to DockerfileFactory\n","status":"closed","priority":4,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:58:36.621599-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:53:15.165204-07:00","closed_at":"2026-01-28T14:53:15.165204-07:00","close_reason":"Duplicate of cog-fuo.* issues","dependencies":[{"issue_id":"cog-hzp.14","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:58:36.623379-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.14","depends_on_id":"cog-hzp.13","type":"blocks","created_at":"2026-01-23T11:58:51.817232-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.15","title":"Future: Implement CogpacksFactory for LLB-based builds","description":"## Summary\n\nImplement CogpacksFactory that uses the cogpacks Stack/Block/Plan architecture.\n\n## Depends On\n\n- origin/md/cogpack branch work\n- pkg/model/ foundation complete\n\n## Implementation\n\n```go\ntype CogpacksFactory struct {\n    docker   command.Command\n    registry registry.Client\n}\n\nfunc (f *CogpacksFactory) Build(ctx context.Context, src *Source, opts BuildOptions) (*Image, error) {\n    // Use cogpack.GeneratePlan() + cogpack.RunBuildPlan()\n}\n```\n\n## Acceptance Criteria\n\n- [ ] CogpacksFactory implements Factory interface\n- [ ] Enabled via COGPACK=1 env var\n- [ ] Uses LLB instead of Dockerfile generation\n","status":"closed","priority":4,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:58:40.394051-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:53:15.167037-07:00","closed_at":"2026-01-28T14:53:15.167037-07:00","close_reason":"Duplicate of cog-fuo.* issues","dependencies":[{"issue_id":"cog-hzp.15","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:58:40.395933-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.15","depends_on_id":"cog-hzp.13","type":"blocks","created_at":"2026-01-23T11:58:51.913622-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.2","title":"Phase 1.2: Create pkg/model/image.go with Image struct","description":"## Summary\n\nCreate the Image struct representing an OCI image with Cog-specific helpers.\n\n## File to Create\n\n`pkg/model/image.go`\n\n## Implementation\n\n```go\npackage model\n\n// ImageSource indicates where an image was loaded from\ntype ImageSource string\n\nconst (\n    ImageSourceLocal  ImageSource = \"local\"  // Docker daemon\n    ImageSourceRemote ImageSource = \"remote\" // Registry\n    ImageSourceBuild  ImageSource = \"build\"  // Just built\n)\n\n// Image represents an OCI image that may contain a Cog model\ntype Image struct {\n    Reference string            // Full image reference\n    Digest    string            // Content-addressable digest\n    Labels    map[string]string // Image labels\n    Platform  *Platform         // os/arch\n    Source    ImageSource       // Where loaded from\n}\n\ntype Platform struct {\n    OS           string\n    Architecture string\n}\n\n// IsCogModel returns true if this image has Cog labels\nfunc (i *Image) IsCogModel() bool {\n    _, ok := i.Labels[CogConfigLabelKey]\n    return ok\n}\n\n// CogVersion returns the cog version that built this image\nfunc (i *Image) CogVersion() string {\n    return i.Labels[CogVersionLabelKey]\n}\n\n// Label constants (re-exported from command package for convenience)\nconst (\n    CogConfigLabelKey     = \"run.cog.config\"\n    CogVersionLabelKey    = \"run.cog.version\"\n    CogOpenAPISchemaLabelKey = \"run.cog.openapi_schema\"\n)\n```\n\n## Acceptance Criteria\n\n- [ ] Image struct captures reference, digest, labels, platform, source\n- [ ] IsCogModel() checks for cog labels\n- [ ] Label constants defined\n- [ ] Unit tests for IsCogModel() and helper methods\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:57:03.611902-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T16:24:14.075769-07:00","closed_at":"2026-01-23T16:24:14.075769-07:00","close_reason":"Duplicate of cog-fuo epic and subtasks","dependencies":[{"issue_id":"cog-hzp.2","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:57:03.613768-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.3","title":"Phase 1.3: Create pkg/model/model.go with Model struct","description":"## Summary\n\nCreate the Model struct representing a Cog model with all its metadata.\n\n## File to Create\n\n`pkg/model/model.go`\n\n## Implementation\n\n```go\npackage model\n\nimport (\n    \"encoding/json\"\n    \n    \"github.com/getkin/kin-openapi/openapi3\"\n    \"github.com/replicate/cog/pkg/config\"\n)\n\n// Model represents a Cog model extracted from an Image\ntype Model struct {\n    Image      *Image           // Underlying OCI image\n    Config     *config.Config   // Parsed cog.yaml\n    Schema     *openapi3.T      // OpenAPI schema\n    CogVersion string           // Version of cog used to build\n    Weights    *WeightsManifest // Weight file info (optional)\n    Runtime    *RuntimeConfig   // Runtime env config\n    GitCommit  string           // Git commit (if available)\n    GitTag     string           // Git tag (if available)\n}\n\n// RuntimeConfig holds runtime environment info\ntype RuntimeConfig struct {\n    GPU           bool\n    CudaVersion   string\n    CudnnVersion  string\n    PythonVersion string\n    TorchVersion  string\n    Env           map[string]string\n}\n\n// WeightsManifest describes model weights\ntype WeightsManifest struct {\n    Files []WeightFile\n}\n\ntype WeightFile struct {\n    Path   string\n    Digest string\n    Size   int64\n    URL    string // For external weights\n}\n\n// Convenience methods\nfunc (m *Model) HasGPU() bool { return m.Config != nil \u0026\u0026 m.Config.Build.GPU }\nfunc (m *Model) IsFast() bool { return m.Config != nil \u0026\u0026 m.Config.Build.Fast }\n\nfunc (m *Model) SchemaJSON() ([]byte, error) {\n    if m.Schema == nil {\n        return nil, nil\n    }\n    return json.Marshal(m.Schema)\n}\n\n// ImageRef returns the image reference string\nfunc (m *Model) ImageRef() string {\n    if m.Image == nil {\n        return \"\"\n    }\n    return m.Image.Reference\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Model struct holds Image, Config, Schema, CogVersion, etc.\n- [ ] RuntimeConfig and WeightsManifest defined\n- [ ] Convenience methods: HasGPU(), IsFast(), SchemaJSON()\n- [ ] Unit tests for Model methods\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:57:12.193996-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T16:24:14.077824-07:00","closed_at":"2026-01-23T16:24:14.077824-07:00","close_reason":"Duplicate of cog-fuo epic and subtasks","dependencies":[{"issue_id":"cog-hzp.3","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:57:12.195865-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.4","title":"Phase 1.4: Create pkg/model/source.go and options.go","description":"## Summary\n\nCreate Source (project to be built) and BuildOptions (consolidated flags).\n\n## Files to Create\n\n`pkg/model/source.go` and `pkg/model/options.go`\n\n## Implementation\n\n### source.go\n```go\npackage model\n\nimport \"github.com/replicate/cog/pkg/config\"\n\n// Source represents a cog project ready to build\ntype Source struct {\n    Config     *config.Config\n    ProjectDir string\n}\n\n// NewSource loads config from path and returns Source\nfunc NewSource(configPath string) (*Source, error) {\n    cfg, dir, err := config.GetConfig(configPath)\n    if err != nil {\n        return nil, err\n    }\n    return \u0026Source{Config: cfg, ProjectDir: dir}, nil\n}\n\n// NewSourceFromConfig creates Source from existing config\nfunc NewSourceFromConfig(cfg *config.Config, projectDir string) *Source {\n    return \u0026Source{Config: cfg, ProjectDir: projectDir}\n}\n```\n\n### options.go\n```go\npackage model\n\n// BuildOptions contains all settings for building an image\ntype BuildOptions struct {\n    ImageName        string            // Required: output image name\n    NoCache          bool              // Disable build cache\n    SeparateWeights  bool              // Build weights as separate layer\n    Fast             bool              // Use fast/monobase build\n    Strip            bool              // Strip debug symbols\n    Precompile       bool              // Precompile Python\n    LocalImage       bool              // Local-only image\n    PipelinesImage   bool              // Pipeline/Workflow image\n    UseCudaBaseImage string            // \"auto\", \"true\", \"false\"\n    UseCogBaseImage  *bool             // nil = auto\n    Secrets          []string          // Build secrets\n    ProgressOutput   string            // \"auto\", \"plain\", \"tty\"\n    Annotations      map[string]string // Extra labels\n    SchemaFile       string            // Custom schema file\n    DockerfileFile   string            // Custom Dockerfile\n}\n\n// WithDefaults fills in defaults from Source\nfunc (o BuildOptions) WithDefaults(src *Source) BuildOptions {\n    if o.ImageName == \"\" {\n        o.ImageName = config.DockerImageName(src.ProjectDir)\n    }\n    if o.ProgressOutput == \"\" {\n        o.ProgressOutput = \"auto\"\n    }\n    // Apply fast from config if not set\n    if src.Config.Build.Fast {\n        o.Fast = true\n    }\n    return o\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Source wraps config + projectDir\n- [ ] NewSource loads from config path\n- [ ] BuildOptions consolidates all build flags\n- [ ] WithDefaults applies sensible defaults\n- [ ] Unit tests\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:57:27.922354-07:00","created_by":"Michael Dwan","updated_at":"2026-01-23T16:24:14.079873-07:00","closed_at":"2026-01-23T16:24:14.079873-07:00","close_reason":"Duplicate of cog-fuo epic and subtasks","dependencies":[{"issue_id":"cog-hzp.4","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:57:27.924157-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.5","title":"Phase 1.5: Create pkg/model/factory.go with Factory interface and DockerfileFactory","description":"## Summary\n\nCreate the Factory interface and initial DockerfileFactory implementation that wraps existing image.Build() code.\n\n## File to Create\n\n`pkg/model/factory.go`\n\n## Implementation\n\n```go\npackage model\n\nimport (\n    \"context\"\n    \"os\"\n    \n    \"github.com/replicate/cog/pkg/docker/command\"\n    \"github.com/replicate/cog/pkg/image\"\n    \"github.com/replicate/cog/pkg/registry\"\n)\n\n// Factory is the build backend interface\ntype Factory interface {\n    Build(ctx context.Context, src *Source, opts BuildOptions) (*Image, error)\n    Name() string\n}\n\n// DockerfileFactory wraps existing Dockerfile-based build\ntype DockerfileFactory struct {\n    docker   command.Command\n    registry registry.Client\n}\n\nfunc NewDockerfileFactory(docker command.Command, registry registry.Client) Factory {\n    return \u0026DockerfileFactory{docker: docker, registry: registry}\n}\n\nfunc (f *DockerfileFactory) Name() string { return \"dockerfile\" }\n\nfunc (f *DockerfileFactory) Build(ctx context.Context, src *Source, opts BuildOptions) (*Image, error) {\n    // Delegate to existing image.Build()\n    err := image.Build(\n        ctx,\n        src.Config,\n        src.ProjectDir,\n        opts.ImageName,\n        opts.Secrets,\n        opts.NoCache,\n        opts.SeparateWeights,\n        opts.UseCudaBaseImage,\n        opts.ProgressOutput,\n        opts.SchemaFile,\n        opts.DockerfileFile,\n        opts.UseCogBaseImage,\n        opts.Strip,\n        opts.Precompile,\n        opts.Fast,\n        opts.Annotations,\n        opts.LocalImage,\n        f.docker,\n        f.registry,\n        opts.PipelinesImage,\n    )\n    if err != nil {\n        return nil, err\n    }\n    \n    return \u0026Image{\n        Reference: opts.ImageName,\n        Source:    ImageSourceBuild,\n    }, nil\n}\n\n// DefaultFactory returns factory based on env vars\nfunc DefaultFactory(docker command.Command, registry registry.Client) Factory {\n    if frontendImage := os.Getenv(\"COG_BUILDER\"); frontendImage != \"\" {\n        // TODO: return FrontendFactory when implemented\n        return NewDockerfileFactory(docker, registry)\n    }\n    return NewDockerfileFactory(docker, registry)\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Factory interface defined with Build() and Name()\n- [ ] DockerfileFactory wraps existing image.Build()\n- [ ] DefaultFactory checks COG_BUILDER env var\n- [ ] Unit tests with mock docker/registry\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:57:36.305672-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:52:59.618597-07:00","closed_at":"2026-01-28T14:52:59.618597-07:00","close_reason":"Implemented in md/model-resolver branch","dependencies":[{"issue_id":"cog-hzp.5","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:57:36.307621-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.5","depends_on_id":"cog-hzp.2","type":"blocks","created_at":"2026-01-23T11:58:48.095296-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.5","depends_on_id":"cog-hzp.3","type":"blocks","created_at":"2026-01-23T11:58:48.217354-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.5","depends_on_id":"cog-hzp.4","type":"blocks","created_at":"2026-01-23T11:58:48.330153-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.6","title":"Phase 1.6: Create pkg/model/resolver.go with Resolver struct","description":"## Summary\n\nCreate the Resolver that orchestrates building and loading Models.\n\n## File to Create\n\n`pkg/model/resolver.go`\n\n## Implementation\n\n```go\npackage model\n\nimport (\n    \"context\"\n    \"encoding/json\"\n    \n    \"github.com/getkin/kin-openapi/openapi3\"\n    \"github.com/replicate/cog/pkg/docker/command\"\n    \"github.com/replicate/cog/pkg/registry\"\n)\n\n// Resolver orchestrates loading and building Models\ntype Resolver struct {\n    docker   command.Command\n    registry registry.Client\n    factory  Factory\n}\n\n// NewResolver creates Resolver with default factory\nfunc NewResolver(docker command.Command, registry registry.Client) *Resolver {\n    return \u0026Resolver{\n        docker:   docker,\n        registry: registry,\n        factory:  DefaultFactory(docker, registry),\n    }\n}\n\n// WithFactory sets a custom factory\nfunc (r *Resolver) WithFactory(f Factory) *Resolver {\n    r.factory = f\n    return r\n}\n\n// Build uses Factory to build, then extracts full Model\nfunc (r *Resolver) Build(ctx context.Context, src *Source, opts BuildOptions) (*Model, error) {\n    opts = opts.WithDefaults(src)\n    \n    img, err := r.factory.Build(ctx, src, opts)\n    if err != nil {\n        return nil, err\n    }\n    \n    return r.loadFromImage(ctx, img, src)\n}\n\n// LoadLocal loads Model from docker daemon\nfunc (r *Resolver) LoadLocal(ctx context.Context, ref *ParsedRef) (*Model, error) {\n    resp, err := r.docker.Pull(ctx, ref.String(), false)\n    if err != nil {\n        return nil, fmt.Errorf(\"image %s not found locally: %w\", ref.Original, err)\n    }\n    return modelFromInspect(ref, resp, ImageSourceLocal)\n}\n\n// LoadRemote loads Model from registry (no docker pull)\nfunc (r *Resolver) LoadRemote(ctx context.Context, ref *ParsedRef) (*Model, error) {\n    manifest, err := r.registry.Inspect(ctx, ref.String(), nil)\n    if err != nil {\n        return nil, fmt.Errorf(\"image %s not found in registry: %w\", ref.Original, err)\n    }\n    return modelFromManifest(ref, manifest, ImageSourceRemote)\n}\n\n// Load tries local first, then remote\nfunc (r *Resolver) Load(ctx context.Context, ref *ParsedRef) (*Model, error) {\n    model, err := r.LoadLocal(ctx, ref)\n    if err == nil {\n        return model, nil\n    }\n    return r.LoadRemote(ctx, ref)\n}\n\n// loadFromImage extracts Model from built Image\nfunc (r *Resolver) loadFromImage(ctx context.Context, img *Image, src *Source) (*Model, error) {\n    // Inspect to get labels\n    resp, err := r.docker.Inspect(ctx, img.Reference)\n    if err != nil {\n        return nil, err\n    }\n    \n    // Parse schema from labels\n    var schema *openapi3.T\n    if schemaJSON := resp.Config.Labels[CogOpenAPISchemaLabelKey]; schemaJSON != \"\" {\n        schema, _ = openapi3.NewLoader().LoadFromData([]byte(schemaJSON))\n    }\n    \n    img.Labels = resp.Config.Labels\n    img.Digest = resp.ID\n    \n    return \u0026Model{\n        Image:      img,\n        Config:     src.Config,\n        Schema:     schema,\n        CogVersion: img.Labels[CogVersionLabelKey],\n    }, nil\n}\n\n// Helper functions\nfunc modelFromInspect(ref *ParsedRef, resp *image.InspectResponse, source ImageSource) (*Model, error) { ... }\nfunc modelFromManifest(ref *ParsedRef, manifest *registry.ManifestResult, source ImageSource) (*Model, error) { ... }\n```\n\n## Acceptance Criteria\n\n- [ ] Resolver.Build() uses Factory and extracts Model\n- [ ] Resolver.LoadLocal() loads from docker daemon\n- [ ] Resolver.LoadRemote() loads from registry\n- [ ] Resolver.Load() tries local then remote\n- [ ] WithFactory() allows custom factory injection\n- [ ] Unit tests with mocked dependencies\n","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:57:49.532537-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:52:59.62126-07:00","closed_at":"2026-01-28T14:52:59.62126-07:00","close_reason":"Implemented in md/model-resolver branch","dependencies":[{"issue_id":"cog-hzp.6","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:57:49.534604-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.6","depends_on_id":"cog-hzp.1","type":"blocks","created_at":"2026-01-23T11:58:48.445461-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.6","depends_on_id":"cog-hzp.5","type":"blocks","created_at":"2026-01-23T11:58:48.554924-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.7","title":"Phase 1.7: Create pkg/model/ref_types.go with Ref interface and FromTag, FromLocal, FromBuild","description":"## Summary\n\nCreate the Ref interface and concrete types for declarative model resolution.\n\n## File to Create\n\n`pkg/model/ref_types.go`\n\n## Implementation\n\n```go\npackage model\n\nimport \"context\"\n\n// Ref represents something that can be resolved to a Model\ntype Ref interface {\n    resolve(ctx context.Context, r *Resolver) (*Model, error)\n}\n\n// TagRef resolves an image by tag/digest, trying local then remote\ntype TagRef struct {\n    Parsed *ParsedRef\n}\n\n// FromTag parses a tag reference (validates early)\nfunc FromTag(ref string) (*TagRef, error) {\n    parsed, err := ParseRef(ref)\n    if err != nil {\n        return nil, err\n    }\n    return \u0026TagRef{Parsed: parsed}, nil\n}\n\nfunc (t *TagRef) resolve(ctx context.Context, r *Resolver) (*Model, error) {\n    return r.Load(ctx, t.Parsed)\n}\n\n// LocalRef explicitly loads from docker daemon only\ntype LocalRef struct {\n    Parsed *ParsedRef\n}\n\nfunc FromLocal(ref string) (*LocalRef, error) {\n    parsed, err := ParseRef(ref)\n    if err != nil {\n        return nil, err\n    }\n    return \u0026LocalRef{Parsed: parsed}, nil\n}\n\nfunc (l *LocalRef) resolve(ctx context.Context, r *Resolver) (*Model, error) {\n    return r.LoadLocal(ctx, l.Parsed)\n}\n\n// RemoteRef explicitly loads from registry only\ntype RemoteRef struct {\n    Parsed *ParsedRef\n}\n\nfunc FromRemote(ref string) (*RemoteRef, error) {\n    parsed, err := ParseRef(ref)\n    if err != nil {\n        return nil, err\n    }\n    return \u0026RemoteRef{Parsed: parsed}, nil\n}\n\nfunc (rr *RemoteRef) resolve(ctx context.Context, r *Resolver) (*Model, error) {\n    return r.LoadRemote(ctx, rr.Parsed)\n}\n\n// BuildRef creates a Model by building from source\ntype BuildRef struct {\n    Source  *Source\n    Options BuildOptions\n}\n\nfunc FromBuild(src *Source, opts BuildOptions) *BuildRef {\n    return \u0026BuildRef{Source: src, Options: opts}\n}\n\nfunc (b *BuildRef) resolve(ctx context.Context, r *Resolver) (*Model, error) {\n    return r.Build(ctx, b.Source, b.Options)\n}\n\n// Resolve on Resolver for generic ref handling\nfunc (r *Resolver) Resolve(ctx context.Context, ref Ref) (*Model, error) {\n    return ref.resolve(ctx, r)\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Ref interface defined\n- [ ] FromTag, FromLocal, FromRemote parse and validate\n- [ ] FromBuild wraps Source + Options\n- [ ] Resolver.Resolve() handles any Ref\n- [ ] Unit tests for each ref type\n","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:58:04.162837-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:52:59.623477-07:00","closed_at":"2026-01-28T14:52:59.623477-07:00","close_reason":"Implemented in md/model-resolver branch","dependencies":[{"issue_id":"cog-hzp.7","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:58:04.164678-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.7","depends_on_id":"cog-hzp.6","type":"blocks","created_at":"2026-01-23T11:58:48.67261-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-hzp.8","title":"Phase 2.1: Migrate pkg/cli/build.go to use Resolver","description":"## Summary\n\nRefactor build.go to use the new Resolver.Build() API.\n\n## Changes\n\n```go\n// Before\nregistryClient := registry.NewRegistryClient()\nif err := image.Build(ctx, cfg, projectDir, imageName, buildSecrets, ...19 params...); err != nil {\n    return err\n}\n\n// After\nsrc, err := model.NewSource(configFilename)\nif err != nil {\n    logClient.EndBuild(ctx, err, logCtx)\n    return err\n}\n\nresolver := model.NewResolver(dockerClient, registry.NewRegistryClient())\n\nm, err := resolver.Build(ctx, src, model.BuildOptions{\n    ImageName:        imageName,\n    Secrets:          buildSecrets,\n    NoCache:          buildNoCache,\n    SeparateWeights:  buildSeparateWeights,\n    UseCudaBaseImage: buildUseCudaBaseImage,\n    ProgressOutput:   buildProgressOutput,\n    SchemaFile:       buildSchemaFile,\n    DockerfileFile:   buildDockerfileFile,\n    UseCogBaseImage:  DetermineUseCogBaseImage(cmd),\n    Strip:            buildStrip,\n    Precompile:       buildPrecompile,\n    Fast:             buildFast,\n    Annotations:      nil,\n    LocalImage:       buildLocalImage,\n    PipelinesImage:   pipelinesImage,\n})\nif err != nil {\n    logClient.EndBuild(ctx, err, logCtx)\n    return err\n}\n\nconsole.Infof(\"Built: %s\", m.ImageRef())\n```\n\n## Acceptance Criteria\n\n- [ ] build.go uses model.NewResolver() and resolver.Build()\n- [ ] BuildOptions used instead of 19 parameters\n- [ ] Model returned provides access to built image info\n- [ ] All existing tests pass\n- [ ] Integration tests pass\n","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-23T11:58:11.161458-07:00","created_by":"Michael Dwan","updated_at":"2026-01-28T14:52:59.625483-07:00","closed_at":"2026-01-28T14:52:59.625483-07:00","close_reason":"Implemented in md/model-resolver branch","dependencies":[{"issue_id":"cog-hzp.8","depends_on_id":"cog-hzp","type":"parent-child","created_at":"2026-01-23T11:58:11.163252-07:00","created_by":"Michael Dwan"},{"issue_id":"cog-hzp.8","depends_on_id":"cog-hzp.6","type":"blocks","created_at":"2026-01-23T11:58:49.401247-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-i3w","title":"Simplify coglet-server binary build to linux/amd64 only","description":"Update Makefile to only build coglet-server for linux/amd64, since cog build always targets linux/amd64.\n\n## Changes\n- Modify coglet-server-binaries target to remove darwin and arm64 builds\n- Update to single command: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o coglet/python/cog/cog-linux-amd64 ./coglet/cmd/coglet-server\n- Clean up any references to multi-platform builds\n\n## Files\n- Makefile\n\n## Acceptance Criteria\n- make coglet-server-binaries only produces cog-linux-amd64\n- make coglet-wheel produces wheel with single binary (~5MB)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T17:53:25.26914-07:00","updated_at":"2025-12-17T10:25:54.962063-07:00","closed_at":"2025-12-17T10:25:54.962063-07:00","dependencies":[{"issue_id":"cog-i3w","depends_on_id":"cog-1rk","type":"parent-child","created_at":"2025-12-16T17:53:25.269629-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-id9","title":"Design unified Go-based integration test framework","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-16T17:50:34.818838-07:00","updated_at":"2026-01-08T16:00:05.449584-07:00","closed_at":"2026-01-08T16:00:05.449584-07:00","close_reason":"Superseded by comprehensive epic planning for Go-based integration test framework"}
{"id":"cog-iws","title":"Rewrite integration tests in Go using testscript framework","description":"Replace the Python-based integration test suite (test-integration/) with a Go implementation using github.com/rogpeppe/go-internal/testscript.\n\n## Current Status\n- Framework implemented in integration-tests/\n- 14 tests ported and passing\n- Uses embedded fixtures in .txtar files (self-contained tests)\n- Makefile target: make test-integration-go\n- Throttled parallelism (-parallel 4) to avoid Docker overload\n\n## Architecture\n- Each .txtar file contains cog.yaml, predict.py, and test commands\n- Tests run via `cog build -t $TEST_IMAGE` then `cog predict $TEST_IMAGE`\n- Automatic Docker image cleanup after each test\n- On-demand cog binary building when COG_BINARY not set\n\n## Remaining Work\n- Port remaining ~46 fixtures from test-integration/\n- Add CI integration\n- Documentation\n\n## Non-Goals\n- Build caching (future optimization)\n- Separate fixture directories (using embedded approach instead)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-08T16:00:24.594934-07:00","updated_at":"2026-02-02T13:57:38.439304-07:00","closed_at":"2026-02-02T13:57:38.439304-07:00","close_reason":"Integration test rewrite complete","comments":[{"id":2,"issue_id":"cog-iws","author":"mdwan","text":"## Session Context (2026-01-08)\n\n### Key Research Findings\n\n**Recommended Framework**: github.com/rogpeppe/go-internal/testscript\n- Battle-tested, used by Go team for cmd/go tests\n- File-based tests using txtar format\n- Native go test integration with subtests\n- Built-in commands: exec, cmp, stdout, stderr, exists, cp, env\n- Custom commands can be added via Params.Cmds\n\n**Documentation Resources**:\n- testscript docs: https://pkg.go.dev/github.com/rogpeppe/go-internal/testscript\n- insta-cmd (Rust equivalent): https://insta.rs/docs/cmd/\n\n### Design Decisions Made\n\n1. Directory structure: Fixtures colocated with tests in integration-tests/fixtures/{name}/ with tests/*.txtar\n2. Test format: txtar with custom cog command\n3. Fixtures are real cog models (can cd and run manually)\n4. Output normalization via regex filters\n5. Incremental migration from Python tests\n\n### Existing Code to Reuse\n- pkg/docker/dockertest/ - Docker test utilities\n- pkg/registry_testhelpers/ - Testcontainers registry\n- coglet/internal/tests/harness_test.go - Similar harness pattern","created_at":"2026-01-09T00:29:00Z"}]}
{"id":"cog-iws.1","title":"Set up integration-tests directory structure and testscript foundation","description":"Create the foundation for the new Go-based integration test framework.\n\n## Tasks\n- Create integration-tests/ directory with go.mod importing testscript\n- Create basic suite_test.go with TestIntegration function\n- Create harness/ package skeleton\n- Create one minimal fixture (string-echo) with cog.yaml and predict.py\n- Create one test case (tests/basic.txtar) that just verifies setup works\n- Verify go test -run TestIntegration/string-echo/basic runs successfully\n\n## Directory Structure\n```\nintegration-tests/\n├── go.mod\n├── suite_test.go\n├── harness/\n│   └── harness.go\n└── fixtures/\n    └── string-echo/\n        ├── cog.yaml\n        ├── predict.py\n        └── tests/\n            └── basic.txtar\n```\n\n## Acceptance Criteria\n- go test ./integration-tests/... discovers and runs the basic test\n- Test properly copies fixture to temp directory\n- Test output shows testscript execution","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T16:01:17.279154-07:00","updated_at":"2026-01-12T13:12:32.468436-07:00","closed_at":"2026-01-12T13:12:32.468436-07:00","close_reason":"Implemented testscript foundation with harness, string-echo fixture, and basic.txtar test. Test passes successfully.","dependencies":[{"issue_id":"cog-iws.1","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-08T16:01:17.279562-07:00","created_by":"mdwan","metadata":"{}"}],"comments":[{"id":3,"issue_id":"cog-iws.1","author":"mdwan","text":"## Implementation Notes\n\nStart by creating this minimal structure:\n\nintegration-tests/\n├── go.mod (import github.com/rogpeppe/go-internal/testscript)\n├── suite_test.go\n├── harness/\n│   └── harness.go\n└── fixtures/\n    └── string-echo/\n        ├── cog.yaml\n        ├── predict.py\n        └── tests/\n            └── basic.txtar\n\nKey code pattern for suite_test.go:\n\nfunc TestIntegration(t *testing.T) {\n    // Walk fixtures/ to discover all fixture directories\n    // For each fixture, run testscript.Run with Dir set to fixtures/{name}/tests/\n}\n\nThe string-echo fixture can be copied from test-integration/test_integration/fixtures/string-project/\n\nReference coglet/internal/tests/harness_test.go for patterns on test setup.","created_at":"2026-01-09T00:29:15Z"}]}
{"id":"cog-iws.10","title":"(Future) Optimize test performance with build caching","description":"Implement fixture build caching to speed up test runs.\n\n## Problem\nEach test case that needs a built image rebuilds from scratch, even when the fixture hasn't changed.\n\n## Proposed Solution\n- Hash fixture contents (cog.yaml + predict.py + requirements.txt)\n- Cache built images by hash\n- Reuse cached images across test cases for same fixture\n- Consider local registry for better isolation\n\n## Implementation Ideas\n```go\ntype BuildCache struct {\n    images map[string]string // fixtureHash -\u003e imageTag\n}\n\nfunc (c *BuildCache) GetOrBuild(fixture string) string {\n    hash := hashFixture(fixture)\n    if tag, ok := c.images[hash]; ok {\n        return tag\n    }\n    tag := buildImage(fixture)\n    c.images[hash] = tag\n    return tag\n}\n```\n\n## Acceptance Criteria\n- Test suite runs significantly faster when fixtures unchanged\n- Cache invalidation works when fixture modified\n- No stale image issues","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-08T16:02:35.46421-07:00","updated_at":"2026-02-02T13:57:38.446571-07:00","closed_at":"2026-02-02T13:57:38.446571-07:00","close_reason":"Integration test rewrite complete","dependencies":[{"issue_id":"cog-iws.10","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-08T16:02:35.464585-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-iws.10","depends_on_id":"cog-iws.6","type":"blocks","created_at":"2026-01-08T16:02:59.447484-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-iws.2","title":"Implement test harness with cog binary management","description":"Create the test harness that manages the cog binary and provides custom testscript commands.\n\n## Tasks\n- Implement CogBinary resolution: COG_BINARY env var, or build from source\n- Add custom 'cog' command for testscript that wraps binary execution\n- Capture stdout/stderr properly for testscript assertions\n- Handle exit codes correctly (support ! negation)\n- Add environment setup (FIXTURES path, unique image names per test)\n\n## Key Implementation Details\n```go\nfunc (h *Harness) CmdCog(ts *testscript.TestScript, neg bool, args []string) {\n    err := ts.Exec(h.cogBinary, args...)\n    // Handle neg for expected failures\n}\n```\n\n## Acceptance Criteria\n- Tests can run 'cog predict' and 'cog build' commands\n- stdout/stderr assertions work correctly\n- Exit code handling works (! cog predict with bad input fails as expected)\n- COG_BINARY env var is respected","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T16:01:28.999357-07:00","updated_at":"2026-01-12T13:21:38.366856-07:00","closed_at":"2026-01-12T13:21:38.366856-07:00","close_reason":"Implemented test harness with: (1) CogBinary resolution via COG_BINARY env var or PATH lookup, (2) custom 'cog' command with env var expansion for testscript, (3) stdout/stderr capture via ts.Exec, (4) exit code negation support, (5) unique TEST_IMAGE per test with automatic Docker cleanup, (6) real HOME restoration for Docker credential helpers","dependencies":[{"issue_id":"cog-iws.2","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-08T16:01:28.99973-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-iws.2","depends_on_id":"cog-iws.1","type":"blocks","created_at":"2026-01-08T16:02:58.663457-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-iws.3","title":"Add output normalization and filtering","description":"Implement output normalization to handle dynamic content in CLI output.\n\n## Tasks\n- Add path normalization (replace temp dirs with $WORK, $TMPDIR)\n- Add timestamp/duration normalization if needed\n- Implement regex pattern support in stdout/stderr assertions\n- Add filters in testscript Setup function\n\n## Example Filters\n```go\nenv.Vars = append(env.Vars,\n    // Normalize paths\n    \"WORK=\"+env.WorkDir,\n)\n// In Params.Setup, add output filters for common patterns\n```\n\n## Test Cases to Validate\n- Error messages with file paths should be normalized\n- Build output with timing info should match patterns\n- Docker image IDs should be filterable\n\n## Acceptance Criteria\n- stdout 'error at $WORK/predict.py' matches actual output\n- Regex patterns work: stderr 'built in [0-9]+s'\n- Tests don't fail due to path differences across environments","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T16:01:38.351165-07:00","updated_at":"2026-01-12T17:16:40.195416-07:00","closed_at":"2026-01-12T17:16:40.195416-07:00","close_reason":"Approach changed: using embedded fixtures in txtar files instead of separate fixture directories","dependencies":[{"issue_id":"cog-iws.3","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-08T16:01:38.35256-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-iws.3","depends_on_id":"cog-iws.2","type":"blocks","created_at":"2026-01-08T16:02:58.746978-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-iws.4","title":"Migrate string-project fixture and basic predict tests","description":"Port the first real fixture from the Python test suite to validate the pattern.\n\n## Tasks\n- Copy string-project fixture to integration-tests/fixtures/string-echo/\n- Create test cases:\n  - tests/basic.txtar - basic string input/output\n  - tests/json-output.txtar - JSON output mode\n  - tests/multiple-inputs.txtar - multiple predict calls\n- Ensure fixture is a working cog model (can cd and run manually)\n- Validate test isolation (modifications don't affect source fixture)\n\n## Example Test (basic.txtar)\n```txtar\n# Test basic string prediction\ncog predict -i s=world\nstdout 'hello world'\n! stderr .\n```\n\n## Acceptance Criteria\n- go test -run TestIntegration/string-echo runs all test cases\n- go test -run TestIntegration/string-echo/basic runs single test\n- Fixture directory is a valid cog project (cd fixtures/string-echo \u0026\u0026 cog predict works)\n- Each test case runs in isolated temp directory","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T16:01:47.04415-07:00","updated_at":"2026-01-12T17:16:40.202425-07:00","closed_at":"2026-01-12T17:16:40.202425-07:00","close_reason":"Approach changed: using embedded fixtures in txtar files instead of separate fixture directories","dependencies":[{"issue_id":"cog-iws.4","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-08T16:01:47.044523-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-iws.4","depends_on_id":"cog-iws.3","type":"blocks","created_at":"2026-01-08T16:02:58.840409-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-iws.5","title":"Migrate file input/output test fixtures","description":"Port fixtures that test file I/O to validate binary asset handling.\n\n## Tasks\n- Migrate file-input-project fixture\n- Migrate path-input-project fixture  \n- Migrate path-list-output-project fixture\n- Create test cases for:\n  - File input via -i file=@path\n  - Path input handling\n  - File/path list outputs\n- Handle binary assets (images) in test cases\n\n## Fixtures to Port\n- file-input-project\n- path-input-project\n- path-list-input-project\n- path-list-output-project\n- file-list-input-project\n\n## Acceptance Criteria\n- Binary files (images) work as test inputs\n- Output file comparison works (cmp output.txt expected.txt)\n- exists command validates output files created","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T16:01:55.12797-07:00","updated_at":"2026-01-12T17:16:40.206928-07:00","closed_at":"2026-01-12T17:16:40.206928-07:00","close_reason":"Approach changed: using embedded fixtures in txtar files instead of separate fixture directories","dependencies":[{"issue_id":"cog-iws.5","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-08T16:01:55.128314-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-iws.5","depends_on_id":"cog-iws.4","type":"blocks","created_at":"2026-01-08T16:02:58.939936-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-iws.6","title":"Migrate build command tests","description":"Port test_build.py tests to the new framework.\n\n## Tasks\n- Add docker-image-exists custom command\n- Add cleanup-image custom command (or use t.Cleanup)\n- Migrate fixtures:\n  - fast-build\n  - torch-baseimage-project\n  - torch-cuda-baseimage-project\n- Create test cases for:\n  - Basic build\n  - Build with custom tag\n  - Build with GPU/CUDA base images\n  - Verify image labels (openapi schema, config)\n\n## Custom Commands Needed\n```go\nfunc (h *Harness) CmdImageExists(ts *testscript.TestScript, neg bool, args []string) {\n    // docker image inspect \u003ctag\u003e\n}\n```\n\n## Acceptance Criteria\n- Build tests create and clean up Docker images\n- Image inspection/label tests work\n- GPU-related tests can be skipped with [!gpu] condition","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T16:02:04.299521-07:00","updated_at":"2026-01-12T17:16:40.210397-07:00","closed_at":"2026-01-12T17:16:40.210397-07:00","close_reason":"Approach changed: using embedded fixtures in txtar files instead of separate fixture directories","dependencies":[{"issue_id":"cog-iws.6","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-08T16:02:04.299894-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-iws.6","depends_on_id":"cog-iws.4","type":"blocks","created_at":"2026-01-08T16:02:59.044916-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-iws.7","title":"Migrate train command tests","description":"Port test_train.py tests and training fixtures.\n\n## Tasks\n- Migrate train-project fixture\n- Migrate training-setup-project fixture\n- Create test cases for:\n  - Basic training execution\n  - Training with setup\n  - Training output/weights validation\n\n## Fixtures to Port\n- train-project\n- training-setup-project\n\n## Acceptance Criteria\n- cog train command works in test harness\n- Training output can be validated\n- Weights files are created as expected","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T16:02:10.027969-07:00","updated_at":"2026-01-12T17:16:40.213929-07:00","closed_at":"2026-01-12T17:16:40.213929-07:00","close_reason":"Approach changed: using embedded fixtures in txtar files instead of separate fixture directories","dependencies":[{"issue_id":"cog-iws.7","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-08T16:02:10.02833-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-iws.7","depends_on_id":"cog-iws.6","type":"blocks","created_at":"2026-01-08T16:02:59.147099-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-iws.8","title":"Add CI integration for Go integration tests","description":"Add GitHub Actions workflow for running the new Go integration tests.\n\n## Tasks\n- Create .github/workflows/integration-tests.yaml (or add to existing ci.yaml)\n- Ensure Docker is available in CI environment\n- Set up proper cog binary building before tests\n- Configure test output visibility (no swallowed output)\n- Add timeout configuration\n\n## Workflow Requirements\n- Build cog binary\n- Run go test ./integration-tests/... -v\n- Proper Docker socket access\n- Test output streaming (not buffered until end)\n\n## Acceptance Criteria\n- CI runs integration tests on PR\n- Test failures show clear output\n- Docker operations work in CI environment\n- Reasonable timeout (not 30+ minutes)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T16:02:18.318452-07:00","updated_at":"2026-02-02T13:57:38.44328-07:00","closed_at":"2026-02-02T13:57:38.44328-07:00","close_reason":"Integration test rewrite complete","dependencies":[{"issue_id":"cog-iws.8","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-08T16:02:18.318827-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-iws.8","depends_on_id":"cog-iws.4","type":"blocks","created_at":"2026-01-08T16:02:59.241013-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-iws.9","title":"Document test framework and add migration guide","description":"Update documentation with instructions for using and extending the test framework.\n\n## Tasks\n- Update AGENTS.md with integration test instructions\n- Update CONTRIBUTING.md with test contribution guide\n- Document:\n  - Directory structure and conventions\n  - How to add a new fixture\n  - How to add test cases to existing fixture\n  - Available custom commands (cog, docker-image-exists, etc.)\n  - Available conditions ([docker], [gpu], etc.)\n  - How to run specific tests\n  - How to update snapshots\n\n## Documentation Sections\n1. Running integration tests\n2. Adding a new fixture\n3. Writing test cases (txtar format)\n4. Custom commands reference\n5. Debugging failed tests\n\n## Acceptance Criteria\n- New contributor can add a test without reading framework code\n- AGENTS.md has clear instructions for AI agents\n- Examples are included for common patterns","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T16:02:26.430609-07:00","updated_at":"2026-02-02T13:57:38.445001-07:00","closed_at":"2026-02-02T13:57:38.445001-07:00","close_reason":"Integration test rewrite complete","dependencies":[{"issue_id":"cog-iws.9","depends_on_id":"cog-iws","type":"parent-child","created_at":"2026-01-08T16:02:26.430964-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-iws.9","depends_on_id":"cog-iws.4","type":"blocks","created_at":"2026-01-08T16:02:59.344303-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-jft","title":"Wire COG_OCI_INDEX env var into CLI build/push flags","description":"The `OCIIndexEnabled()` function exists in `pkg/model/format.go` but is never called from production code. `buildOptionsFromFlags()` in `pkg/cli/build.go:184-199` never sets `BuildOptions.OCIIndex`.\n\n## Fix\nIn `buildOptionsFromFlags()`, add:\n```go\nOCIIndex: model.OCIIndexEnabled(),\n```\n\nThis reads `COG_OCI_INDEX=1` from the environment and enables the OCI index push path.\n\n## Files to modify\n- `pkg/cli/build.go` — add OCIIndex field to buildOptionsFromFlags()\n\nOne-line change.","status":"open","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-06T13:33:41.537006-07:00","created_by":"Michael Dwan","updated_at":"2026-02-06T13:33:41.537006-07:00"}
{"id":"cog-k1j","title":"Fix flaky interactive TTY integration tests","status":"closed","priority":1,"issue_type":"bug","owner":"mdwan@cloudflare.com","created_at":"2026-02-04T12:33:16.419267-07:00","created_by":"Michael Dwan","updated_at":"2026-02-04T12:33:23.966767-07:00","closed_at":"2026-02-04T12:33:23.966767-07:00","close_reason":"Replaced Go-based PTY tests with txtar tests using creack/pty which works on both Linux and macOS (unlike testscript's native ttyin/ttyout which hangs on macOS due to Go bug #61779)"}
{"id":"cog-k6r","title":"Fix flaky TestLoginGenericRegistryPTY test with race condition in PTY reader","status":"closed","priority":1,"issue_type":"bug","owner":"mdwan@cloudflare.com","created_at":"2026-02-03T16:56:39.768454-07:00","created_by":"Michael Dwan","updated_at":"2026-02-03T16:58:36.191194-07:00","closed_at":"2026-02-03T16:58:36.191194-07:00","close_reason":"Fixed race condition in PTY reader by using single shared buffer"}
{"id":"cog-kgb","title":"Add hidden `cog weights inspect` command","description":"Hidden subcommand under `cog weights` that compares local weights state against remote registry state. Answers: 'do my local weights match what's in the registry?'\n\n## Command\n`cog weights inspect \u003cref\u003e`\n\nArgs: exactly one (registry reference, required — explicit is better for a debug tool).\nFlags: `--json` (default is human-readable text)\n\n## Output\n\n### Reconciliation view: local vs remote\n\nShows three sections:\n1. **Local state** (from cog.yaml + weights.lock): declared weights, lockfile digests/sizes, file-exists-on-disk\n2. **Remote state** (from registry): weight manifests in the index, digests/sizes/annotations\n3. **Comparison**: per-weight status — `synced`, `local-only`, `remote-only`, `digest-mismatch`, `missing-lockfile`\n\n### Text output example\n```\nWeights for: r8.im/user/model:latest\n\n  model-v1\n    Status:  synced\n    Local:   sha256:abc123... (4.2 GB) -\u003e /cache/model.safetensors\n    Remote:  sha256:abc123... (4.2 GB)\n\n  tokenizer\n    Status:  local-only (not pushed)\n    Local:   sha256:def456... (128 MB) -\u003e /cache/tokenizer.json\n    Remote:  -\n\n  old-weights\n    Status:  remote-only (not in cog.yaml)\n    Local:   -\n    Remote:  sha256:789abc... (2.1 GB)\n```\n\n### JSON output (`--json`)\n```json\n{\n  \"reference\": \"r8.im/user/model:latest\",\n  \"weights\": [\n    {\n      \"name\": \"model-v1\",\n      \"status\": \"synced\",\n      \"local\": {\"digest\": \"sha256:abc123...\", \"size\": 4200000000, \"target\": \"/cache/model.safetensors\", \"fileExists\": true},\n      \"remote\": {\"digest\": \"sha256:abc123...\", \"size\": 4200000000, \"mediaType\": \"...\"}\n    }\n  ]\n}\n```\n\n## Implementation\n\n### Modify: pkg/cli/weights.go\n- Add `newWeightsInspectCommand()` to the existing `weightsCommand`\n- Inherits hidden status from parent\n\n### Flow\n1. Load local state: `model.NewSource()` for cog.yaml, `model.LoadWeightsLock()` for lockfile\n2. For each declared weight: check if source file exists on disk, get file size\n3. Resolve remote: create resolver, call `Inspect()` on the ref\n4. Extract weight manifests from `Model.Index` (if it's an index)\n5. Match local weights to remote by name\n6. Build comparison output with status per weight\n7. Output as JSON or text\n\n### Comparison logic\n- Match by weight name (from lockfile name \u003c-\u003e annotation name)\n- `synced`: exists in both, digests match\n- `local-only`: in lockfile but not in remote index\n- `remote-only`: in remote index but not in cog.yaml/lockfile\n- `digest-mismatch`: exists in both but digests differ\n- `missing-lockfile`: declared in cog.yaml but no lockfile entry (needs `cog weights build` first)\n\n## Key decisions\n- Required CLI argument for registry ref (no auto-detect from cog.yaml)\n- Local state comes from cog.yaml + weights.lock + filesystem\n- Remote state comes from resolver.Inspect() on the ref\n- No modifications to resolver or registry client needed","status":"open","priority":1,"issue_type":"feature","owner":"mdwan@cloudflare.com","created_at":"2026-02-06T13:33:20.422696-07:00","created_by":"Michael Dwan","updated_at":"2026-02-06T13:33:20.422696-07:00"}
{"id":"cog-kue","title":"Build minimal Go test harness for E2E tests","description":"Build a Go test harness that:\n1. Discovers fixtures by walking test-e2e/fixtures/\n2. For each fixture:\n   - Builds the model image (cog build)\n   - Runs test cases (cog predict)\n   - Compares actual vs expected output\n3. Supports running against both runtimes\n4. Reports differences clearly\n\nKeep it minimal initially - can iterate later.\n\nDepends on: cog-b0l (fixture format design)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T15:14:35.708506-07:00","updated_at":"2026-02-02T13:57:52.681253-07:00","closed_at":"2026-02-02T13:57:52.681253-07:00","close_reason":"Closed with parent testing/coglet epics","dependencies":[{"issue_id":"cog-kue","depends_on_id":"cog-tdd","type":"blocks","created_at":"2025-12-15T15:14:35.708935-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-kvk","title":"Simplify NewClient factory in docker.go","description":"Simplify pkg/docker/docker.go NewClient() function to always return NewAPIClient(). Remove COG_DOCKER_SDK_CLIENT environment variable check and conditional logic.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:31.691757-07:00","updated_at":"2025-12-11T16:24:44.915894-07:00","closed_at":"2025-12-11T16:24:44.915894-07:00","dependencies":[{"issue_id":"cog-kvk","depends_on_id":"cog-5d6","type":"parent-child","created_at":"2025-12-11T16:02:31.692248-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-kx1","title":"Verify coglet tests pass with new paths","description":"After all code moves, verify coglet tests pass:\n- Go tests in coglet/internal/tests/\n- Python tests in coglet/python/tests/\n\nMay need to update test paths, fixtures locations, etc.\n\nDepends on: cog-1ys (Makefile integration)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:13:19.43424-07:00","updated_at":"2025-12-15T16:16:11.784554-07:00","closed_at":"2025-12-15T16:16:11.784554-07:00","dependencies":[{"issue_id":"cog-kx1","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:13:19.434676-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-l09","title":"Integrate cog-runtime into cog repository","description":"Bring the cog-runtime (coglet) code into the main cog repository to enable unified development, testing, and releases. This involves moving code, updating import paths, integrating build systems, and eventually unifying the test suite.\n\nTarget state: Both runtimes (Python FastAPI-based 'cog' and Go/Python hybrid 'coglet') coexist in the same repo, with coglet used when cog_runtime: true is set in cog.yaml.\n\nPhases:\n1. Code Integration - Move files, update paths, get tests passing\n2. Wire Up Runtime Selection - Make cog CLI properly use integrated coglet\n3. Unified E2E Test Suite - Same fixtures, both runtimes\n4. Cleanup \u0026 Documentation","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-15T15:11:52.051104-07:00","updated_at":"2026-02-02T13:57:39.398845-07:00","closed_at":"2026-02-02T13:57:39.398845-07:00","close_reason":"Coglet integration complete"}
{"id":"cog-l4s","title":"Remove fast/monobase/monobeam build system","design":"# Remove fast/monobase/monobeam Build System\n\n## Overview\n\nThe fast build mode (monobase/monobeam) was an experimental feature that should not have been released publicly. It has significant issues and is deprecated. This plan removes all fast/monobase/monobeam code from the codebase to:\n\n1. Simplify the codebase by removing a deprecated feature\n2. Consolidate on a single build model (standard builds)\n3. Remove technical debt\n\n## Deprecation Strategy\n\n- **Config**: Hard error if `fast: true` is present in cog.yaml, instructing users to remove the field\n- **CLI**: Remove `--x-fast` flag entirely (users get \"unknown flag\" error)\n- **python_overrides**: Also remove this fast-only feature\n\n## Files to DELETE Entirely (12 files)\n\n| File | Purpose |\n|------|---------|\n| `pkg/monobeam/client.go` | Monobeam S3 upload client |\n| `pkg/monobeam/client_test.go` | Tests |\n| `pkg/dockerfile/fast_generator.go` | Fast Dockerfile generator using monobase |\n| `pkg/dockerfile/fast_generator_test.go` | Tests |\n| `pkg/dockerfile/monobase_matrix.go` | Version compatibility matrix fetcher |\n| `pkg/dockerfile/monobase_matrix_test.go` | Tests |\n| `pkg/docker/fast_push.go` | Fast push implementation |\n| `pkg/docker/fast_push_test.go` | Tests |\n| `pkg/docker/monobase.go` | APT tarball creation using monobase |\n| `pkg/docker/monobase_test.go` | Tests |\n| `integration-tests/tests/fast_build.txtar` | Fast build integration test |\n| `integration-tests/tests/run_fast_build.txtar` | Fast run integration test |\n\n## Integration Tests to DELETE (fast-only features)\n\n| File | Reason |\n|------|--------|\n| `integration-tests/tests/overrides.txtar` | Tests python_overrides (fast-only feature) |\n\n## Integration Tests to MODIFY (remove `fast: true`)\n\n| File | Change |\n|------|--------|\n| `integration-tests/tests/local_whl_install.txtar` | Remove `fast: true` line |\n| `integration-tests/tests/install_requires_packaging.txtar` | Remove `fast: true` line |\n| `integration-tests/tests/complex_types.txtar` | Remove `fast: true` line |\n| `integration-tests/tests/complex_types_list.txtar` | Remove `fast: true` line |\n\n## Config Changes\n\n**`pkg/config/config.go`:**\n- Remove `Fast bool` field from `Build` struct (line 58)\n- Remove `PythonOverrides string` field from `Build` struct (line 60)\n- Add validation that errors if `fast: true` or `python_overrides` is present\n\n**`pkg/config/data/config_schema_v1.0.json`:**\n- Remove `fast` property (lines 149-152)\n- Remove `python_overrides` property (lines 159-162)\n\n## CLI Changes\n\n**Remove `--x-fast` flag:**\n- `pkg/cli/build.go` - Remove flag definition (lines 31, 180-183) and all usage\n\n**Remove fast logic from commands:**\n- `pkg/cli/build.go` - Remove buildFast variable, fast checks\n- `pkg/cli/push.go` - Remove fast checks, simplify Push call\n- `pkg/cli/predict.go` - Remove fast checks\n- `pkg/cli/run.go` - Remove useFast logic\n- `pkg/cli/train.go` - Remove fast checks\n- `pkg/cli/serve.go` - Remove fast check\n- `pkg/cli/debug.go` - Remove buildFast parameter\n\n## Model Package Changes\n\n**`pkg/model/options.go`:**\n- Remove `Fast bool` field from `BuildOptions` (lines 17-20)\n\n**`pkg/model/factory.go`:**\n- Remove fast mode branching in `Build()` (lines 44-47)\n\n**`pkg/model/model.go`:**\n- Remove `IsFast()` method (lines 24-26)\n\n**`pkg/model/model_test.go`:**\n- Remove `TestModel_IsFast` test\n\n**`pkg/model/options_test.go`:**\n- Update tests referencing `opts.Fast` or `result.Fast`\n\n## Dockerfile Package Changes\n\n**`pkg/dockerfile/generator_factory.go`:**\n- Remove `buildFast` parameter from `NewGenerator()`\n- Always return `NewStandardGenerator()`\n\n## Docker Package Changes\n\n**`pkg/docker/push.go`:**\n- Remove `fast bool` parameter from `Push()`\n- Remove monobeam client initialization\n- Remove `FastPush` call branch\n\n## Image Package Changes\n\n**`pkg/image/build.go`:**\n- Remove `fastFlag` parameter from `Build()` (line 55)\n- Remove fast-related console messages (lines 60-62)\n- Update `GeneratePipFreeze` call\n\n**`pkg/image/pip_freeze.go`:**\n- Remove fast-specific venv path handling\n\n## Docker Context Changes\n\n**`pkg/dockercontext/directories.go`:**\n- Remove `MonobaseBuildContextName` constant\n- Remove `MonobaseBuildDir` variable\n\n## Environment Changes\n\n**`pkg/env/env.go`:**\n- Remove `MonobeamHostEnvVarName` constant\n- Remove `MonobeamHostFromEnvironment()` function\n\n**`pkg/env/env_test.go`:**\n- Remove monobeam-related test\n\n## Coglog (Telemetry) Changes\n\n**`pkg/coglog/client.go`:**\n- Remove `Fast` field from `buildLog` and `pushLog` structs\n- Remove `Fast` assignment in `EndBuild` and `EndPush`\n\n**`pkg/coglog/build_log_context.go`:**\n- Remove `Fast` field\n\n**`pkg/coglog/push_log_context.go`:**\n- Remove `Fast` field\n\n## Error Changes\n\n**`pkg/errors/common.go`:**\n- Remove `ErrorBadRegistryHost` (fast-specific error)\n\n## Test Changes\n\n**`pkg/config/config_test.go`:**\n- Remove `TestFastPushConfig`\n- Remove `TestPythonOverridesConfig`\n\n**`pkg/util/overwrite_yaml_test.go`:**\n- Remove `fast: true` from test data\n\n**`pkg/docker/dockertest/mock_command.go`:**\n- Remove monobase hack (lines 107-108)\n\n## Documentation Changes\n\n**`integration-tests/README.md`:**\n- Remove monobase references (lines 192, 230, 334)\n\n## Implementation Order\n\n1. Delete all monobeam/monobase files (clean slate)\n2. Update config to remove fields and add validation\n3. Update CLI to remove flag and fast logic\n4. Update model package\n5. Update dockerfile generator factory\n6. Update docker push\n7. Update image build\n8. Update pip_freeze\n9. Update dockercontext\n10. Update env package\n11. Update coglog\n12. Update errors\n13. Update/delete integration tests\n14. Update tests\n15. Update README\n16. Run linter and fix any issues\n17. Run tests to verify nothing is broken","status":"closed","priority":1,"issue_type":"epic","owner":"mdwan@cloudflare.com","created_at":"2026-02-02T12:38:18.909614-07:00","created_by":"Michael Dwan","updated_at":"2026-02-02T13:55:37.046843-07:00","closed_at":"2026-02-02T13:55:37.046843-07:00","close_reason":"PR #2675 created: https://github.com/replicate/cog/pull/2675"}
{"id":"cog-llm","title":"Move Go server code to coglet/internal/","description":"Move cog-runtime/internal/* to coglet/internal/\n\nPackages to move:\n- config/\n- logging/\n- loggingtest/\n- runner/\n- server/\n- service/\n- tests/\n- version/\n- webhook/\n\nUpdate Go import paths from github.com/replicate/cog-runtime/internal/* to github.com/replicate/cog/coglet/internal/*\n\nDepends on: cog-68z (directory structure)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:12:34.170272-07:00","updated_at":"2025-12-15T15:27:38.727892-07:00","closed_at":"2025-12-15T15:27:38.727892-07:00","dependencies":[{"issue_id":"cog-llm","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:12:34.170699-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-lmi","title":"Update standard_push_test.go to use new client","description":"In pkg/docker/standard_push_test.go: Change NewDockerCommand() call to NewClient(t.Context()) to use the factory method instead of directly instantiating old client.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:24.016779-07:00","updated_at":"2025-12-11T16:02:58.557465-07:00","closed_at":"2025-12-11T16:02:58.557465-07:00"}
{"id":"cog-m4x","title":"Integrate CA cert installation into StandardGenerator","description":"## Task\n\nModify `pkg/dockerfile/standard_generator.go` to call `installCACert()` at the right point in the Dockerfile generation.\n\n## Location in Build Process\n\nCA cert must be installed:\n- AFTER apt installs (needs `ca-certificates` package and `update-ca-certificates` command)\n- BEFORE Python installation (pyenv fetches from GitHub over HTTPS)\n- BEFORE pip installs (fetches from PyPI over HTTPS)\n\n## Changes to GenerateInitialSteps()\n\n### For cog-base image path (~line 170-186):\n\n```go\nif g.IsUsingCogBaseImage() {\n    // NEW: Add CA cert installation\n    caCertInstall, err := g.installCACert()\n    if err != nil {\n        return \"\", err\n    }\n\n    steps := []string{\n        \"#syntax=docker/dockerfile:1.4\",\n        \"FROM \" + baseImage,\n        envs,\n        aptInstalls,\n        caCertInstall,  // \u003c-- NEW: after apt\n    }\n    if installCog != \"\" {\n        steps = append(steps, installCog)\n    }\n    // ... rest unchanged\n}\n```\n\n### For non-cog-base path (~line 189-205):\n\n```go\n// NEW: Add CA cert installation\ncaCertInstall, err := g.installCACert()\nif err != nil {\n    return \"\", err\n}\n\nsteps := []string{\n    \"#syntax=docker/dockerfile:1.4\",\n    \"FROM \" + baseImage,\n    g.preamble(),\n    g.installTini(),\n    envs,\n    aptInstalls,\n    caCertInstall,  // \u003c-- NEW: after apt, before Python\n    installPython,\n    pipInstalls,\n    installCog,\n}\n```\n\n## Important Notes\n\n- `caCertInstall` may be empty string (when COG_CA_CERT not set)\n- Empty strings are filtered out by `joinStringsWithoutLineSpace()`, so no conditional needed\n- The `installCACert()` function is defined in `cacert.go` (previous task)\n\n## File to Modify\n\n`pkg/dockerfile/standard_generator.go`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T11:14:48.739716-07:00","updated_at":"2026-01-14T13:20:27.650547-07:00","closed_at":"2026-01-14T13:20:27.650547-07:00","close_reason":"Implemented CA cert injection via COG_CA_CERT","dependencies":[{"issue_id":"cog-m4x","depends_on_id":"cog-yuu","type":"discovered-from","created_at":"2026-01-14T11:15:38.052081-07:00","created_by":"Matt Dwan","metadata":"{}"},{"issue_id":"cog-m4x","depends_on_id":"cog-gmf","type":"blocks","created_at":"2026-01-14T11:15:43.398453-07:00","created_by":"Matt Dwan","metadata":"{}"}]}
{"id":"cog-mqn","title":"Remove Docker client matrix from test-go job in CI","description":"In .github/workflows/ci.yaml: Remove new_docker_api_client matrix dimension from test-go job (line 77) and remove COG_DOCKER_SDK_CLIENT env var (line 98). This eliminates half the test jobs.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:40.452011-07:00","updated_at":"2025-12-11T16:25:58.569212-07:00","closed_at":"2025-12-11T16:25:58.569212-07:00","dependencies":[{"issue_id":"cog-mqn","depends_on_id":"cog-5d6","type":"parent-child","created_at":"2025-12-11T16:02:40.452461-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-mrj","title":"Implement COG_WHEEL environment variable parsing","description":"Add COG_WHEEL environment variable support for selecting which runtime wheel to use during cog build.\n\n## Supported Values\n- 'cog' - Embedded Python FastAPI runtime (default when cog_runtime: false)\n- 'coglet' - Embedded coglet wheel (v0.4.0+ rewrite)\n- 'coglet-alpha' - PinnedCogletURL (default when cog_runtime: true)\n- 'https://...' - Direct wheel URL\n- '/path/to/file.whl' - Local wheel file\n\n## Changes\n1. Create pkg/dockerfile/wheel.go with:\n   - WheelSource type (enum: Cog, CogletEmbedded, CogletAlpha, URL, File)\n   - WheelConfig struct (Source, URL, Path fields)\n   - ParseCogWheel(value string) (*WheelConfig, error)\n   - GetWheelConfig(cogRuntimeEnabled bool) (*WheelConfig, error)\n   - Handle defaults based on cog_runtime flag\n2. Create pkg/dockerfile/wheel_test.go with tests for:\n   - All supported value formats\n   - Default behavior with/without cog_runtime\n   - Invalid input handling\n   - URL vs file path detection\n\n## Files\n- pkg/dockerfile/wheel.go (new file)\n- pkg/dockerfile/wheel_test.go (new file)\n\n## Acceptance Criteria\n- ParseCogWheel correctly identifies all supported formats\n- GetWheelConfig returns correct defaults based on cog_runtime flag\n- Tests cover all parsing scenarios","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T17:53:43.59566-07:00","updated_at":"2025-12-17T12:06:27.499664-07:00","closed_at":"2025-12-17T12:06:27.499664-07:00","dependencies":[{"issue_id":"cog-mrj","depends_on_id":"cog-1rk","type":"parent-child","created_at":"2025-12-16T17:53:43.596203-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-mvv","title":"Phase 1: Artifact Abstraction Foundation — core interfaces and types","description":"## Goal\n\nIntroduce the core artifact abstraction types without changing existing behavior. This is purely additive — new files, no modifications to existing code paths.\n\n## Work Items\n\n1. **pkg/model/artifact.go** — Define core interfaces and enums:\n   - `ArtifactType` enum (Image, Weight)\n   - `ArtifactSpec` interface: `Type() ArtifactType`, `Name() string`\n   - `Artifact` interface: `Type() ArtifactType`, `Name() string`, `Descriptor() v1.Descriptor`\n\n2. **pkg/model/artifact_image.go** — Image artifact types:\n   - `ImageSpec` struct implementing `ArtifactSpec` (fields: name, ImageName, Secrets, NoCache, etc. — derived from BuildOptions)\n   - `ImageArtifact` struct implementing `Artifact` (fields: name, descriptor, reference)\n\n3. **pkg/model/artifact_weight.go** — Weight artifact types:\n   - `WeightSpec` struct implementing `ArtifactSpec` (fields: name, source path, target mount path)\n   - `WeightArtifact` struct implementing `Artifact` (fields: name, descriptor, filePath, target, config)\n   - `WeightConfig` struct with versioned schema (schemaVersion, cogVersion, name, target, created)\n   - Media type constants: MediaTypeWeightArtifact, MediaTypeWeightConfig, MediaTypeWeightLayer, MediaTypeWeightLayerGzip\n\n4. **Source.ArtifactSpecs()** — Add method to existing `Source` struct in source.go:\n   - Always produces an `ImageSpec` from config\n   - Produces `WeightSpec` for each weight in config\n\n5. **Model.Artifacts field** — Add to existing `Model` struct in model.go:\n   - `Artifacts []Artifact` field\n   - Helper methods: `ImageArtifact()`, `WeightArtifacts()`, `ArtifactsByType(t)`\n\n6. **Update Resolver.Build()** — After building, populate `Model.Artifacts` from the built image (create an `ImageArtifact` from the result)\n\n## Tests\n\n- Unit tests for all new types (interfaces, constructors, methods)\n- Verify `Source.ArtifactSpecs()` produces correct specs from config\n- Verify `Model` helper methods work correctly\n- Ensure all existing tests still pass\n\n## Files to Create\n- pkg/model/artifact.go + artifact_test.go\n- pkg/model/artifact_image.go + artifact_image_test.go\n- pkg/model/artifact_weight.go + artifact_weight_test.go\n\n## Files to Modify\n- pkg/model/source.go (add ArtifactSpecs method)\n- pkg/model/model.go (add Artifacts field + helpers)\n- pkg/model/resolver.go (populate Artifacts in Build)\n\n## Design Reference\ndocs/plans/2026-02-05-artifact-abstraction-design.md — \"Phase 1: Artifact Abstraction (Foundation)\"","status":"closed","priority":1,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-02-05T12:36:04.075955-07:00","created_by":"Michael Dwan","updated_at":"2026-02-05T13:04:20.926593-07:00","closed_at":"2026-02-05T13:04:20.926593-07:00","close_reason":"Implemented Phase 1 artifact abstraction foundation","dependencies":[{"issue_id":"cog-mvv","depends_on_id":"cog-26r","type":"discovered-from","created_at":"2026-02-05T12:36:07.01035-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-n71","title":"Update documentation for coglet runtime","description":"Update docs/ to cover coglet:\n- How to enable coglet (cog_runtime: true)\n- Differences/benefits vs default runtime\n- Any API differences users should know about\n- Update docs/llms.txt with coglet information","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T15:15:05.551023-07:00","updated_at":"2026-02-02T13:57:39.411644-07:00","closed_at":"2026-02-02T13:57:39.411644-07:00","close_reason":"Coglet integration complete","dependencies":[{"issue_id":"cog-n71","depends_on_id":"cog-vbg","type":"blocks","created_at":"2025-12-15T15:15:05.551521-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-nns","title":"Remove cog migrate command and dead code","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-30T14:29:29.706063-07:00","created_by":"Michael Dwan","updated_at":"2026-01-30T14:33:51.348008-07:00","closed_at":"2026-01-30T14:33:51.348008-07:00","close_reason":"Removed cog migrate command and all dead code"}
{"id":"cog-o98","title":"Update documentation for COG_CA_CERT","description":"## Task\n\nUpdate `docs/environment.md` to document the COG_CA_CERT environment variable.\n\n## Content to Add\n\nAdd a new section after COG_NO_UPDATE_CHECK:\n\n```markdown\n### `COG_CA_CERT`\n\nInjects a custom CA certificate into images built by Cog. This is useful when working behind a corporate proxy or VPN that performs TLS interception.\n\nThe certificate is installed into the system certificate store and environment variables are set so that common tools (Python requests, pip, curl, Node.js) trust it automatically.\n\n**Supported formats:**\n\n| Format | Example |\n|--------|---------|\n| File path | `/path/to/cert.crt` |\n| Directory | `/path/to/certs/` (all .crt/.pem files) |\n| Inline PEM | `-----BEGIN CERTIFICATE-----...` |\n| Base64-encoded PEM | `LS0tLS1CRUdJTi...` |\n\n**Example usage:**\n\n```console\n# Using a file path\n$ export COG_CA_CERT=/path/to/corporate-ca.crt\n$ cog build\n\n# Using inline PEM (useful in CI)\n$ export COG_CA_CERT=\"$(cat /path/to/cert.crt)\"\n$ cog build\n```\n\n**Tip:** Set this in your shell profile, direnv (`.envrc`), or mise config so it applies automatically to all Cog commands.\n\nWhen this variable is not set, no certificate is injected and images are built normally.\n```\n\n## File to Modify\n\n`docs/environment.md`\n\n## Verification\n\nAfter updating, check the docs render correctly:\n```bash\ncd docs \u0026\u0026 mkdocs serve\n# Open http://localhost:8000/environment/\n```","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T11:15:32.062943-07:00","updated_at":"2026-01-14T11:15:32.062943-07:00","dependencies":[{"issue_id":"cog-o98","depends_on_id":"cog-yuu","type":"discovered-from","created_at":"2026-01-14T11:15:38.433977-07:00","created_by":"Matt Dwan","metadata":"{}"}]}
{"id":"cog-p27","title":"Move coglet-server binary to cmd/coglet-server/","description":"Move cog-runtime/cmd/cog/main.go to cmd/coglet-server/main.go\n\nUpdate imports to use new coglet/internal/ paths.\n\nThis binary provides: server, schema, test subcommands for the container runtime.\n\nDepends on: cog-llm (Go server code move)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:12:39.803619-07:00","updated_at":"2025-12-15T16:02:42.473227-07:00","closed_at":"2025-12-15T16:02:42.473227-07:00","dependencies":[{"issue_id":"cog-p27","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:12:39.804126-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-p52","title":"Move Python coglet SDK to coglet/python/","description":"Move cog-runtime/python/coglet/ to coglet/python/coglet/\nMove cog-runtime/python/cog/ to coglet/python/cog/ (compatibility shim)\nMove cog-runtime/python/tests/ to coglet/python/tests/\n\nThe coglet/ package is the core SDK (api.py, runner.py, schema.py, etc.)\nThe cog/ package is the compatibility shim that re-exports from coglet.\n\nDepends on: cog-68z (directory structure)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:12:45.99922-07:00","updated_at":"2025-12-15T16:03:14.094596-07:00","closed_at":"2025-12-15T16:03:14.094596-07:00","dependencies":[{"issue_id":"cog-p52","depends_on_id":"cog-4gd","type":"blocks","created_at":"2025-12-15T15:12:45.999682-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-r91","title":"End-to-end test: cog build with cog_runtime: true","description":"Verify the full flow works:\n1. Create a test model with cog_runtime: true in cog.yaml\n2. Run cog build\n3. Verify the image contains coglet wheel and coglet-server\n4. Run cog predict and verify it works\n\nThis validates Phase 2 is complete.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:14:12.417311-07:00","updated_at":"2026-02-02T13:57:52.675664-07:00","closed_at":"2026-02-02T13:57:52.675664-07:00","close_reason":"Closed with parent testing/coglet epics","dependencies":[{"issue_id":"cog-r91","depends_on_id":"cog-vli","type":"blocks","created_at":"2025-12-15T15:14:12.417813-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-rqd","title":"Delete docker_command_test.go test file","description":"Delete pkg/docker/docker_command_test.go which contains standalone tests for the old DockerCommand client.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:17.924269-07:00","updated_at":"2025-12-11T16:02:58.558901-07:00","closed_at":"2025-12-11T16:02:58.558901-07:00"}
{"id":"cog-siv","title":"Migrate key fixtures from existing test suites","description":"Migrate important test fixtures from:\n- test-integration/test_integration/fixtures/\n- cog-runtime/python/tests/runners/\n\nFocus on fixtures that test:\n- Basic string input/output\n- Numeric types with validation (ge, le)\n- File/Path inputs\n- Streaming outputs (ConcatenateIterator)\n- Async predictors\n- Error handling\n\nDepends on: cog-kue (test harness built)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T15:14:42.073238-07:00","updated_at":"2026-02-02T13:57:52.682813-07:00","closed_at":"2026-02-02T13:57:52.682813-07:00","close_reason":"Closed with parent testing/coglet epics","dependencies":[{"issue_id":"cog-siv","depends_on_id":"cog-tdd","type":"blocks","created_at":"2025-12-15T15:14:42.073732-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-skd","title":"Fix race condition in file IPC: Python reads empty request files","description":"## Problem\nWhen Go writes request files for Python IPC, Python occasionally reads them before they're fully written, causing `JSONDecodeError: Expecting value: line 1 column 1 (char 0)`.\n\n## Root Cause\nGo's `os.WriteFile` is NOT atomic - it can leave files in partially written state. From Go docs: 'Since WriteFile requires multiple system calls to complete, a failure mid-operation can leave the file in a partially written state.'\n\nThis causes a race condition:\n1. Go creates/truncates the file (file now exists but is empty)\n2. Go writes content to the file\n3. Python's directory scan sees the file and tries to read it\n4. If Python reads between steps 1 and 2, it sees an empty file\n\n## Files Involved\n- `coglet/internal/runner/runner.go:866` - Uses `os.WriteFile` for request files\n- `coglet/python/coglet/file_runner.py:170` - Reads request files with `json.load(f)`\n\n## Proposed Fix\nReplace `os.WriteFile` with atomic file writes:\n1. Write to a temp file with a `.tmp-*` prefix\n2. Sync to disk\n3. Atomic rename to target path\n\n## Investigation Update (2025-12-16)\n\n### Root Cause of CI 'Killed' Signal: OOM from Parallel Test Execution\n\n**Found it!** 50+ tests use `t.Parallel()` which spawns many Python subprocesses simultaneously:\n```bash\ngrep -c 't.Parallel()' coglet/internal/tests/*.go # Returns 50\n```\n\nOn CI's 4-core Ubuntu runner, this causes OOM (out-of-memory) killing.\n\n### Fix Applied in Makefile\nChanged from:\n```make\n tool gotestsum -- -timeout 600s -p 1 ./coglet/...\n```\n\nTo:\n```make\n tool gotestsum -- -timeout 600s -p 1 -parallel 4 ./coglet/...\n```\n\nThe `-parallel 4` flag limits concurrent tests within a package to 4, preventing resource exhaustion.\n\n### Tests pass locally\n- With `-parallel 4`: 23 seconds, all pass\n- Without limit: 15 seconds, all pass (but uses more resources)\n\n### This is SEPARATE from the file IPC race condition\nThe 'killed' signal was from OOM, not JSON decode errors. The file IPC race condition may still exist but manifests as JSON decode errors, not process kills.\n\n### Next: Test this fix in CI\nPush the Makefile change and verify CI passes.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-16T09:59:35.255519-07:00","updated_at":"2025-12-16T13:13:07.914658-07:00","closed_at":"2025-12-16T13:13:07.914658-07:00","dependencies":[{"issue_id":"cog-skd","depends_on_id":"cog-hr1","type":"discovered-from","created_at":"2025-12-16T09:59:35.256271-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-tc7","title":"Factory.Build() should return image ID for stable lookups","description":"## Summary\n\nCurrently `image.Build()` returns only an error, not the image ID. This means `Factory.Build()` can't return the actual image ID, and `Resolver.Build()` must use tag-based inspection which can be unstable (see PR #2649 for the caching bug this caused).\n\n## Changes Needed\n\n1. **`pkg/image/build.go`**: Modify `Build()` to return `(string, error)` where the string is the built image ID\n\n2. **`pkg/model/factory.go`**: Update `DockerfileFactory.Build()` to capture the ID and set `Image.Digest`\n\n3. **`pkg/model/resolver.go`**: Update `Resolver.Build()` to use `img.Digest` for inspection when available\n\n## Context\n\n- Related PR: https://github.com/replicate/cog/pull/2649\n- The issue: Docker tag resolution can pull from remote registry instead of using local image\n- The fix: Reference by image ID (SHA) instead of tag for stability\n\n## Acceptance Criteria\n\n- [ ] `image.Build()` returns the image ID\n- [ ] `Factory.Build()` populates `Image.Digest` \n- [ ] `Resolver.Build()` uses ID-based inspection\n- [ ] Existing tests pass","status":"closed","priority":2,"issue_type":"task","owner":"mdwan@cloudflare.com","created_at":"2026-01-26T16:40:25.172559-07:00","created_by":"Michael Dwan","updated_at":"2026-01-27T13:09:10.37719-07:00","closed_at":"2026-01-27T13:09:10.37719-07:00","close_reason":"Implemented: ImageBuild returns image ID, Factory populates Image.Digest, Resolver uses ID for stable inspection. All tests pass.","dependencies":[{"issue_id":"cog-tc7","depends_on_id":"cog-fuo.6","type":"blocks","created_at":"2026-01-26T16:40:38.798133-07:00","created_by":"Michael Dwan"}]}
{"id":"cog-tdd","title":"Phase 3: Unified E2E test suite","description":"Build a test harness that runs the same fixtures against both runtimes to verify identical behavior.\n\nGoals:\n- Single set of model fixtures with test cases\n- Run cog predict against each fixture\n- Compare outputs between cog runtime and coglet runtime\n- Surface any behavioral differences\n\nThis is the parent task for Phase 3 subtasks.\n\nDepends on: Phase 2 completion (cog-vli)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:14:18.792053-07:00","updated_at":"2026-02-02T13:57:39.403599-07:00","closed_at":"2026-02-02T13:57:39.403599-07:00","close_reason":"Coglet integration complete","dependencies":[{"issue_id":"cog-tdd","depends_on_id":"cog-l09","type":"blocks","created_at":"2025-12-15T15:14:18.792521-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-tzv","title":"Remove docker.go wrapper and rename NewAPIClient to NewClient","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:45:44.816047-07:00","updated_at":"2025-12-11T16:47:04.374916-07:00","closed_at":"2025-12-11T16:47:04.374916-07:00","dependencies":[{"issue_id":"cog-tzv","depends_on_id":"cog-5d6","type":"discovered-from","created_at":"2025-12-11T16:45:44.816504-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-u5c","title":"BuildKit Frontend Architecture: Eliminate Code Duplication and Enable Shared Executor","description":"## Overview\n\nRefactor Cog's build system to support a BuildKit frontend architecture with shared code between in-Cog builds and frontend builds. The goal is to encapsulate build logic in a container that can be versioned and deployed independently from the Cog CLI.\n\n**Key Principle:** Build *planning* always happens in the Cog CLI, but *execution* (Dockerfile generation, file assembly, build invocation) can happen either in Cog (current behavior) or in a BuildKit frontend container, using **identical shared code**.\n\n## Current State\n\nA working prototype exists:\n- `cmd/cog-build-frontend/` - Entry point for BuildKit frontend\n- `pkg/buildfrontend/` - Frontend-specific build logic  \n- `Dockerfile.cog-builder` - Builds the frontend image\n\n**Problem:** The prototype **duplicates ~470 lines** of Dockerfile generation logic from `StandardGenerator` (793 lines).\n\n**Problem:** `image.Build()` has 19 parameters mixing configuration, options, and dependencies.\n\n## Goals\n\n1. **Eliminate code duplication** between in-Cog builds and frontend builds\n2. **Enable seamless switching** between build modes via `COG_BUILDER` env var\n3. **Establish clean abstractions** (`BuildPlan`, `ModelFactory`, `Model`, `Executor`)\n4. **Prepare for future LLB-based builds** by decoupling planning from execution\n5. **Support incremental rollout** of build system changes\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                         COG CLI                                  │\n│  ┌──────────────────┐    ┌──────────────────┐                   │\n│  │   ModelFactory   │───▶│    BuildPlan     │                   │\n│  │ - parse cog.yaml │    │   (the \"what\")   │                   │\n│  │ - resolve base   │    │ - base image     │                   │\n│  │ - resolve wheels │    │ - packages       │                   │\n│  └──────────────────┘    └────────┬─────────┘                   │\n│                    ┌──────────────┴──────────────┐              │\n│                    ▼                             ▼              │\n│            COG_BUILDER unset              COG_BUILDER=image     │\n│            (in-cog build)                 (frontend build)      │\n└────────────────────┼─────────────────────────────┼──────────────┘\n                     ▼                             ▼\n         ┌───────────────────┐          ┌───────────────────┐\n         │   In-Cog Build    │          │  Frontend Build   │\n         │  ┌─────────────┐  │          │  ┌─────────────┐  │\n         │  │  Executor   │  │          │  │  Executor   │  │\n         │  │ (shared pkg)│  │          │  │ (shared pkg)│  │\n         │  └─────────────┘  │          │  └─────────────┘  │\n         └───────────────────┘          └───────────────────┘\n```\n\n## Success Criteria\n\n- `COG_BUILDER=cog-builder:dev cog build` produces identical images to `cog build`\n- All existing tests pass with both build paths\n- Zero code duplication between in-cog and frontend Dockerfile generation\n- New abstractions are clean, documented, and testable\n\n## References\n\n- Design doc: `docs/BUILDKIT_FRONTEND_PLAN.md`\n- Original plan: `BUILDER_PLAN.md`\n- Existing prototype: `cmd/cog-build-frontend/`, `pkg/buildfrontend/`","status":"open","priority":4,"issue_type":"epic","created_at":"2026-01-08T15:55:25.068694-07:00","updated_at":"2026-02-02T13:57:43.851098-07:00","comments":[{"id":1,"issue_id":"cog-u5c","author":"mdwan","text":"## Getting Started for Future Sessions\n\n### Quick Context\nThis epic implements a BuildKit frontend architecture to eliminate ~470 lines of duplicated Dockerfile generation code. The design doc is at `docs/BUILDKIT_FRONTEND_PLAN.md`.\n\n### Current State\n- Working prototype exists: `cmd/cog-build-frontend/`, `pkg/buildfrontend/`\n- Problem: `pkg/buildfrontend/generator.go` duplicates `pkg/dockerfile/standard_generator.go`\n- New packages to create: `pkg/model/` and `pkg/executor/`\n\n### How to Start\n1. Run `bd ready --parent cog-u5c` to see unblocked tasks\n2. Pick a task (Phase 1 tasks cog-u5c.1 through cog-u5c.4 can be done in parallel)\n3. Run `bd show \u003ctask-id\u003e` to see full implementation details\n4. Mark as in_progress: `bd set-state \u003ctask-id\u003e in_progress`\n5. When done: `bd close \u003ctask-id\u003e`\n\n### Key Files to Read First\n- `docs/BUILDKIT_FRONTEND_PLAN.md` - Full design document\n- `pkg/image/build.go` - The 19-param function being refactored\n- `pkg/dockerfile/standard_generator.go` - Generator logic to consolidate\n- `pkg/buildfrontend/generator.go` - Duplicated code to eventually delete\n\n### Testing Commands\n```bash\n# Build and test\ngo build ./pkg/model/...\ngo build ./pkg/executor/...\ngo test ./pkg/...\n\n# Integration test\nmake test-integration\n\n# Test frontend (after Phase 4)\ndocker build -f Dockerfile.cog-builder -t cog-builder:dev .\nCOG_BUILDER=cog-builder:dev cog build -t test ./test-integration/test_integration/fixtures/hello-world-project\n```","created_at":"2026-01-08T23:18:49Z"}]}
{"id":"cog-u5c.1","title":"Phase 1.1: Create pkg/model/plan.go with BuildPlan struct","description":"## Summary\n\nCreate the `BuildPlan` struct that captures \"what to build\" - all inputs needed to generate a Dockerfile and execute a build. This struct is created by `ModelFactory` in the CLI and can be serialized to JSON for the frontend.\n\n## File to Create\n\n`pkg/model/plan.go`\n\n## Implementation\n\n```go\npackage model\n\nimport \"github.com/replicate/cog/pkg/config\"\n\n// BuildPlan captures all inputs needed to build a model image.\ntype BuildPlan struct {\n    // Config is the parsed cog.yaml\n    Config *config.Config\n    \n    // Source paths\n    ProjectDir string\n    \n    // Output image\n    ImageName   string\n    Annotations map[string]string\n    \n    // Build behavior flags\n    NoCache         bool\n    SeparateWeights bool\n    Strip           bool\n    Precompile      bool\n    Fast            bool\n    LocalImage      bool\n    PipelinesImage  bool\n    \n    // Base image selection (resolved by ModelFactory)\n    UseCudaBaseImage string  // \"auto\", \"true\", \"false\"\n    UseCogBaseImage  *bool\n    BaseImage        string  // Pre-resolved base image name\n    \n    // Cog/runtime installation\n    CogInstall CogInstallSpec\n    \n    // Weights for separate layer (populated by ModelFactory if SeparateWeights=true)\n    Weights *WeightsSpec\n    \n    // Build secrets (secret IDs to mount)\n    Secrets []string\n    \n    // UI/output\n    ProgressOutput string\n    \n    // Optional overrides\n    SchemaFile     string  // custom schema file path\n    DockerfileFile string  // custom dockerfile path (bypass generation)\n}\n\n// CogInstallSpec describes how to install cog/coglet\ntype CogInstallSpec struct {\n    Source  string // \"embedded\", \"pypi\", \"url\"\n    Package string // \"cog\", \"coglet\", or URL\n    Path    string // filename in wheels LocalDir (for embedded)\n}\n\n// WeightsSpec describes model weights for separate layer optimization\ntype WeightsSpec struct {\n    Dirs  []string // directories containing weights\n    Files []string // individual weight files\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `BuildPlan` struct defined with all fields from `image.Build()` 19 params\n- [ ] `CogInstallSpec` struct defined for wheel handling\n- [ ] `WeightsSpec` struct defined for weights layer\n- [ ] Struct tags for JSON serialization (`json:\"...\"`)\n- [ ] Code compiles with `go build ./pkg/model/...`\n- [ ] GoDoc comments on all exported types and fields\n\n## Context Files\n\nRead these files to understand the parameters:\n- `pkg/image/build.go` - Current 19-param `Build()` function\n- `pkg/dockerfile/standard_generator.go` - Generator options\n- `pkg/wheels/wheels.go` - Wheel handling\n- `pkg/weights/weights.go` - Weights handling","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:55:42.74677-07:00","updated_at":"2026-02-02T13:57:45.994903-07:00","dependencies":[{"issue_id":"cog-u5c.1","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:55:42.747218-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.10","title":"Phase 3.1: Create pkg/executor/executor.go with Executor interface","description":"## Summary\n\nCreate the `Executor` interface and `BuildArtifacts` struct that define how a `BuildPlan` is converted into build artifacts (Dockerfile, support files).\n\n## Files to Create\n\n`pkg/executor/executor.go`\n`pkg/executor/artifacts.go`\n\n## Implementation\n\n### executor.go\n\n```go\npackage executor\n\nimport (\n    \"context\"\n    \n    \"github.com/replicate/cog/pkg/model\"\n)\n\n// Executor generates build artifacts from a BuildPlan.\n// Implementations must be stateless and have no host dependencies\n// (no filesystem writes, no embedded wheel access, no network calls).\ntype Executor interface {\n    // Execute generates all build artifacts from a plan.\n    Execute(ctx context.Context, plan *model.BuildPlan) (*BuildArtifacts, error)\n}\n\n// NewExecutor creates a new Executor instance.\nfunc NewExecutor() Executor {\n    return \u0026standardExecutor{}\n}\n\ntype standardExecutor struct{}\n\nfunc (e *standardExecutor) Execute(ctx context.Context, plan *model.BuildPlan) (*BuildArtifacts, error) {\n    // TODO: Generate Dockerfile from plan\n    // TODO: Generate .dockerignore if needed\n    // TODO: Generate requirements overlay if needed\n    return nil, nil\n}\n```\n\n### artifacts.go\n\n```go\npackage executor\n\n// BuildArtifacts contains all generated files needed for a Docker build.\ntype BuildArtifacts struct {\n    // Dockerfile is the generated Dockerfile content\n    Dockerfile string\n    \n    // Dockerignore is the generated .dockerignore content (may be empty)\n    Dockerignore string\n    \n    // SupportFiles maps relative paths to file contents\n    // e.g., \".cog/requirements-cog.txt\" -\u003e \"pydantic\u003e=2.0\\n...\"\n    SupportFiles map[string][]byte\n    \n    // BuildContexts maps context names to paths\n    // Used for multi-context builds (e.g., \"wheels\" -\u003e \"/tmp/wheels\")\n    BuildContexts map[string]string\n}\n\n// NewBuildArtifacts creates an empty BuildArtifacts.\nfunc NewBuildArtifacts() *BuildArtifacts {\n    return \u0026BuildArtifacts{\n        SupportFiles:  make(map[string][]byte),\n        BuildContexts: make(map[string]string),\n    }\n}\n```\n\n## Design Principles\n\n1. **No host dependencies** - Executor receives all info via `BuildPlan`, doesn't access filesystem\n2. **Stateless** - Same plan always produces same artifacts\n3. **Testable** - Easy to unit test without Docker/filesystem mocking\n\n## Acceptance Criteria\n\n- [ ] `Executor` interface defined\n- [ ] `BuildArtifacts` struct captures all outputs\n- [ ] `NewExecutor()` returns standard implementation\n- [ ] Skeleton `Execute()` method with TODOs\n- [ ] Code compiles: `go build ./pkg/executor/...`\n- [ ] GoDoc comments on all exported types\n\n## Context Files\n\n- `pkg/dockerfile/standard_generator.go` - Current generator logic to port\n- `pkg/dockerfile/generator.go` - Current interface\n- `pkg/model/plan.go` - Input struct","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:57:22.118657-07:00","updated_at":"2026-02-02T13:57:46.672142-07:00","dependencies":[{"issue_id":"cog-u5c.10","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:57:22.119088-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.11","title":"Phase 3.2: Implement Dockerfile generation in pkg/executor/dockerfile.go","description":"## Summary\n\nImplement the core Dockerfile generation logic in the executor package. This consolidates the ~800 lines from `StandardGenerator` into a clean, plan-based implementation.\n\n## File to Create\n\n`pkg/executor/dockerfile.go`\n\n## Implementation Approach\n\nThe Dockerfile generation should be broken into logical sections:\n\n```go\npackage executor\n\nimport (\n    \"strings\"\n    \n    \"github.com/replicate/cog/pkg/model\"\n)\n\n// generateDockerfile creates a Dockerfile from a BuildPlan.\nfunc generateDockerfile(plan *model.BuildPlan) (string, error) {\n    var sections []string\n    \n    // 1. Base image\n    sections = append(sections, generateBaseImage(plan))\n    \n    // 2. System packages\n    sections = append(sections, generateSystemPackages(plan))\n    \n    // 3. Python setup\n    sections = append(sections, generatePythonSetup(plan))\n    \n    // 4. Python dependencies\n    sections = append(sections, generatePythonDeps(plan))\n    \n    // 5. Cog/coglet installation\n    sections = append(sections, generateCogInstall(plan))\n    \n    // 6. User code copy\n    sections = append(sections, generateCodeCopy(plan))\n    \n    // 7. Run commands\n    sections = append(sections, generateRunCommands(plan))\n    \n    // 8. Entrypoint\n    sections = append(sections, generateEntrypoint(plan))\n    \n    return strings.Join(sections, \"\\n\\n\"), nil\n}\n\nfunc generateBaseImage(plan *model.BuildPlan) string {\n    // FROM logic based on plan.BaseImage, plan.Config.Build.GPU, etc.\n}\n\nfunc generateSystemPackages(plan *model.BuildPlan) string {\n    // apt-get install logic\n}\n\nfunc generatePythonSetup(plan *model.BuildPlan) string {\n    // Python version, venv setup\n}\n\nfunc generatePythonDeps(plan *model.BuildPlan) string {\n    // pip install from requirements.txt, python_packages, etc.\n}\n\nfunc generateCogInstall(plan *model.BuildPlan) string {\n    // Install cog/coglet based on plan.CogInstall\n}\n\nfunc generateCodeCopy(plan *model.BuildPlan) string {\n    // COPY . /src logic\n}\n\nfunc generateRunCommands(plan *model.BuildPlan) string {\n    // Execute plan.Config.Build.Run commands\n}\n\nfunc generateEntrypoint(plan *model.BuildPlan) string {\n    // ENTRYPOINT and CMD\n}\n```\n\n## Key Logic to Port from StandardGenerator\n\nReference `pkg/dockerfile/standard_generator.go` for:\n\n1. **Base image selection** (~lines 100-200): CUDA vs non-CUDA, cog base image logic\n2. **System packages** (~lines 200-250): apt-get install, CUDA toolkit packages\n3. **Python setup** (~lines 250-350): Python version, UV installer, venv\n4. **Dependencies** (~lines 350-500): requirements.txt handling, torch, extras\n5. **Cog installation** (~lines 500-550): Wheel installation from various sources\n6. **Code copy** (~lines 550-600): COPY and workdir setup\n7. **Run commands** (~lines 600-650): User's custom run commands\n8. **Entrypoint** (~lines 650-700): python -m cog.server.http\n\n## Important Differences from StandardGenerator\n\n- **No filesystem access** - All info comes from `BuildPlan`\n- **No registry calls** - Base image pre-resolved in plan\n- **No embedded wheel access** - Wheel path in `plan.CogInstall.Path`\n\n## Acceptance Criteria\n\n- [ ] All Dockerfile sections generated correctly\n- [ ] GPU/CUDA builds work\n- [ ] CPU-only builds work\n- [ ] Cog wheel installation works (embedded, pypi, url)\n- [ ] Python dependencies installed correctly\n- [ ] User run commands executed\n- [ ] Output matches existing StandardGenerator for same inputs\n- [ ] Unit tests for each generate* function\n\n## Testing\n\nCreate test cases that compare output:\n\n```go\nfunc TestGenerateDockerfile_HelloWorld(t *testing.T) {\n    plan := \u0026model.BuildPlan{\n        Config: \u0026config.Config{\n            Build: config.Build{\n                PythonVersion: \"3.11\",\n            },\n        },\n        // ... populate from fixture\n    }\n    \n    artifacts, err := NewExecutor().Execute(ctx, plan)\n    require.NoError(t, err)\n    \n    // Compare against known-good Dockerfile\n    expected := loadTestFixture(t, \"hello-world.Dockerfile\")\n    assert.Equal(t, expected, artifacts.Dockerfile)\n}\n```\n\n## Context Files\n\n- `pkg/dockerfile/standard_generator.go` - Source of truth for generation logic\n- `pkg/dockerfile/base.go` - Base image helpers\n- `pkg/dockerfile/env.go` - Environment variable handling\n- `pkg/config/config.go` - Config struct definitions","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:57:44.668581-07:00","updated_at":"2026-02-02T13:57:46.748351-07:00","dependencies":[{"issue_id":"cog-u5c.11","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:57:44.669026-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.11","depends_on_id":"cog-u5c.10","type":"blocks","created_at":"2026-01-08T16:16:56.39397-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.12","title":"Phase 3.3: Refactor StandardGenerator to use Executor internally","description":"## Summary\n\nRefactor `StandardGenerator` to use the new `Executor` internally. This ensures the in-cog build path uses the same generation logic as the frontend path.\n\n## File to Modify\n\n`pkg/dockerfile/standard_generator.go`\n\n## Implementation\n\n```go\npackage dockerfile\n\nimport (\n    \"context\"\n    \n    \"github.com/replicate/cog/pkg/executor\"\n    \"github.com/replicate/cog/pkg/model\"\n)\n\n// StandardGenerator generates Dockerfiles using the shared executor.\ntype StandardGenerator struct {\n    config   *config.Config\n    dir      string\n    // ... existing fields\n    \n    // New: executor for actual generation\n    executor executor.Executor\n}\n\nfunc NewStandardGenerator(/* existing params */) (*StandardGenerator, error) {\n    return \u0026StandardGenerator{\n        // ... existing initialization\n        executor: executor.NewExecutor(),\n    }, nil\n}\n\n// GenerateDockerfileWithoutSeparateWeights generates a Dockerfile.\nfunc (g *StandardGenerator) GenerateDockerfileWithoutSeparateWeights(ctx context.Context) (string, error) {\n    // Convert generator state to BuildPlan\n    plan := g.createBuildPlan()\n    \n    // Use shared executor\n    artifacts, err := g.executor.Execute(ctx, plan)\n    if err != nil {\n        return \"\", err\n    }\n    \n    return artifacts.Dockerfile, nil\n}\n\n// createBuildPlan converts generator state to a BuildPlan.\nfunc (g *StandardGenerator) createBuildPlan() *model.BuildPlan {\n    return \u0026model.BuildPlan{\n        Config:           g.config,\n        ProjectDir:       g.dir,\n        BaseImage:        g.resolvedBaseImage,\n        Strip:            g.strip,\n        Precompile:       g.precompile,\n        UseCudaBaseImage: g.useCudaBaseImage,\n        UseCogBaseImage:  g.useCogBaseImage,\n        CogInstall: model.CogInstallSpec{\n            Source:  g.cogInstallSource,\n            Package: g.cogInstallPackage,\n            Path:    g.cogInstallPath,\n        },\n        // ... map all relevant fields\n    }\n}\n```\n\n## Migration Strategy\n\n1. First, ensure Executor generates identical output to current StandardGenerator\n2. Then, swap implementation to use Executor\n3. Run all tests to verify no behavior change\n4. Remove duplicated generation code from StandardGenerator\n\n## Acceptance Criteria\n\n- [ ] `StandardGenerator` uses `Executor` internally\n- [ ] All existing tests pass unchanged\n- [ ] `cog build` produces identical images\n- [ ] No code duplication - generation logic lives only in `pkg/executor`\n\n## Testing\n\n```bash\n# Run existing generator tests\ngo test ./pkg/dockerfile/...\n\n# Integration tests\nmake test-integration\n\n# Manual comparison\ncog build -t test-before # Before changes\n# Make changes\ncog build -t test-after  # After changes\n# Compare docker inspect outputs\n```\n\n## Context Files\n\n- `pkg/dockerfile/standard_generator.go` - File to modify\n- `pkg/executor/dockerfile.go` - Executor implementation\n- `pkg/model/plan.go` - BuildPlan struct","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:58:00.429784-07:00","updated_at":"2026-02-02T13:57:46.828438-07:00","dependencies":[{"issue_id":"cog-u5c.12","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:58:00.430203-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.12","depends_on_id":"cog-u5c.11","type":"blocks","created_at":"2026-01-08T16:16:56.489299-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.12","depends_on_id":"cog-u5c.9","type":"blocks","created_at":"2026-01-08T16:16:56.584668-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.13","title":"Phase 4.1: Update ModelFactory to serialize BuildPlan as JSON for frontend","description":"## Summary\n\nUpdate `ModelFactory.BuildFromPlan()` to serialize the `BuildPlan` to JSON and pass it to the frontend when `COG_BUILDER` env var is set.\n\n## File to Modify\n\n`pkg/model/factory.go`\n\n## Implementation\n\n```go\npackage model\n\nimport (\n    \"context\"\n    \"encoding/json\"\n    \"os\"\n    \n    \"github.com/replicate/cog/pkg/docker\"\n)\n\n// BuildFromPlan executes a build from an existing plan.\nfunc (f *ModelFactory) BuildFromPlan(ctx context.Context, plan *BuildPlan) (*Model, error) {\n    // Check for frontend mode\n    frontendImage := os.Getenv(\"COG_BUILDER\")\n    if frontendImage != \"\" {\n        return f.buildWithFrontend(ctx, plan, frontendImage)\n    }\n    \n    // In-cog build path\n    return f.buildInCog(ctx, plan)\n}\n\nfunc (f *ModelFactory) buildWithFrontend(ctx context.Context, plan *BuildPlan, frontendImage string) (*Model, error) {\n    // 1. Serialize plan to JSON\n    planJSON, err := json.Marshal(plan)\n    if err != nil {\n        return nil, fmt.Errorf(\"serializing build plan: %w\", err)\n    }\n    \n    // 2. Write plan to temp file (passed via LocalDirs)\n    planDir, err := os.MkdirTemp(\"\", \"cog-plan-*\")\n    if err != nil {\n        return nil, err\n    }\n    defer os.RemoveAll(planDir)\n    \n    planFile := filepath.Join(planDir, \"plan.json\")\n    if err := os.WriteFile(planFile, planJSON, 0644); err != nil {\n        return nil, err\n    }\n    \n    // 3. Extract embedded wheels to temp dir (if using embedded)\n    wheelsDir, err := f.prepareWheelsDir(plan)\n    if err != nil {\n        return nil, err\n    }\n    defer os.RemoveAll(wheelsDir)\n    \n    // 4. Call BuildWithFrontend\n    opts := docker.FrontendBuildOptions{\n        ImageName:     plan.ImageName,\n        FrontendImage: frontendImage,\n        ContextDir:    plan.ProjectDir,\n        PlanDir:       planDir,    // New field\n        WheelsDir:     wheelsDir,  // New field\n        Secrets:       plan.Secrets,\n        NoCache:       plan.NoCache,\n        ProgressOutput: plan.ProgressOutput,\n    }\n    \n    if err := f.docker.BuildWithFrontend(ctx, opts); err != nil {\n        return nil, err\n    }\n    \n    // 5. Extract model metadata from built image\n    return f.extractModelMetadata(ctx, plan.ImageName)\n}\n\nfunc (f *ModelFactory) prepareWheelsDir(plan *BuildPlan) (string, error) {\n    if plan.CogInstall.Source != \"embedded\" {\n        return \"\", nil // No embedded wheels needed\n    }\n    \n    wheelsDir, err := os.MkdirTemp(\"\", \"cog-wheels-*\")\n    if err != nil {\n        return \"\", err\n    }\n    \n    // Extract embedded wheel to temp dir\n    wheelBytes, err := wheels.GetEmbeddedWheel(plan.CogInstall.Package)\n    if err != nil {\n        return \"\", err\n    }\n    \n    wheelPath := filepath.Join(wheelsDir, plan.CogInstall.Path)\n    if err := os.WriteFile(wheelPath, wheelBytes, 0644); err != nil {\n        return \"\", err\n    }\n    \n    return wheelsDir, nil\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `BuildPlan` serializes to JSON correctly\n- [ ] Plan JSON written to temp dir and passed as LocalDir\n- [ ] Embedded wheels extracted to temp dir\n- [ ] `FrontendBuildOptions` updated with new fields\n- [ ] Frontend path triggered when `COG_BUILDER` is set\n- [ ] Unit tests for serialization\n\n## Context Files\n\n- `pkg/model/factory.go` - File to modify\n- `pkg/docker/docker.go` - `BuildWithFrontend()` method\n- `pkg/wheels/wheels.go` - Embedded wheel access","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:58:18.203604-07:00","updated_at":"2026-02-02T13:57:46.91116-07:00","dependencies":[{"issue_id":"cog-u5c.13","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:58:18.204039-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.13","depends_on_id":"cog-u5c.12","type":"blocks","created_at":"2026-01-08T16:17:00.617762-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.14","title":"Phase 4.2: Update pkg/docker/docker.go BuildWithFrontend to pass plan + wheels","description":"## Summary\n\nUpdate `BuildWithFrontend()` to pass the plan JSON and wheels directory as BuildKit LocalDirs.\n\n## File to Modify\n\n`pkg/docker/docker.go`\n\n## Current State\n\nThe existing `BuildWithFrontend()` passes options via `FrontendAttrs`:\n\n```go\nfrontendAttrs := map[string]string{\n    \"source\": opts.FrontendImage,\n    \"cog.strip\": \"true\",\n    // etc.\n}\n```\n\n## New Implementation\n\nPass data via LocalDirs instead of attributes:\n\n```go\n// FrontendBuildOptions - add new fields\ntype FrontendBuildOptions struct {\n    ImageName      string\n    FrontendImage  string\n    ContextDir     string\n    PlanDir        string  // NEW: directory containing plan.json\n    WheelsDir      string  // NEW: directory containing wheels\n    Secrets        []string\n    NoCache        bool\n    ProgressOutput string\n}\n\nfunc (c *apiClient) BuildWithFrontend(ctx context.Context, opts FrontendBuildOptions) error {\n    // ... existing BuildKit client setup ...\n    \n    // Build LocalDirs map\n    localDirs := map[string]string{\n        \"context\": opts.ContextDir,\n    }\n    \n    if opts.PlanDir != \"\" {\n        localDirs[\"plan\"] = opts.PlanDir\n    }\n    \n    if opts.WheelsDir != \"\" {\n        localDirs[\"wheels\"] = opts.WheelsDir\n    }\n    \n    solveOpts := buildkitclient.SolveOpt{\n        Frontend: \"gateway.v0\",\n        FrontendAttrs: map[string]string{\n            \"source\": opts.FrontendImage,\n        },\n        LocalDirs: localDirs,\n        Exports: []buildkitclient.ExportEntry{\n            {Type: \"moby\", Attrs: map[string]string{\"name\": opts.ImageName}},\n        },\n    }\n    \n    // ... rest of implementation ...\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `FrontendBuildOptions` has `PlanDir` and `WheelsDir` fields\n- [ ] LocalDirs includes \"plan\" and \"wheels\" when provided\n- [ ] Secrets still work correctly\n- [ ] Build cache still works\n- [ ] Progress output displays correctly\n\n## Context Files\n\n- `pkg/docker/docker.go` - File to modify\n- `pkg/docker/buildkit.go` - BuildKit types","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:58:29.509307-07:00","updated_at":"2026-02-02T13:57:46.987605-07:00","dependencies":[{"issue_id":"cog-u5c.14","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:58:29.509751-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.14","depends_on_id":"cog-u5c.13","type":"blocks","created_at":"2026-01-08T16:17:00.737556-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.15","title":"Phase 4.3: Update pkg/buildfrontend/build.go to use shared Executor","description":"## Summary\n\nUpdate the BuildKit frontend to read `BuildPlan` from JSON and use the shared `Executor` for Dockerfile generation.\n\n## File to Modify\n\n`pkg/buildfrontend/build.go`\n\n## Current State\n\nThe frontend currently:\n1. Reads `cog.yaml` from context\n2. Uses duplicated generator code in `generator.go`\n3. Calls `dockerfile.v0` frontend\n\n## New Implementation\n\n```go\npackage buildfrontend\n\nimport (\n    \"context\"\n    \"encoding/json\"\n    \n    \"github.com/moby/buildkit/client/llb\"\n    \"github.com/moby/buildkit/frontend/gateway/client\"\n    \"github.com/moby/buildkit/solver/pb\"\n    \n    \"github.com/replicate/cog/pkg/executor\"\n    \"github.com/replicate/cog/pkg/model\"\n)\n\n// Build is the main entry point for the BuildKit frontend.\nfunc Build(ctx context.Context, c client.Client) (*client.Result, error) {\n    // 1. Read plan.json from plan LocalDir\n    plan, err := readPlanFromContext(ctx, c)\n    if err != nil {\n        return nil, fmt.Errorf(\"reading build plan: %w\", err)\n    }\n    \n    // 2. Generate Dockerfile using shared executor\n    exec := executor.NewExecutor()\n    artifacts, err := exec.Execute(ctx, plan)\n    if err != nil {\n        return nil, fmt.Errorf(\"generating build artifacts: %w\", err)\n    }\n    \n    // 3. Create dockerfile as LLB state\n    dockerfileSt := llb.Scratch().File(\n        llb.Mkfile(\"Dockerfile\", 0644, []byte(artifacts.Dockerfile)),\n    )\n    dockerfileDef, err := dockerfileSt.Marshal(ctx)\n    if err != nil {\n        return nil, fmt.Errorf(\"marshaling dockerfile: %w\", err)\n    }\n    \n    // 4. Get inputs\n    inputs, err := c.Inputs(ctx)\n    if err != nil {\n        return nil, fmt.Errorf(\"getting inputs: %w\", err)\n    }\n    \n    contextDef, err := inputs[\"context\"].Marshal(ctx)\n    if err != nil {\n        return nil, fmt.Errorf(\"marshaling context: %w\", err)\n    }\n    \n    // 5. Build frontend inputs\n    frontendInputs := map[string]*pb.Definition{\n        \"dockerfile\": dockerfileDef.ToPB(),\n        \"context\":    contextDef.ToPB(),\n    }\n    \n    // 6. Add wheels context if present\n    if wheelsSt, ok := inputs[\"wheels\"]; ok {\n        wheelsDef, err := wheelsSt.Marshal(ctx)\n        if err != nil {\n            return nil, fmt.Errorf(\"marshaling wheels: %w\", err)\n        }\n        frontendInputs[\"wheels\"] = wheelsDef.ToPB()\n    }\n    \n    // 7. Build using dockerfile.v0 frontend\n    return c.Solve(ctx, client.SolveRequest{\n        Frontend: \"dockerfile.v0\",\n        FrontendOpt: map[string]string{\n            \"filename\": \"Dockerfile\",\n            \"platform\": \"linux/amd64\",\n        },\n        FrontendInputs: frontendInputs,\n    })\n}\n\nfunc readPlanFromContext(ctx context.Context, c client.Client) (*model.BuildPlan, error) {\n    inputs, err := c.Inputs(ctx)\n    if err != nil {\n        return nil, err\n    }\n    \n    planSt, ok := inputs[\"plan\"]\n    if !ok {\n        return nil, fmt.Errorf(\"no plan input found - is COG_BUILDER set correctly?\")\n    }\n    \n    def, err := planSt.Marshal(ctx)\n    if err != nil {\n        return nil, err\n    }\n    \n    res, err := c.Solve(ctx, client.SolveRequest{\n        Definition: def.ToPB(),\n    })\n    if err != nil {\n        return nil, err\n    }\n    \n    ref, err := res.SingleRef()\n    if err != nil {\n        return nil, err\n    }\n    \n    planJSON, err := ref.ReadFile(ctx, client.ReadRequest{\n        Filename: \"plan.json\",\n    })\n    if err != nil {\n        return nil, fmt.Errorf(\"reading plan.json: %w\", err)\n    }\n    \n    var plan model.BuildPlan\n    if err := json.Unmarshal(planJSON, \u0026plan); err != nil {\n        return nil, fmt.Errorf(\"parsing plan.json: %w\", err)\n    }\n    \n    return \u0026plan, nil\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Frontend reads `BuildPlan` from \"plan\" LocalDir\n- [ ] Uses shared `Executor` for Dockerfile generation\n- [ ] Wheels context passed through to `dockerfile.v0`\n- [ ] No duplicated generation code\n- [ ] Frontend produces identical output to in-cog build\n\n## Context Files\n\n- `pkg/buildfrontend/build.go` - File to modify\n- `pkg/executor/executor.go` - Shared executor\n- `pkg/model/plan.go` - BuildPlan struct","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:59:08.503195-07:00","updated_at":"2026-02-02T13:57:47.061933-07:00","dependencies":[{"issue_id":"cog-u5c.15","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:59:08.503619-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.15","depends_on_id":"cog-u5c.14","type":"blocks","created_at":"2026-01-08T16:17:00.838149-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.15","depends_on_id":"cog-u5c.11","type":"blocks","created_at":"2026-01-08T16:17:00.945165-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.16","title":"Phase 4.4: Delete pkg/buildfrontend/generator.go (duplicated code)","description":"## Summary\n\nDelete the duplicated generator code in `pkg/buildfrontend/generator.go` now that the frontend uses the shared `Executor`.\n\n## File to Delete\n\n`pkg/buildfrontend/generator.go` (469 lines of duplicated code)\n\n## Prerequisites\n\n- Phase 4.3 complete (frontend uses shared Executor)\n- All tests pass with new implementation\n\n## Verification Steps\n\n1. Ensure `pkg/buildfrontend/build.go` no longer imports `generator.go`\n2. Run tests to confirm nothing depends on deleted file\n3. Delete the file\n4. Rebuild frontend image\n5. Test end-to-end\n\n## Commands\n\n```bash\n# Verify no imports\ngrep -r \"buildfrontend.*generator\" pkg/\n\n# Delete file\nrm pkg/buildfrontend/generator.go\n\n# Rebuild and test\ndocker build -f Dockerfile.cog-builder -t cog-builder:dev .\nCOG_BUILDER=cog-builder:dev cog build -t test ./test-integration/test_integration/fixtures/hello-world-project\n```\n\n## Acceptance Criteria\n\n- [ ] `generator.go` deleted\n- [ ] Code compiles: `go build ./...`\n- [ ] Frontend image builds: `docker build -f Dockerfile.cog-builder ...`\n- [ ] Frontend builds work: `COG_BUILDER=cog-builder:dev cog build`\n- [ ] All tests pass\n\n## Line Count Verification\n\nBefore deletion: ~1262 lines total (generator.go: 469 + standard_generator.go: 793)\nAfter deletion: ~800 lines in executor (consolidated, no duplication)","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:59:19.221279-07:00","updated_at":"2026-02-02T13:57:47.13532-07:00","dependencies":[{"issue_id":"cog-u5c.16","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:59:19.221676-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.16","depends_on_id":"cog-u5c.15","type":"blocks","created_at":"2026-01-08T16:17:01.042455-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.17","title":"Phase 4.5: End-to-end validation of frontend vs in-cog parity","description":"## Summary\n\nComprehensive testing to validate that frontend builds produce identical results to in-cog builds.\n\n## Test Matrix\n\n| Fixture | Features | Test Both Paths |\n|---------|----------|-----------------|\n| hello-world-project | Basic Python | ✓ |\n| string-project | Simple I/O | ✓ |\n| torch-project | PyTorch, GPU | ✓ |\n| file-project | File I/O types | ✓ |\n| secret-project | Build secrets | ✓ |\n\n## Validation Commands\n\n```bash\n# Build frontend image\ndocker build -f Dockerfile.cog-builder -t cog-builder:dev .\n\n# Build cog CLI\ngo build -o ./cog-cli ./cmd/cog\n\n# For each fixture:\nFIXTURE=test-integration/test_integration/fixtures/hello-world-project\n\n# 1. In-cog build\n./cog-cli build -t test-incog $FIXTURE\n\n# 2. Frontend build\nCOG_BUILDER=cog-builder:dev ./cog-cli build -t test-frontend $FIXTURE\n\n# 3. Compare labels (schema, cog version, etc.)\ndocker inspect test-incog --format '{{json .Config.Labels}}' | jq -S . \u003e /tmp/incog.json\ndocker inspect test-frontend --format '{{json .Config.Labels}}' | jq -S . \u003e /tmp/frontend.json\ndiff /tmp/incog.json /tmp/frontend.json\n\n# 4. Compare image structure\ndocker history test-incog\ndocker history test-frontend\n\n# 5. Run prediction (if applicable)\ndocker run --rm test-incog python -c \"from predict import Predictor; p = Predictor(); print(p.predict('test'))\"\ndocker run --rm test-frontend python -c \"from predict import Predictor; p = Predictor(); print(p.predict('test'))\"\n```\n\n## Expected Differences (Acceptable)\n\n- Image digests (timestamps, build IDs)\n- Layer hashes (content should be same, IDs may differ)\n\n## Must Be Identical\n\n- Image labels (schema, cog version, config)\n- Installed packages\n- Python version\n- Entrypoint/CMD\n- Prediction output\n\n## Acceptance Criteria\n\n- [ ] All fixtures build successfully with both paths\n- [ ] Labels match (ignoring digests)\n- [ ] Predictions produce identical output\n- [ ] GPU fixtures work on GPU-enabled hosts\n- [ ] Secrets fixtures work correctly\n- [ ] No regressions in build time\n\n## CI Integration\n\nAdd to CI workflow:\n\n```yaml\n- name: Test frontend parity\n  run: |\n    docker build -f Dockerfile.cog-builder -t cog-builder:dev .\n    make cog\n    ./script/test-frontend-parity.sh\n```\n\n## Context Files\n\n- `test-integration/test_integration/fixtures/` - Test fixtures\n- `.github/workflows/ci.yaml` - CI configuration","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:59:34.631718-07:00","updated_at":"2026-02-02T13:57:47.210535-07:00","dependencies":[{"issue_id":"cog-u5c.17","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:59:34.63214-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.17","depends_on_id":"cog-u5c.16","type":"blocks","created_at":"2026-01-08T16:17:01.147201-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.18","title":"Phase 5.1: Implement weights discovery in ModelFactory.CreatePlan","description":"## Summary\n\nImplement weights discovery in `ModelFactory.CreatePlan()` to populate `BuildPlan.Weights` when `SeparateWeights=true`.\n\n## File to Modify\n\n`pkg/model/factory.go`\n\n## Implementation\n\n```go\nfunc (f *ModelFactory) CreatePlan(ctx context.Context, cfg *config.Config, opts CreatePlanOptions) (*BuildPlan, error) {\n    plan := \u0026BuildPlan{\n        // ... existing field assignments ...\n    }\n    \n    // Discover weights if separate weights requested\n    if opts.SeparateWeights {\n        weightsSpec, err := f.discoverWeights(opts.ProjectDir)\n        if err != nil {\n            return nil, fmt.Errorf(\"discovering weights: %w\", err)\n        }\n        plan.Weights = weightsSpec\n    }\n    \n    return plan, nil\n}\n\nfunc (f *ModelFactory) discoverWeights(projectDir string) (*WeightsSpec, error) {\n    // Use existing weights discovery logic from pkg/weights\n    // Threshold: files \u003e 10MB are considered weights\n    \n    var spec WeightsSpec\n    \n    err := filepath.WalkDir(projectDir, func(path string, d fs.DirEntry, err error) error {\n        if err != nil {\n            return err\n        }\n        \n        // Skip hidden files, .git, etc.\n        if strings.HasPrefix(d.Name(), \".\") {\n            if d.IsDir() {\n                return filepath.SkipDir\n            }\n            return nil\n        }\n        \n        if d.IsDir() {\n            return nil\n        }\n        \n        info, err := d.Info()\n        if err != nil {\n            return err\n        }\n        \n        // Files \u003e 10MB are weights\n        if info.Size() \u003e 10*1024*1024 {\n            relPath, _ := filepath.Rel(projectDir, path)\n            spec.Files = append(spec.Files, relPath)\n        }\n        \n        return nil\n    })\n    \n    if err != nil {\n        return nil, err\n    }\n    \n    return \u0026spec, nil\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Weights discovered correctly (files \u003e 10MB threshold)\n- [ ] Relative paths populated in `WeightsSpec`\n- [ ] Hidden files/dirs excluded\n- [ ] `.git` directory excluded\n- [ ] Unit tests for weights discovery\n\n## Context Files\n\n- `pkg/weights/weights.go` - Existing weights discovery logic\n- `pkg/model/factory.go` - File to modify\n- `pkg/model/plan.go` - `WeightsSpec` struct","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:59:46.174708-07:00","updated_at":"2026-02-02T13:57:47.289844-07:00","dependencies":[{"issue_id":"cog-u5c.18","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:59:46.175112-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.18","depends_on_id":"cog-u5c.17","type":"blocks","created_at":"2026-01-08T16:17:05.098947-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.19","title":"Phase 5.2: Update Executor to generate separate weights layer","description":"## Summary\n\nUpdate the `Executor` to generate Dockerfile commands for separate weights layer when `BuildPlan.Weights` is populated.\n\n## File to Modify\n\n`pkg/executor/dockerfile.go`\n\n## Implementation\n\nWhen `plan.Weights` is non-nil, generate:\n\n1. Early layer with weights COPY\n2. Exclude weights from main COPY via .dockerignore\n3. Final layer copies from weights layer\n\n```go\nfunc generateWeightsLayer(plan *model.BuildPlan) string {\n    if plan.Weights == nil || len(plan.Weights.Files) == 0 {\n        return \"\"\n    }\n    \n    var lines []string\n    \n    // Copy weights files individually for better layer caching\n    for _, file := range plan.Weights.Files {\n        lines = append(lines, fmt.Sprintf(\"COPY %s /src/%s\", file, file))\n    }\n    \n    return strings.Join(lines, \"\\n\")\n}\n\nfunc generateCodeCopy(plan *model.BuildPlan) string {\n    // Main COPY command\n    // If separate weights, generate .dockerignore to exclude weight files\n    \n    var copyCmd string\n    if plan.Weights != nil \u0026\u0026 len(plan.Weights.Files) \u003e 0 {\n        // Copy everything except weights (handled by .dockerignore)\n        copyCmd = \"COPY . /src\"\n    } else {\n        copyCmd = \"COPY . /src\"\n    }\n    \n    return copyCmd\n}\n```\n\n## Dockerignore Generation\n\nWhen separate weights enabled, generate .dockerignore entries:\n\n```go\nfunc (e *standardExecutor) Execute(ctx context.Context, plan *model.BuildPlan) (*BuildArtifacts, error) {\n    artifacts := NewBuildArtifacts()\n    \n    // Generate Dockerfile\n    dockerfile, err := generateDockerfile(plan)\n    if err != nil {\n        return nil, err\n    }\n    artifacts.Dockerfile = dockerfile\n    \n    // Generate .dockerignore for weights exclusion\n    if plan.Weights != nil \u0026\u0026 len(plan.Weights.Files) \u003e 0 {\n        var ignoreLines []string\n        for _, file := range plan.Weights.Files {\n            ignoreLines = append(ignoreLines, file)\n        }\n        artifacts.Dockerignore = strings.Join(ignoreLines, \"\\n\")\n    }\n    \n    return artifacts, nil\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Weights layer generated when `Weights` populated\n- [ ] Weights excluded from main COPY\n- [ ] .dockerignore generated correctly\n- [ ] Layer caching works (weights don't invalidate code layer)\n- [ ] Tests with models containing large weight files\n\n## Context Files\n\n- `pkg/executor/dockerfile.go` - File to modify\n- `pkg/weights/weights.go` - Reference implementation\n- `pkg/dockerfile/standard_generator.go` - Current separate weights handling","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T16:00:04.409115-07:00","updated_at":"2026-02-02T13:57:47.367914-07:00","dependencies":[{"issue_id":"cog-u5c.19","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T16:00:04.409553-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.19","depends_on_id":"cog-u5c.18","type":"blocks","created_at":"2026-01-08T16:17:05.196479-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.19","depends_on_id":"cog-u5c.11","type":"blocks","created_at":"2026-01-08T16:17:05.292816-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.2","title":"Phase 1.2: Create pkg/model/model.go with Model output struct","description":"## Summary\n\nCreate the `Model` struct that represents output metadata from a successful build. Contains everything needed to inspect/use the built image.\n\n## File to Create\n\n`pkg/model/model.go`\n\n## Implementation\n\n```go\npackage model\n\nimport (\n    \"github.com/getkin/kin-openapi/openapi3\"\n    \"github.com/replicate/cog/pkg/config\"\n)\n\n// Model represents a built Cog model image\ntype Model struct {\n    // Image identification\n    ImageName   string\n    ImageDigest string\n    \n    // Schema extracted from the model\n    OpenAPISchema *openapi3.T\n    \n    // Original configuration\n    Config *config.Config\n    \n    // Docker image labels\n    Labels map[string]string\n    \n    // Build metadata\n    CogVersion string\n    HasInit    bool  // whether model has setup() method\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `Model` struct defined with all output fields\n- [ ] Includes `openapi3.T` for schema (add import to go.mod if needed)\n- [ ] JSON struct tags for serialization\n- [ ] GoDoc comments on all exported fields\n- [ ] Code compiles with `go build ./pkg/model/...`\n\n## Context Files\n\nRead these files to understand what output data is generated:\n- `pkg/image/build.go` - Current build output handling\n- `pkg/predict/api.go` - Schema types\n- `pkg/cli/build.go` - How build results are used","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:55:51.629077-07:00","updated_at":"2026-02-02T13:57:46.072967-07:00","dependencies":[{"issue_id":"cog-u5c.2","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:55:51.629522-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.20","title":"Phase 5.3: Test separate weights feature end-to-end","description":"## Summary\n\nComprehensive testing of the separate weights feature with both in-cog and frontend build paths.\n\n## Test Setup\n\nCreate a test fixture with large files (fake weights \u003e10MB).\n\n## Test Cases\n\n### 1. Build with separate weights\n\n```bash\n# In-cog\n./cog-cli build -t weights-incog --separate-weights test-fixtures/weights-test\n\n# Frontend\nCOG_BUILDER=cog-builder:dev ./cog-cli build -t weights-frontend --separate-weights test-fixtures/weights-test\n```\n\n### 2. Verify layer structure\n\n```bash\n# Check that weights are in early layer\ndocker history weights-incog\ndocker history weights-frontend\n# Verify layer sizes suggest separation\n```\n\n### 3. Test cache efficiency\n\nModify code, rebuild - weights layer should be cached.\n\n### 4. Functional test\n\nRun predictions on both images, verify identical output.\n\n## Acceptance Criteria\n\n- [ ] Weights files detected (\u003e10MB threshold)\n- [ ] Separate layer created for weights\n- [ ] Code changes do not invalidate weights layer\n- [ ] Weights changes do not invalidate code layer\n- [ ] Both build paths produce working images\n- [ ] Labels/schema identical between paths\n\n## Context Files\n\n- test-integration/test_integration/fixtures/ - Test fixtures\n- pkg/weights/weights.go - Weights logic","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T16:16:39.354927-07:00","updated_at":"2026-02-02T13:57:47.448882-07:00","dependencies":[{"issue_id":"cog-u5c.20","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T16:16:39.355396-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.20","depends_on_id":"cog-u5c.19","type":"blocks","created_at":"2026-01-08T16:17:05.387029-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.3","title":"Phase 1.3: Create pkg/model/options.go with CreatePlanOptions","description":"## Summary\n\nCreate `CreatePlanOptions` struct that captures options for creating a `BuildPlan`. This separates the \"what to build\" configuration from the factory method signature.\n\n## File to Create\n\n`pkg/model/options.go`\n\n## Implementation\n\n```go\npackage model\n\n// CreatePlanOptions contains options for creating a BuildPlan.\n// These are the parameters that vary between different build invocations.\ntype CreatePlanOptions struct {\n    // ProjectDir is the directory containing cog.yaml and source code\n    ProjectDir string\n    \n    // ImageName is the target image name (e.g., \"my-model:latest\")\n    ImageName string\n    \n    // Build behavior\n    NoCache         bool\n    SeparateWeights bool\n    Strip           bool\n    Precompile      bool\n    Fast            bool\n    LocalImage      bool\n    PipelinesImage  bool\n    \n    // Base image overrides\n    UseCudaBaseImage string  // \"auto\", \"true\", \"false\", or empty for default\n    UseCogBaseImage  *bool   // nil for auto, true/false to force\n    \n    // Build secrets (e.g., [\"id=mysecret,src=/path/to/secret\"])\n    Secrets []string\n    \n    // Annotations to add to image\n    Annotations map[string]string\n    \n    // UI/output\n    ProgressOutput string  // \"auto\", \"plain\", \"tty\"\n    \n    // Optional file overrides\n    SchemaFile     string  // path to pre-generated schema file\n    DockerfileFile string  // path to custom Dockerfile (bypasses generation)\n}\n\n// DefaultCreatePlanOptions returns options with sensible defaults\nfunc DefaultCreatePlanOptions() CreatePlanOptions {\n    return CreatePlanOptions{\n        ProgressOutput: \"auto\",\n    }\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `CreatePlanOptions` struct defined with all build options\n- [ ] `DefaultCreatePlanOptions()` function returns sensible defaults\n- [ ] JSON struct tags for serialization\n- [ ] GoDoc comments explaining each option\n- [ ] Code compiles with `go build ./pkg/model/...`\n\n## Context Files\n\nRead these files to understand the options:\n- `pkg/cli/build.go` - CLI flags that map to options\n- `pkg/cli/push.go` - Push-specific options\n- `pkg/image/build.go` - Current parameter list","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:56:03.29782-07:00","updated_at":"2026-02-02T13:57:46.139355-07:00","dependencies":[{"issue_id":"cog-u5c.3","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:56:03.298246-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.4","title":"Phase 1.4: Create pkg/model/factory.go with ModelFactory","description":"## Summary\n\nCreate `ModelFactory` that creates `BuildPlan`s and coordinates builds. This is the main entry point for build operations and owns the docker/registry clients.\n\n## File to Create\n\n`pkg/model/factory.go`\n\n## Implementation\n\n```go\npackage model\n\nimport (\n    \"context\"\n    \n    \"github.com/replicate/cog/pkg/config\"\n    \"github.com/replicate/cog/pkg/docker/command\"\n    \"github.com/replicate/cog/pkg/registry\"\n)\n\n// ModelFactory creates BuildPlans and coordinates builds.\n// It owns the docker and registry clients needed for host-side operations.\ntype ModelFactory struct {\n    docker   command.Command\n    registry registry.Client\n}\n\n// NewModelFactory creates a new ModelFactory with the given clients.\nfunc NewModelFactory(docker command.Command, registry registry.Client) *ModelFactory {\n    return \u0026ModelFactory{\n        docker:   docker,\n        registry: registry,\n    }\n}\n\n// CreatePlan creates a BuildPlan from config and options.\n// This performs all host-side resolution:\n// - Base image selection and validation\n// - Wheel resolution (embedded, pypi, url)\n// - Weights discovery (if SeparateWeights=true)\nfunc (f *ModelFactory) CreatePlan(ctx context.Context, cfg *config.Config, opts CreatePlanOptions) (*BuildPlan, error) {\n    plan := \u0026BuildPlan{\n        Config:           cfg,\n        ProjectDir:       opts.ProjectDir,\n        ImageName:        opts.ImageName,\n        Annotations:      opts.Annotations,\n        NoCache:          opts.NoCache,\n        SeparateWeights:  opts.SeparateWeights,\n        Strip:            opts.Strip,\n        Precompile:       opts.Precompile,\n        Fast:             opts.Fast,\n        LocalImage:       opts.LocalImage,\n        PipelinesImage:   opts.PipelinesImage,\n        UseCudaBaseImage: opts.UseCudaBaseImage,\n        UseCogBaseImage:  opts.UseCogBaseImage,\n        Secrets:          opts.Secrets,\n        ProgressOutput:   opts.ProgressOutput,\n        SchemaFile:       opts.SchemaFile,\n        DockerfileFile:   opts.DockerfileFile,\n    }\n    \n    // TODO: Resolve base image\n    // TODO: Resolve wheel (embedded, pypi, url)\n    // TODO: Discover weights if SeparateWeights=true\n    \n    return plan, nil\n}\n\n// Build creates a plan and executes the build, returning Model metadata.\n// This is a convenience method that combines CreatePlan + BuildFromPlan.\nfunc (f *ModelFactory) Build(ctx context.Context, cfg *config.Config, opts CreatePlanOptions) (*Model, error) {\n    plan, err := f.CreatePlan(ctx, cfg, opts)\n    if err != nil {\n        return nil, err\n    }\n    return f.BuildFromPlan(ctx, plan)\n}\n\n// BuildFromPlan executes a build from an existing plan.\n// If COG_BUILDER env var is set, uses frontend build path.\n// Otherwise uses in-cog build path.\nfunc (f *ModelFactory) BuildFromPlan(ctx context.Context, plan *BuildPlan) (*Model, error) {\n    // TODO: Check COG_BUILDER env var\n    // TODO: If set, call BuildWithFrontend\n    // TODO: Otherwise, call existing image.Build logic\n    \n    return nil, nil // Placeholder\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `ModelFactory` struct with docker and registry clients\n- [ ] `NewModelFactory()` constructor\n- [ ] `CreatePlan()` method with TODO comments for resolution logic\n- [ ] `Build()` convenience method\n- [ ] `BuildFromPlan()` method with TODO for path switching\n- [ ] GoDoc comments on all exported types and methods\n- [ ] Code compiles with `go build ./pkg/model/...`\n\n## Context Files\n\nRead these files to understand dependencies:\n- `pkg/docker/command/command.go` - Docker client interface\n- `pkg/registry/client.go` - Registry client interface\n- `pkg/image/build.go` - Current build orchestration\n- `pkg/dockerfile/standard_generator.go` - How resolution is currently done","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:56:20.122943-07:00","updated_at":"2026-02-02T13:57:46.222659-07:00","dependencies":[{"issue_id":"cog-u5c.4","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:56:20.123371-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.5","title":"Phase 1.5: Wire up ModelFactory in pkg/cli/build.go as proof of concept","description":"## Summary\n\nModify `pkg/cli/build.go` to use `ModelFactory.Build()` as a proof of concept. This validates that the new abstractions work correctly with the existing build flow.\n\n## File to Modify\n\n`pkg/cli/build.go`\n\n## Implementation Steps\n\n1. Import the new `pkg/model` package\n2. Create a `ModelFactory` instance with existing docker and registry clients\n3. Create `CreatePlanOptions` from CLI flags\n4. Call `factory.Build()` instead of `image.Build()`\n5. Ensure all existing behavior is preserved\n\n## Key Changes\n\n```go\n// In buildCommand.RunE or equivalent:\n\nimport \"github.com/replicate/cog/pkg/model\"\n\n// Create factory\nfactory := model.NewModelFactory(dockerClient, registryClient)\n\n// Create options from CLI flags\nopts := model.CreatePlanOptions{\n    ProjectDir:       projectDir,\n    ImageName:        imageName,\n    NoCache:          buildNoCache,\n    SeparateWeights:  buildSeparateWeights,\n    Strip:            buildStrip,\n    Precompile:       buildPrecompile,\n    Fast:             buildFast,\n    LocalImage:       buildLocalImage,\n    PipelinesImage:   pipelinesImage,\n    UseCudaBaseImage: buildUseCudaBaseImage,\n    UseCogBaseImage:  DetermineUseCogBaseImage(cmd),\n    Secrets:          buildSecrets,\n    ProgressOutput:   buildProgressOutput,\n    SchemaFile:       buildSchemaFile,\n    DockerfileFile:   buildDockerfileFile,\n}\n\n// Build using new abstraction\nmodel, err := factory.Build(ctx, cfg, opts)\nif err != nil {\n    return err\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `pkg/cli/build.go` uses `ModelFactory`\n- [ ] All existing CLI flags still work\n- [ ] `cog build` produces identical output to before\n- [ ] All existing tests pass: `go test ./pkg/cli/...`\n- [ ] Integration tests pass: `make test-integration` (at least build-related tests)\n\n## Testing\n\n```bash\n# Unit tests\ngo test ./pkg/model/...\ngo test ./pkg/cli/...\n\n# Manual verification\ngo run ./cmd/cog build -t test-image ./test-integration/test_integration/fixtures/hello-world-project\n```\n\n## Context Files\n\n- `pkg/cli/build.go` - Current build command implementation\n- `pkg/image/build.go` - Current `image.Build()` call to replace","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:56:32.682948-07:00","updated_at":"2026-02-02T13:57:46.296495-07:00","dependencies":[{"issue_id":"cog-u5c.5","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:56:32.683401-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.5","depends_on_id":"cog-u5c.1","type":"blocks","created_at":"2026-01-08T16:16:47.765615-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.5","depends_on_id":"cog-u5c.2","type":"blocks","created_at":"2026-01-08T16:16:47.854543-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.5","depends_on_id":"cog-u5c.3","type":"blocks","created_at":"2026-01-08T16:16:47.95045-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.5","depends_on_id":"cog-u5c.4","type":"blocks","created_at":"2026-01-08T16:16:48.04464-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.6","title":"Phase 2.1: Migrate pkg/cli/push.go to use ModelFactory","description":"## Summary\n\nMigrate `pkg/cli/push.go` to use `ModelFactory` instead of calling `image.Build()` directly.\n\n## File to Modify\n\n`pkg/cli/push.go`\n\n## Current State\n\nThe push command calls `image.Build()` with nearly identical parameters to the build command:\n\n```go\nimage.Build(ctx, cfg, projectDir, imageName, buildSecrets, buildNoCache,\n    buildSeparateWeights, buildUseCudaBaseImage, buildProgressOutput,\n    buildSchemaFile, buildDockerfileFile, DetermineUseCogBaseImage(cmd),\n    buildStrip, buildPrecompile, buildFast, nil, buildLocalImage,\n    dockerClient, registryClient, pipelinesImage)\n```\n\n## Implementation\n\n1. Create `ModelFactory` instance\n2. Populate `CreatePlanOptions` from push-specific flags\n3. Call `factory.Build()`\n4. Continue with push logic using the returned `Model`\n\n## Acceptance Criteria\n\n- [ ] `pkg/cli/push.go` uses `ModelFactory.Build()`\n- [ ] Push-specific behavior preserved (e.g., remote image handling)\n- [ ] All push CLI flags work correctly\n- [ ] Tests pass: `go test ./pkg/cli/...`\n- [ ] Manual test: `cog push` works with a test registry\n\n## Context Files\n\n- `pkg/cli/push.go` - Current push implementation\n- `pkg/cli/build.go` - Reference for ModelFactory usage (from Phase 1.5)","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:56:41.794896-07:00","updated_at":"2026-02-02T13:57:46.360969-07:00","dependencies":[{"issue_id":"cog-u5c.6","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:56:41.795318-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.6","depends_on_id":"cog-u5c.5","type":"blocks","created_at":"2026-01-08T16:16:52.163108-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.7","title":"Phase 2.2: Migrate pkg/cli/predict.go to use ModelFactory","description":"## Summary\n\nMigrate `pkg/cli/predict.go` to use `ModelFactory` instead of calling `image.Build()` directly.\n\n## File to Modify\n\n`pkg/cli/predict.go`\n\n## Current State\n\nThe predict command builds with minimal options (for quick local testing):\n\n```go\nimage.Build(ctx, cfg, projectDir, imageName, []string{}, false, false,\n    buildUseCudaBaseImage, buildProgressOutput, \"\", \"\",\n    DetermineUseCogBaseImage(cmd), false, false, false, nil, true,\n    dockerClient, registryClient, false)\n```\n\nNote the hardcoded values: no secrets, no cache=false, no separate weights, etc.\n\n## Implementation\n\n1. Create `ModelFactory` instance\n2. Populate `CreatePlanOptions` with predict-specific defaults:\n   - `LocalImage: true` (always local for predict)\n   - `Secrets: []string{}` (no secrets needed)\n   - Other flags as appropriate\n3. Call `factory.Build()`\n\n## Acceptance Criteria\n\n- [ ] `pkg/cli/predict.go` uses `ModelFactory.Build()`\n- [ ] Predict-specific defaults preserved\n- [ ] `cog predict` works correctly\n- [ ] Tests pass\n\n## Context Files\n\n- `pkg/cli/predict.go` - Current predict implementation","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:56:50.459694-07:00","updated_at":"2026-02-02T13:57:46.432278-07:00","dependencies":[{"issue_id":"cog-u5c.7","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:56:50.460121-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.7","depends_on_id":"cog-u5c.5","type":"blocks","created_at":"2026-01-08T16:16:52.25981-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.8","title":"Phase 2.3: Migrate pkg/cli/run.go to use ModelFactory","description":"## Summary\n\nMigrate `pkg/cli/run.go` to use `ModelFactory` instead of calling `image.Build()` directly.\n\n## File to Modify\n\n`pkg/cli/run.go`\n\n## Current State\n\nThe run command builds with minimal options similar to predict:\n\n```go\nimage.Build(ctx, cfg, projectDir, tag, []string{}, false, false,\n    buildUseCudaBaseImage, buildProgressOutput, \"\", \"\",\n    DetermineUseCogBaseImage(cmd), false, false, false, nil, true,\n    dockerClient, registryClient, false)\n```\n\n## Implementation\n\n1. Create `ModelFactory` instance\n2. Populate `CreatePlanOptions` with run-specific defaults\n3. Call `factory.Build()`\n4. Continue with container run logic\n\n## Acceptance Criteria\n\n- [ ] `pkg/cli/run.go` uses `ModelFactory.Build()`\n- [ ] Run-specific behavior preserved\n- [ ] `cog run` works correctly\n- [ ] Tests pass\n\n## Context Files\n\n- `pkg/cli/run.go` - Current run implementation","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:56:55.942979-07:00","updated_at":"2026-02-02T13:57:46.515456-07:00","dependencies":[{"issue_id":"cog-u5c.8","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:56:55.94343-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.8","depends_on_id":"cog-u5c.5","type":"blocks","created_at":"2026-01-08T16:16:52.36053-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-u5c.9","title":"Phase 2.4: Deprecate/simplify old image.Build signature","description":"## Summary\n\nAfter all call sites are migrated to `ModelFactory`, simplify or deprecate the old `image.Build()` 19-parameter function.\n\n## File to Modify\n\n`pkg/image/build.go`\n\n## Options\n\n1. **Delete entirely** - If `ModelFactory.BuildFromPlan()` handles all cases\n2. **Simplify to wrapper** - Make `image.Build()` create a `ModelFactory` and call through\n3. **Mark deprecated** - Add deprecation comment but keep for backward compatibility\n\n## Recommended Approach\n\nCreate a thin wrapper that converts to the new API:\n\n```go\n// Build is deprecated. Use model.ModelFactory.Build() instead.\n// Deprecated: This function has too many parameters. Use ModelFactory instead.\nfunc Build(ctx context.Context, cfg *config.Config, dir, imageName string, /* ... 15 more params */) error {\n    factory := model.NewModelFactory(dockerCommand, client)\n    opts := model.CreatePlanOptions{\n        ProjectDir: dir,\n        ImageName:  imageName,\n        // ... map all params\n    }\n    _, err := factory.Build(ctx, cfg, opts)\n    return err\n}\n```\n\n## Acceptance Criteria\n\n- [ ] All direct callers migrated (Phase 2.1-2.3 complete)\n- [ ] Old function either removed or deprecated with wrapper\n- [ ] No code duplication in build logic\n- [ ] All tests pass\n\n## Context Files\n\n- `pkg/image/build.go` - Current 19-param function\n- `pkg/model/factory.go` - New factory implementation","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-08T15:57:06.398727-07:00","updated_at":"2026-02-02T13:57:46.593828-07:00","dependencies":[{"issue_id":"cog-u5c.9","depends_on_id":"cog-u5c","type":"parent-child","created_at":"2026-01-08T15:57:06.399145-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.9","depends_on_id":"cog-u5c.6","type":"blocks","created_at":"2026-01-08T16:16:52.462081-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.9","depends_on_id":"cog-u5c.7","type":"blocks","created_at":"2026-01-08T16:16:52.554742-07:00","created_by":"mdwan","metadata":"{}"},{"issue_id":"cog-u5c.9","depends_on_id":"cog-u5c.8","type":"blocks","created_at":"2026-01-08T16:16:52.652005-07:00","created_by":"mdwan","metadata":"{}"}]}
{"id":"cog-vaq","title":"Update docker_client_test.go to remove old client tests","description":"In pkg/docker/docker_client_test.go: Remove TestDockerClient() function (lines 22-31) that tests the old client, and remove the auth test skip condition for DockerCommand (lines 361-362).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:32.749782-07:00","updated_at":"2025-12-11T16:25:01.19603-07:00","closed_at":"2025-12-11T16:25:01.19603-07:00","dependencies":[{"issue_id":"cog-vaq","depends_on_id":"cog-5d6","type":"parent-child","created_at":"2025-12-11T16:02:32.750334-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-vbg","title":"Phase 4: Cleanup and documentation","description":"Polish, document, and clean up after integration.\n\n- Update documentation to cover coglet\n- Update AGENTS.md, CONTRIBUTING.md\n- Consider consolidating duplicate test fixtures\n- Update docs/llms.txt\n\nThis is the parent task for Phase 4 subtasks.\n\nDepends on: Phase 3 completion (cog-tdd)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T15:15:00.16634-07:00","updated_at":"2026-02-02T13:57:39.405251-07:00","closed_at":"2026-02-02T13:57:39.405251-07:00","close_reason":"Coglet integration complete","dependencies":[{"issue_id":"cog-vbg","depends_on_id":"cog-l09","type":"blocks","created_at":"2025-12-15T15:15:00.166784-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-vl6","title":"Remove cog_runtime from fixture cog.yaml files once COG_WHEEL matrix is stable","description":"Once the COG_WHEEL CI matrix is stable and we're confident in coglet backwards compatibility, remove the cog_runtime field from test fixture cog.yaml files. The runtime should be controlled entirely by the CI matrix via COG_WHEEL env var, not hardcoded in fixtures.\n\nFiles to update:\n- test-integration/test_integration/fixtures/cog-runtime-float/cog.yaml\n- test-integration/test_integration/fixtures/cog-runtime-int/cog.yaml  \n- test-integration/test_integration/fixtures/string-project/cog.yaml\n\nEventually the cog_runtime config option itself may be deprecated.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-18T13:48:19.177073-07:00","updated_at":"2026-02-02T13:57:52.685571-07:00","closed_at":"2026-02-02T13:57:52.685571-07:00","close_reason":"Closed with parent testing/coglet epics","dependencies":[{"issue_id":"cog-vl6","depends_on_id":"cog-1rk","type":"parent-child","created_at":"2025-12-18T13:48:19.177584-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-vli","title":"Phase 2: Wire up runtime selection to use integrated coglet","description":"Make the cog CLI properly build and use the integrated coglet code when cog_runtime: true is set.\n\nCurrently, cog downloads a pinned coglet wheel from GitHub releases. After integration, it should use the locally built coglet wheel.\n\nThis is the parent task for Phase 2 subtasks.\n\nDepends on: Phase 1 completion (cog-4gd)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:13:39.862256-07:00","updated_at":"2026-02-02T13:57:39.4007-07:00","closed_at":"2026-02-02T13:57:39.4007-07:00","close_reason":"Coglet integration complete","dependencies":[{"issue_id":"cog-vli","depends_on_id":"cog-l09","type":"blocks","created_at":"2025-12-15T15:13:39.86276-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-wgp","title":"Fix coglet runtime boot failures in CI matrix tests","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-18T14:49:54.792783-07:00","updated_at":"2026-01-27T13:47:51.643102-07:00","closed_at":"2026-01-27T13:47:51.643102-07:00","close_reason":"No longer needed","dependencies":[{"issue_id":"cog-wgp","depends_on_id":"cog-1rk","type":"discovered-from","created_at":"2025-12-18T14:49:54.793578-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-wog","title":"Remove COG_DOCKER_SDK_CLIENT from tox.ini","description":"In tox.ini: Remove COG_DOCKER_SDK_CLIENT from pass_env section (line 77) in the integration test environment.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T16:02:43.247029-07:00","updated_at":"2025-12-11T16:26:25.895738-07:00","closed_at":"2025-12-11T16:26:25.895738-07:00","dependencies":[{"issue_id":"cog-wog","depends_on_id":"cog-5d6","type":"parent-child","created_at":"2025-12-11T16:02:43.247454-07:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cog-xt1","title":"Fix CodeQL security issues on backport-cog-runtime PR","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-16T13:30:07.79893-07:00","updated_at":"2025-12-16T14:00:07.809187-07:00","closed_at":"2025-12-16T14:00:07.809187-07:00"}
{"id":"cog-yr3","title":"Add integration test for CA cert injection","description":"## Task\n\nCreate `integration-tests/tests/ca_cert.txtar` to test end-to-end CA cert injection.\n\n## Test Strategy\n\nSince we can't easily test actual TLS interception, we test that:\n1. The cert is installed in the right location\n2. The environment variables are set correctly\n3. The system cert store is updated\n\n## Test File: ca_cert.txtar\n\n```txtar\n# Test CA certificate injection via COG_CA_CERT\n\n# Set the CA cert env var to inline PEM\nenv COG_CA_CERT=-----BEGIN CERTIFICATE-----\nMIIDxTCCAq2gAwIBAgIQAqxcJmoLQJuPC3nyrkYldzANBgkqhkiG9w0BAQsFADBs\nMQswCQYDVQQGEwJVUzETMBEGA1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwNU2Fu\n-----END CERTIFICATE-----\n\n# Build should succeed and inject the cert\ncog build -t $TEST_IMAGE\n\n# Verify cert file exists in container\nexec docker run --rm $TEST_IMAGE test -f /usr/local/share/ca-certificates/cog-ca-cert.crt\nstdout ''\n\n# Verify environment variables are set\nexec docker run --rm $TEST_IMAGE printenv SSL_CERT_FILE\nstdout '/etc/ssl/certs/ca-certificates.crt'\n\nexec docker run --rm $TEST_IMAGE printenv REQUESTS_CA_BUNDLE\nstdout '/etc/ssl/certs/ca-certificates.crt'\n\nexec docker run --rm $TEST_IMAGE printenv CURL_CA_BUNDLE  \nstdout '/etc/ssl/certs/ca-certificates.crt'\n\nexec docker run --rm $TEST_IMAGE printenv NODE_EXTRA_CA_CERTS\nstdout '/etc/ssl/certs/ca-certificates.crt'\n\n# Verify cert is in the system store\nexec docker run --rm $TEST_IMAGE cat /etc/ssl/certs/ca-certificates.crt\nstdout 'MIIDxTCCAq2gAwIBAgIQAqxcJmoLQJuPC3nyrkYldzANBgkqhkiG9w0BAQsFADBs'\n\n-- cog.yaml --\nbuild:\n  python_version: \"3.12\"\npredict: \"predict.py:Predictor\"\n\n-- predict.py --\nfrom cog import BasePredictor\n\nclass Predictor(BasePredictor):\n    def predict(self, text: str) -\u003e str:\n        return text\n```\n\n## Additional Test: No cert when env not set\n\n```txtar\n# Test that no cert is injected when COG_CA_CERT is not set\n\n# Build without COG_CA_CERT\ncog build -t $TEST_IMAGE\n\n# Verify our cert file does NOT exist\n! exec docker run --rm $TEST_IMAGE test -f /usr/local/share/ca-certificates/cog-ca-cert.crt\n\n-- cog.yaml --\nbuild:\n  python_version: \"3.12\"\npredict: \"predict.py:Predictor\"\n\n-- predict.py --\nfrom cog import BasePredictor\n\nclass Predictor(BasePredictor):\n    def predict(self, text: str) -\u003e str:\n        return text\n```\n\n## File to Create\n\n`integration-tests/tests/ca_cert.txtar`\n\n## Running the Test\n\n```bash\ncd integration-tests \u0026\u0026 go test -v -run TestIntegration/ca_cert -timeout 10m\n```\n\n## Notes\n\n- The test uses inline PEM format (simplest for txtar)\n- Uses `exec docker run` to run commands in the built container\n- Uses `!` prefix for commands expected to fail\n- The harness auto-cleans up TEST_IMAGE after the test","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T11:15:18.428043-07:00","updated_at":"2026-01-14T13:20:27.656803-07:00","closed_at":"2026-01-14T13:20:27.656803-07:00","close_reason":"Implemented CA cert injection via COG_CA_CERT","dependencies":[{"issue_id":"cog-yr3","depends_on_id":"cog-yuu","type":"discovered-from","created_at":"2026-01-14T11:15:38.314257-07:00","created_by":"Matt Dwan","metadata":"{}"},{"issue_id":"cog-yr3","depends_on_id":"cog-m4x","type":"blocks","created_at":"2026-01-14T11:15:43.649957-07:00","created_by":"Matt Dwan","metadata":"{}"}]}
{"id":"cog-yuu","title":"COG_CA_CERT: Inject CA certificates into built images","description":"## Problem\n\nUsers working behind corporate proxies or VPNs that perform TLS interception need custom CA certificates for HTTPS to work. Docker containers built by Cog do not have these certs, causing TLS failures during build (pip/apt) and at runtime.\n\n## Solution\n\nAdd COG_CA_CERT environment variable support to inject custom CA certificates into Cog-built images. When set, the certificate is copied into the image and added to the system certificate store.\n\n## User Experience\n\n```bash\n# Developer sets once in mise/direnv (not committed)\nexport COG_CA_CERT=/path/to/corporate-ca.crt\n\n# Then normal cog commands just work\ncog build        # Cert injected into image\ncog run          # Container has cert\ncog predict      # Container has cert\n\n# CI builds without the env var work unchanged\ncog build        # No cert, no extra layers\n```\n\n## Input Formats Supported\n\n- File path: `/path/to/cert.crt`\n- Directory: `/path/to/certs/` (all .crt/.pem files concatenated)\n- Inline PEM: `-----BEGIN CERTIFICATE-----...`\n- Base64-encoded PEM: `LS0tLS1CRUdJTi...`\n\n## Implementation Notes\n\n- Inject early in Dockerfile (before tini, apt, pip)\n- Set SSL_CERT_FILE and REQUESTS_CA_BUNDLE env vars\n- Zero overhead when env var not set","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-14T11:14:09.469881-07:00","updated_at":"2026-01-14T16:17:51.058135-07:00","closed_at":"2026-01-14T16:17:51.058135-07:00","close_reason":"COG_CA_CERT feature implemented and PR created: https://github.com/replicate/cog/pull/2627"}
{"id":"cog-yyy","title":"Update goreleaser config to build coglet-server","description":"Update .goreleaser.yaml to include coglet-server binary build.\n\nThe coglet-server binary needs to be:\n1. Built for linux/amd64 and linux/arm64 (container targets)\n2. Either embedded in coglet wheel OR copied into Docker images\n\nReview cog-runtime/script/build.sh for the current approach (embeds Go binaries in wheel).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T15:13:52.99487-07:00","updated_at":"2026-02-02T13:57:39.40858-07:00","closed_at":"2026-02-02T13:57:39.40858-07:00","close_reason":"Coglet integration complete","dependencies":[{"issue_id":"cog-yyy","depends_on_id":"cog-vli","type":"blocks","created_at":"2025-12-15T15:13:52.99536-07:00","created_by":"daemon","metadata":"{}"}]}
