---
name: Release Publish

# Publishes packages to PyPI and crates.io when a release is published.
#
# For stable/pre-release: triggered when a maintainer publishes the draft release.
# For dev releases: this workflow runs but ALL jobs are skipped (dev releases
# do not publish to PyPI or crates.io).
#
# PUBLISH ORDER:
# 1. coglet -> PyPI (must be first, SDK depends on it)
# 2. coglet -> crates.io (parallel with coglet PyPI)
# 3. SDK -> PyPI (after coglet is on PyPI)
#
# REQUIRED GITHUB CONFIGURATION:
# 1. Create environments in Settings -> Environments:
#    - "pypi": For PyPI publishing (Trusted Publisher)
#    - "crates-io": For crates.io publishing
#
# 2. Configure environment protection rules:
#    - Deployment branches: "Selected branches and tags"
#    - Add pattern: v* (to restrict to version tags only)
#
# 3. crates-io uses Trusted Publishing (OIDC via rust-lang/crates-io-auth-action)

on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write
  attestations: write

env:
  CARGO_TERM_COLOR: always

jobs:
  verify-release:
    name: Verify release tag
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      is_dev: ${{ steps.check.outputs.is_dev }}
    steps:
      - name: Verify valid release tag
        id: check
        run: |
          TAG="${{ github.event.release.tag_name }}"

          # Release must be from a valid version tag
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "::error::Invalid tag format: $TAG"
            echo "::error::Tags must match pattern v*.*.* (e.g., v1.0.0)"
            exit 1
          fi
          echo "âœ“ Valid release tag: $TAG"

          # Check if this is a dev release
          VERSION="${TAG#v}"
          IS_DEV="false"
          if [[ "$VERSION" == *-dev* ]]; then
            IS_DEV="true"
            echo "Dev release detected - skipping PyPI/crates.io publishing"
          fi
          echo "is_dev=$IS_DEV" >> "$GITHUB_OUTPUT"

  publish-pypi-coglet:
    name: Publish coglet to PyPI
    needs: verify-release
    if: needs.verify-release.outputs.is_dev != 'true'
    runs-on: ubuntu-latest
    environment: pypi
    timeout-minutes: 10
    steps:
      - name: Download coglet wheels from release
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "coglet-*.whl"
          out-file-path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  publish-crates-io:
    name: Publish coglet to crates.io
    needs: verify-release
    if: needs.verify-release.outputs.is_dev != 'true'
    runs-on: ubuntu-latest
    environment: crates-io
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.release.tag_name }}

      - uses: dtolnay/rust-toolchain@stable

      - uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Publish to crates.io
        run: cargo publish -p coglet --manifest-path crates/Cargo.toml
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

  publish-pypi-sdk:
    name: Publish SDK to PyPI
    needs: publish-pypi-coglet
    runs-on: ubuntu-latest
    environment: pypi
    timeout-minutes: 10
    steps:
      - name: Download SDK wheel from release
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "cog-*.whl"
          out-file-path: dist

      - name: Download SDK sdist from release
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "cog-*.tar.gz"
          out-file-path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
