---
name: PyPI package

# Publishes the cog SDK to PyPI after coglet is published.
# Triggered by release-publish.yaml completing successfully.
#
# TODO: Merge this back into release-publish.yaml once the PyPI
# Trusted Publisher config is updated to use that filename.

on:
  workflow_run:
    workflows: ["Release Publish"]
    types: [completed]

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  publish-pypi-sdk:
    name: Publish SDK to PyPI
    runs-on: ubuntu-latest
    environment: pypi
    timeout-minutes: 10
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get release tag
        id: tag
        run: |
          # Get the tag from the triggering workflow run
          # workflow_run.head_branch contains the tag for tag-triggered workflows
          TAG="${{ github.event.workflow_run.head_branch }}"
          
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "::error::Not a release tag: $TAG"
            exit 1
          fi
          
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Release tag: $TAG"

      - name: Download SDK wheel from release
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ steps.tag.outputs.tag }}
          fileName: "cog-*.whl"
          out-file-path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
