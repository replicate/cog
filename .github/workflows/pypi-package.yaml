---
name: PyPI package

# Publishes the cog SDK to PyPI when a release is published.
# Waits for coglet to be available on PyPI first (SDK depends on it).
#
# This is a separate workflow from release-publish.yaml because PyPI
# Trusted Publisher is bound to the workflow filename.
# TODO: Merge back once trusted publisher config is updated.

on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  publish-pypi-sdk:
    name: Publish SDK to PyPI
    runs-on: ubuntu-latest
    environment: pypi
    timeout-minutes: 15
    steps:
      - name: Compute PEP 440 version
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          PEP440=$(echo "$VERSION" | sed -E 's/-alpha/a/; s/-beta/b/; s/-rc/rc/')
          echo "pep440=$PEP440" >> "$GITHUB_OUTPUT"
          echo "Version: $PEP440"

      - name: Wait for coglet on PyPI
        run: |
          VERSION="${{ steps.version.outputs.pep440 }}"
          echo "Waiting for coglet==$VERSION on PyPI..."
          for i in $(seq 1 30); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/coglet/$VERSION/json")
            if [ "$STATUS" = "200" ]; then
              echo "coglet==$VERSION is available on PyPI"
              exit 0
            fi
            echo "Attempt $i/30: coglet not yet available (HTTP $STATUS), waiting 30s..."
            sleep 30
          done
          echo "::error::Timed out waiting for coglet==$VERSION on PyPI after 15 minutes"
          exit 1

      - name: Download SDK wheel from release
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "cog-*.whl"
          out-file-path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
