# Test cancellation of a running sync prediction.
#
# Submits an async prediction (PUT with Prefer: respond-async) that busy-loops
# for 60s, waits for it to start processing, cancels via the /cancel endpoint,
# and verifies the webhook receives "canceled" status.

[short] skip 'requires Docker build'

cog build -t $TEST_IMAGE

webhook-server-start
cog serve --upload-url http://unused/

# Submit async prediction that would run for 60s
curl -H Prefer:respond-async PUT /predictions/cancel-sync-test '{"id":"cancel-sync-test","input":{"duration":60},"webhook":"$WEBHOOK_URL","webhook_events_filter":["completed"]}'

# Give the prediction time to start processing
exec sleep 2

# Cancel it
curl POST /predictions/cancel-sync-test/cancel '{}'

# Wait for webhook callback
webhook-server-wait 30s

# Prediction should be canceled
stdout '"status":"canceled"'

-- cog.yaml --
build:
  python_version: "3.12"
run: "run.py:Runner"

-- run.py --
import time
from cog import BaseRunner


class Runner(BaseRunner):
    def setup(self):
        pass

    def run(self, duration: float = 60.0) -> str:
        # Busy-loop (hits bytecode boundaries, cancellable via PyThreadState_SetAsyncExc)
        deadline = time.monotonic() + duration
        while time.monotonic() < deadline:
            pass
        return "completed"
