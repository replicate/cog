# Test that building with a legacy SDK (< 0.17.0) falls back to runtime
# schema generation instead of using cog-schema-gen.
#
# SDK 0.16.12 uses pydantic-based runtime introspection for schema generation
# and predates coglet. Coglet is not installed because:
#   1. No explicit COGLET_WHEEL is set
#   2. The SDK dependency handles it â€” and 0.16.12 doesn't depend on coglet

# Override SDK wheel to use PyPI 0.16.12 (legacy, pre-coglet)
env COG_SDK_WHEEL=pypi:0.16.12

# Build should succeed using legacy runtime schema generation
cog build -t $TEST_IMAGE
stderr 'using legacy runtime schema generation'
stderr 'Validating model schema'

# Predict should work with the legacy SDK's built-in Python HTTP server
cog predict $TEST_IMAGE -i s=world
stdout 'hello world'

-- cog.yaml --
build:
  python_version: "3.12"
predict: "predict.py:Predictor"

-- predict.py --
from cog import BasePredictor

class Predictor(BasePredictor):
    def predict(self, s: str) -> str:
        return "hello " + s
