# Test healthcheck that raises an exception
# This tests error handling when healthcheck throws

# Build the image
cog build -t $TEST_IMAGE

# Start the server
cog serve

# Exception in healthcheck should return UNHEALTHY with error message
curl GET /health-check
stdout '"status":"UNHEALTHY"'
stdout 'user_healthcheck_error'
stdout 'Critical system error'

-- cog.yaml --
build:
  python_version: "3.12"
run: "run.py:Runner"

-- run.py --
from cog import BaseRunner

class Runner(BaseRunner):
    def setup(self) -> None:
        self._healthcheck_calls = 0

    def run(self, text: str) -> str:
        return f"hello {text}"
    
    def healthcheck(self) -> bool:
        """Healthcheck that raises an exception after startup."""
        self._healthcheck_calls += 1
        if self._healthcheck_calls == 1:
            return True
        raise RuntimeError("Critical system error")
