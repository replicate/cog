# Skip for coglet_alpha which does not support this
[coglet_alpha] skip
# Skip for coglet_rust which does not support this
[coglet_rust] skip
# Skip for cog-dataclass which does not support this
[cog_dataclass] skip

# Test async healthcheck function
# Ensures async healthchecks work correctly

# Build the image
cog build -t $TEST_IMAGE

# Start the server
cog serve

# Test async healthcheck returns healthy
curl GET /health-check
stdout '"status":"READY"'
! stdout 'user_healthcheck_error'

# Make a prediction
curl POST /predictions '{"input":{"text":"world"}}'
stdout '"output":"hello world"'

# Healthcheck should still work
curl GET /health-check
stdout '"status":"READY"'

-- cog.yaml --
build:
  python_version: "3.12"
predict: "predict.py:Predictor"

-- predict.py --
import asyncio
from cog import BasePredictor

class Predictor(BasePredictor):
    def predict(self, text: str) -> str:
        return f"hello {text}"

    async def healthcheck(self) -> bool:
        """Async healthcheck function."""
        # Simulate async operation
        await asyncio.sleep(0.1)
        return True
