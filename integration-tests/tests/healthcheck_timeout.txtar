# Test healthcheck timeout behavior
# This tests when sync healthcheck takes too long (>5 seconds)

# Build the image
cog build -t $TEST_IMAGE

# Start the server
cog serve

# Server should be healthy initially
curl GET /health-check
stdout '"status":"READY"'

# Trigger slow healthcheck mode via prediction
curl POST /predictions '{"input":{"text":"trigger_slow"}}'
stdout '"status":"succeeded"'

# Now healthcheck should timeout and return UNHEALTHY (503)
! curl GET /health-check
stdout '"status":"UNHEALTHY"'
stdout 'user_healthcheck_error'
stdout 'timed out after 5.0 seconds'

-- cog.yaml --
build:
  python_version: "3.12"
predict: "predict.py:Predictor"

-- predict.py --
import time
from cog import BasePredictor

class Predictor(BasePredictor):
    def setup(self) -> None:
        self._slow_mode = False

    def predict(self, text: str) -> str:
        if text == "trigger_slow":
            self._slow_mode = True
        return f"hello {text}"
    
    def healthcheck(self) -> bool:
        """Sync healthcheck that times out when triggered."""
        if self._slow_mode:
            time.sleep(10)  # Sleep longer than 5s timeout
        return True
