[short] skip 'slow test - skip in short mode'

# Test worker tracing logs appear in setuplog
# This ensures Rust tracing from the worker subprocess is properly captured during setup

# Build the image
cog build -t $TEST_IMAGE

# Start the server
cog serve

# Check setuplog contains worker tracing logs
curl GET /health-check
stdout '"status":"READY"'
stdout 'Worker subprocess starting'
stdout 'File descriptor redirection complete'
stdout 'Connected to slot transport'

# Make a prediction to verify it works
curl POST /predictions '{"input":{"s":"test"}}'
stdout '"output":"hello test"'

-- cog.yaml --
build:
  python_version: "3.12"
  python_packages:
  - requests
predict: "predict.py:Predictor"

-- predict.py --
import signal
import subprocess
import sys

import requests

from cog import BasePredictor


class Predictor(BasePredictor):
    """
    This predictor spawns a double-forked HTTP server during setup to test
    that worker tracing logs are properly captured in setuplog.
    """

    def setup(self) -> None:
        print("---> starting background process")

        self.bg = subprocess.Popen(["bash", "run-pong.sh"])

        print(f"---> started background process pid={self.bg.pid}")

        # Wait for HTTP server to be ready
        import time
        for i in range(30):
            try:
                requests.get("http://127.0.0.1:7777/ping", timeout=1)
                print("---> background HTTP server is ready")
                break
            except Exception:
                print(f"---> waiting for HTTP server ({i+1}/30)")
                time.sleep(0.5)
        else:
            raise RuntimeError("Background HTTP server failed to start")

    def predict(self, s: str) -> str:
        status = self.bg.poll()

        if status is None:
            requests.get("http://127.0.0.1:7777/ping")
        else:
            raise SystemExit

        return "hello " + s

-- run-pong.sh --
#!/usr/bin/env bash
python ./pong.py &
wait

-- pong.py --
import os
import signal
import time
from random import randint
from wsgiref.simple_server import make_server


def main():
    child_pid = os.fork()
    is_child = child_pid == 0

    pid = os.getpid()

    if is_child:
        make_server("127.0.0.1", 7777, app).serve_forever()
    else:
        while True:
            time.sleep(10)


def app(environ, start_response):
    if environ["PATH_INFO"] == "/ping":
        start_response("200 OK", [("content-type", "text/plain")])
        return [b"PONG\n" for n in range(100 + randint(2, 32))]

    start_response("404 Not Found", [("content-type", "text/plain")])
    return [b"NO\n"]


if __name__ == "__main__":
    main()
