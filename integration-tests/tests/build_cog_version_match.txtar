# Test that cog version in base image contains a version number
# Source: test_build.py::test_cog_install_base_image
#
# This test verifies that when building with --use-cog-base-image,
# the installed Python cog package has a valid version number.

# Build using cog base image
cog build -t $TEST_IMAGE --use-cog-base-image=true

# Compare the embedded version label with the Python package version inside the image
exec python3 -c 'import os,re,subprocess; image=os.environ["TEST_IMAGE"]; label=subprocess.check_output(["docker","inspect",image,"--format={{index .Config.Labels \"run.cog.version\"}}"], text=True).strip(); package=subprocess.check_output(["docker","run","--rm","-t",image,"python","-c","import cog; print(cog.__version__)"] , text=True).strip(); pattern=re.compile(r"^\d+\.\d+\.\d+"); assert pattern.search(package), f"Invalid package version: {package}"; assert label == "dev" or pattern.search(label), f"Invalid label version: {label}"; assert label == "dev" or label == package, f"Label version {label} != package version {package}"; print(package)'
stdout '[0-9]+\.[0-9]+\.[0-9]+'

-- cog.yaml --
build:
  python_version: "3.12"
predict: "predict.py:Predictor"

-- predict.py --
from cog import BasePredictor


class Predictor(BasePredictor):
    def predict(self, s: str) -> str:
        return "hello " + s
